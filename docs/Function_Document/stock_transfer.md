# 庫存轉移系統

## 概述

庫存轉移系統係用嚟管理棧板喺唔同倉儲位置之間移動嘅核心功能。系統為倉庫員工提供快速、準確嘅棧板轉移操作，支援通過搜尋棧板號或系列號嚟轉移棧板，並使用預定義嘅轉移代碼確定目標位置。

## 系統架構

### 主要頁面
- `/stock-transfer`: 庫存轉移主頁面

### 核心組件結構

#### 主頁面組件
- `app/stock-transfer/page.tsx`: 庫存轉移頁面提供搜尋同轉移功能
- `app/stock-transfer/StockTransferClient.tsx`: 客戶端組件處理所有轉移邏輯

#### UI組件
- 搜尋框：支援棧板號同系列號搜尋
- 轉移代碼輸入：數字代碼決定目標位置
- 活動日誌：顯示最近轉移記錄
- 狀態消息：即時操作回饋

#### 業務邏輯 ⚡ 已實現性能優化
- 棧板資訊緩存：5分鐘TTL，最多50項（實際已部署）
- 預加載常用棧板前綴：['PM-', 'PT-', 'PL-']（頁面載入時自動執行）
- 樂觀UI更新：即時狀態反饋同錯誤恢復
- 防抖搜尋優化：減少不必要嘅API請求
- 背景刷新：啟用自動緩存刷新機制

## 數據流向

### 資料庫表
- `record_palletinfo`: 棧板主數據
  - `plt_num`: 棧板號碼
  - `series`: 系列號
  - `product_code`: 產品代碼
  - `product_qty`: 產品數量

- `record_history`: 操作歷史記錄
  - `operator_id`: 操作員ID
  - `action`: 操作類型（Stock Transfer）
  - `plt_num`: 棧板號碼
  - `loc`: 新位置
  - `time`: 時間戳
  - `remark`: 轉移詳情

- `record_transfer`: 轉移記錄
  - `plt_num`: 棧板號碼
  - `operator_id`: 操作員ID
  - `date`: 轉移日期
  - `f_loc`: 來源位置
  - `t_loc`: 目標位置

- `record_inventory`: 庫存數量
  - `product_code`: 產品代碼
  - 各位置欄位（await、production、fold_mill等）
  - `latest_update`: 最後更新時間

### 位置系統
可用位置：
- **Await**: 默認暫存區
- **Await_grn**: 收貨暫存區
- **Production**: 生產車間
- **PipeLine**: 管道處理區
- **Fold Mill**: 摺疊加工區
- **Bulk Room**: 散裝儲存區
- **Back Car Park**: 外部儲存區
- **Pre-Book**: 預訂區
- **Voided**: 作廢（無法移動）

## 工作流程

### 1. 搜尋棧板
- 輸入棧板號（如：PM-12345）或系列號
- 系統查詢`record_palletinfo`獲取棧板資訊
- 從最新`record_history`獲取當前位置

### 2. 轉移代碼系統

#### 轉移代碼映射
```javascript
{
  'Await': {
    '131415': 'Fold Mill',
    '232425': 'PipeLine'
  },
  'Await_grn': {
    '131415': 'Production',
    '232425': 'PipeLine'
  },
  'Fold Mill': {
    '131415': 'Production',
    '232425': 'PipeLine'
  },
  'PipeLine': {
    '131415': 'Production',
    '232425': 'Fold Mill'
  }
}
```

### 3. 員工認證
- 輸入clock號碼（員工ID）
- 系統驗證`data_id`表
- 確保操作可追溯性

### 4. 執行轉移
當轉移執行時，系統更新三個表：

#### record_history
- 新增記錄追蹤移動
- 記錄操作員、時間、位置

#### record_transfer
- 記錄轉移詳情
- 來源同目標位置

#### record_inventory
- 扣減來源位置數量
- 增加目標位置數量
- 更新時間戳

### 5. 結果回饋
- 成功：顯示綠色確認消息
- 失敗：顯示紅色錯誤消息
- 更新活動日誌
- 清除輸入準備下次操作

## 技術實現

### 前端技術
- React配合TypeScript
- 深色主題優化倉庫環境
- 鍵盤快捷鍵支援
- 響應式設計

### 性能功能 🚀 已完整實現
- **智能緩存**: 5分鐘TTL緩存，最多50項，背景自動刷新
- **預加載策略**: 頁面載入時自動預加載 PM-、PT-、PL- 前綴棧板
- **樂觀更新**: UI即時更新，支援錯誤恢復同狀態追蹤
- **防抖優化**: 搜尋操作防抖，減少API請求
- **緩存統計**: 提供 getCacheStats() 監控緩存性能
- **併發支援**: 支援多個轉移操作同時進行

### 狀態管理
- React hooks管理組件狀態
- 活動日誌本地狀態
- 錯誤處理同重試機制

### UI設計特色
- 深色背景減少眼睛疲勞
- 大按鈕適合觸控操作
- 清晰嘅視覺狀態指示
- 活動日誌即時更新

## 安全考慮

### 訪問控制
- 需要認證用戶
- 每次轉移驗證操作員ID
- 操作審計追蹤

### 驗證規則
- 棧板必須存在
- 不能轉移已作廢棧板
- 轉移代碼必須有效
- 防止並發轉移衝突

### 錯誤處理
防止以下情況嘅轉移：
- 棧板已作廢
- 當前位置無效轉移代碼
- 無效操作員ID
- 棧板有待處理轉移
- 資料庫操作失敗

## 操作指南

### 基本操作步驟
1. 搜尋棧板號或掃描條碼
2. 確認棧板資訊同當前位置
3. 輸入轉移代碼（6位數字）
4. 輸入你嘅clock號碼
5. 系統自動完成轉移

### 轉移代碼記憶
- **131415**: 通常轉移到生產或摺疊區
- **232425**: 通常轉移到管道區
- 代碼根據當前位置有唔同目標

### 快捷操作
- Enter鍵快速提交
- Tab鍵切換輸入欄位
- Esc鍵清除當前輸入

## 監控同維護

### 活動監控
- 即時活動日誌顯示最近轉移
- 成功/失敗狀態明確標示
- 時間戳記錄每個操作

### 性能監控
- 緩存命中率
- API響應時間
- 資料庫查詢性能
- 用戶操作統計

### 維護任務
- 定期清理舊轉移記錄
- 優化資料庫索引
- 更新轉移代碼映射
- 檢查數據一致性

## 故障排除

### 常見問題

#### 找唔到棧板
- 確認棧板號正確
- 檢查大小寫
- 驗證棧板未被刪除
- 嘗試用系列號搜尋

#### 無效轉移代碼
- 檢查當前位置
- 確認代碼輸入正確
- 查看可用代碼列表
- 聯繫管理員更新映射

#### 轉移失敗
- 檢查網絡連接
- 確認操作員ID有效
- 查看錯誤消息詳情
- 檢查棧板狀態

### 數據修復
- 檢查record_history最新記錄
- 驗證inventory數量正確
- 必要時手動調整
- 記錄所有修正操作

## 最佳實踐

### 操作建議
1. 每次轉移前確認棧板資訊
2. 記住常用轉移代碼
3. 定期檢查活動日誌
4. 及時報告異常情況

### 數據準確性
1. 避免重複轉移
2. 確保位置更新正確
3. 監控庫存差異
4. 定期核對實物

### 團隊協作
1. 統一使用轉移代碼
2. 交接班檢查待處理轉移
3. 記錄特殊情況
4. 保持系統數據同步

## 未來改進

### 計劃功能
- 批量轉移支援
- 條碼掃描整合
- 自動轉移規則
- 移動應用支援

### 技術升級
- WebSocket即時更新
- 離線轉移隊列
- 智能轉移建議
- 高級報表功能

### 用戶體驗
- 語音輸入支援
- 多語言介面
- 個性化快捷鍵
- 增強視覺回饋