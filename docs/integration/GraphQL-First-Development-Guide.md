# GraphQL-First ÈñãÁôºÊåáÂçó

**Â†±ÂëäÊó•Êúü**: 2025-07-28  
**Â†±Âëä‰∫∫**: AI Âçî‰ΩúËÄÖ  
**Â†±ÂëäÈ°ûÂûã**: üèóÔ∏è Êû∂ÊßãÊåáÂçó  
**Â†±ÂëäÁ¥öÂà•**: üî¥ Á∑äÊÄ•

---

## üéØ ÊåáÂçóÊëòË¶Å

**Ê†∏ÂøÉÂéüÂâá**: Êñ∞ÂäüËÉΩÈñãÁôºÂøÖÈ†àÂÑ™ÂÖà‰ΩøÁî® GraphQL + Server Actions  
**‰∏ªË¶ÅÁõÆÊ®ô**: Âª∫Á´ãÁµ±‰∏Ä„ÄÅÈ´òÊïàÁöÑ API Êû∂Êßã  
**ÈóúÈçµÊî∂Áõä**: ÊèêÂçáÈñãÁôºÊïàÁéá„ÄÅÈôç‰ΩéÁ∂≠Ë≠∑ÊàêÊú¨„ÄÅÂ¢ûÂº∑È°ûÂûãÂÆâÂÖ®  
**ÈÅ©Áî®ÁØÑÂúç**: ÊâÄÊúâÊñ∞ÂäüËÉΩÈñãÁôºÂíåÁèæÊúâÂäüËÉΩÈáçÊßã  

## üìã ËÉåÊôØËàáÁõÆÊ®ô

### Êû∂ÊßãÊºîÈÄ≤ËÉåÊôØ
- **Ê≠∑Âè≤ÁãÄÊ≥Å**: Á≥ªÁµ±ÂêåÊôÇÂ≠òÂú® REST API„ÄÅGraphQL„ÄÅServer Actions ‰∏âÁ®ÆÊäÄË°ìÊ£ß
- **ÁóõÈªûÂïèÈ°å**: Á∂≠Ë≠∑ÊàêÊú¨È´ò„ÄÅÈñãÁôºÊïàÁéá‰Ωé„ÄÅÈ°ûÂûãÂÆâÂÖ®‰∏ç‰∏ÄËá¥
- **ÈÅ∑ÁßªÊàêÊûú**: Â∑≤ÊàêÂäüÁßªÈô§ 24 ÂÄã REST API endpoints
- **Áï∂ÂâçÁãÄÊÖã**: GraphQL + Server Actions ÁÇ∫‰∏ªÂ∞éÊû∂Êßã

### ÈñãÁôºÁõÆÊ®ô
- **Áµ±‰∏ÄÊäÄË°ìÊ£ß**: ÊâÄÊúâÊï∏ÊìöÊü•Ë©¢‰ΩøÁî® GraphQLÔºåÊñá‰ª∂Êìç‰Ωú‰ΩøÁî® Server Actions
- **ÊèêÂçáÊïàÁéá**: Ê∏õÂ∞ë API ÈñãÁôºÂ∑•‰ΩúÈáè 30%
- **Â¢ûÂº∑ÂÆâÂÖ®**: ÂÆåÊï¥È°ûÂûãÂÆâÂÖ®ÔºåÁ´ØÂà∞Á´ØÈ°ûÂûãÊ™¢Êü•
- **ÂÑ™ÂåñÊÄßËÉΩ**: Single Query Ê®°ÂºèÔºåÈÅøÂÖç N+1 Êü•Ë©¢ÂïèÈ°å

---

## üîç GraphQL-First ÈñãÁôºÊµÅÁ®ã

### Êñ∞ÂäüËÉΩÈñãÁôºÊ®ôÊ∫ñÊµÅÁ®ã

#### 1. ÈúÄÊ±ÇÂàÜÊûêÈöéÊÆµ
```typescript
// Á¢∫ÂÆöÂäüËÉΩÈ°ûÂûã
const featureType = {
  dataQuery: 'GraphQL',        // Êü•Ë©¢„ÄÅË®ÇÈñ±„ÄÅËÅöÂêà
  fileOperation: 'ServerAction', // ‰∏äÂÇ≥„ÄÅ‰∏ãËºâ„ÄÅËôïÁêÜ
  realtime: 'GraphQL',         // ÂØ¶ÊôÇÊõ¥Êñ∞„ÄÅÊé®ÈÄÅ
  background: 'ServerAction'   // ËÉåÊôØËôïÁêÜ„ÄÅÊéíÁ®ã
}
```

#### 2. GraphQL Schema Ë®≠Ë®à
```graphql
# Êì¥Â±ïÁèæÊúâ schema
extend type Query {
  # Êñ∞Êü•Ë©¢ÂÆöÁæ©
  newFeatureData(input: NewFeatureInput!): NewFeatureResult!
}

# Ëº∏ÂÖ•È°ûÂûãÂÆöÁæ©
input NewFeatureInput {
  filters: FilterInput
  pagination: PaginationInput
  sorting: SortInput
}

# ÁµêÊûúÈ°ûÂûãÂÆöÁæ©
type NewFeatureResult {
  items: [NewFeatureItem!]!
  total: Int!
  aggregates: AggregateData
}
```

#### 3. RPC ÂáΩÊï∏ÈñãÁôº
```sql
-- ÂâµÂª∫È´òÊïàÁöÑ Supabase RPC ÂáΩÊï∏
CREATE OR REPLACE FUNCTION rpc_get_new_feature_data(
  p_filters JSONB DEFAULT '{}',
  p_pagination JSONB DEFAULT '{"limit": 50, "offset": 0}',
  p_sorting JSONB DEFAULT '{"field": "created_at", "direction": "desc"}'
) RETURNS TABLE (
  items JSONB,
  total_count BIGINT,
  aggregates JSONB
) AS $$
BEGIN
  -- ÂñÆ‰∏ÄÊü•Ë©¢ËøîÂõûÊâÄÊúâÂøÖË¶ÅÊï∏Êìö
  RETURN QUERY
  WITH filtered_data AS (
    SELECT * FROM your_table
    WHERE (CASE WHEN p_filters->>'field' IS NOT NULL 
           THEN field = (p_filters->>'field')::type 
           ELSE TRUE END)
  )
  SELECT 
    jsonb_agg(to_jsonb(filtered_data.*)) as items,
    count(*)::BIGINT as total_count,
    jsonb_build_object(
      'averageValue', avg(value_field),
      'totalSum', sum(sum_field)
    ) as aggregates
  FROM filtered_data;
END;
$$ LANGUAGE plpgsql;
```

#### 4. Service Layer ÂØ¶Áèæ
```typescript
// lib/services/new-feature.service.ts
export class NewFeatureService {
  private cacheAdapter: CacheAdapter;
  private readonly CACHE_TTL = 300; // 5 minutes

  async getData(input: NewFeatureInput, requestId: string): Promise<NewFeatureResult> {
    // 1. Á∑©Â≠òÊ™¢Êü•
    const cacheKey = `newfeature:${JSON.stringify(input)}`;
    const cached = await this.cacheAdapter.get(cacheKey);
    if (cached) return cached;

    // 2. RPC Ë™øÁî®
    const { data, error } = await supabase.rpc('rpc_get_new_feature_data', {
      p_filters: input.filters,
      p_pagination: input.pagination,
      p_sorting: input.sorting
    });

    if (error) throw new Error(`RPC call failed: ${error.message}`);

    // 3. Êï∏ÊìöËΩâÊèõ
    const result = this.transformData(data);

    // 4. Á∑©Â≠òÁµêÊûú
    await this.cacheAdapter.set(cacheKey, result, this.CACHE_TTL);

    return result;
  }
}
```

#### 5. GraphQL Resolver Êï¥Âêà
```typescript
// lib/graphql/resolvers/new-feature.resolver.ts
export const newFeatureResolvers = {
  Query: {
    newFeatureData: async (_: any, args: { input: NewFeatureInput }, context: any) => {
      const startTime = Date.now();
      const requestId = Math.random().toString(36).substring(7);

      try {
        // Ê¨äÈôêÊ™¢Êü•
        if (!context.user) {
          throw new GraphQLError('Unauthorized', {
            extensions: { code: 'UNAUTHENTICATED' }
          });
        }

        // Service Ë™øÁî®
        const service = new NewFeatureService();
        const result = await service.getData(args.input, requestId);

        console.log(`[GraphQL-${requestId}] Completed in ${Date.now() - startTime}ms`);
        return result;

      } catch (error) {
        console.error(`[GraphQL-${requestId}] Error:`, error);
        throw error instanceof GraphQLError ? error : new GraphQLError(
          error instanceof Error ? error.message : 'Internal server error',
          { extensions: { code: 'INTERNAL_SERVER_ERROR', requestId } }
        );
      }
    }
  }
};
```

---

## üèóÔ∏è Server Actions ÊúÄ‰Ω≥ÂØ¶Ë∏ê

### Êñá‰ª∂Êìç‰ΩúÈñãÁôºÊ®ôÊ∫ñ

#### 1. Êñá‰ª∂‰∏äÂÇ≥ Action
```typescript
// app/actions/new-file-actions.ts
'use server';

import { z } from 'zod';
import { revalidatePath } from 'next/cache';

const uploadSchema = z.object({
  file: z.instanceof(File),
  category: z.enum(['document', 'image', 'report']),
  metadata: z.object({
    description: z.string().optional(),
    tags: z.array(z.string()).optional()
  }).optional()
});

export async function uploadNewFile(formData: FormData) {
  try {
    // 1. Ëº∏ÂÖ•È©óË≠â
    const validated = uploadSchema.parse({
      file: formData.get('file'),
      category: formData.get('category'),
      metadata: JSON.parse(formData.get('metadata') as string || '{}')
    });

    // 2. ÂÆâÂÖ®Ê™¢Êü•
    if (validated.file.size > 10 * 1024 * 1024) {
      throw new Error('File size must be less than 10MB');
    }

    // 3. Â≠òÂÑ≤Êìç‰Ωú
    const result = await uploadToStorage(validated.file, validated.category);

    // 4. Êï∏ÊìöÂ∫´Ë®òÈåÑ
    await recordUpload(result, validated.metadata);

    // 5. Á∑©Â≠òÂ§±Êïà
    revalidatePath('/admin');

    return { success: true, data: result };

  } catch (error) {
    console.error('[uploadNewFile] Error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Upload failed'
    };
  }
}
```

---

## üìä ÊÄßËÉΩÂÑ™ÂåñÊåáÂçó

### Single Query Ê®°ÂºèÂØ¶Áèæ

#### ÈÅøÂÖç N+1 Êü•Ë©¢ÂïèÈ°å
```typescript
// ‚ùå ÈåØË™§ÔºöN+1 Êü•Ë©¢Ê®°Âºè
const products = await getProducts();
for (const product of products) {
  product.details = await getProductDetails(product.id); // N+1 ÂïèÈ°å
}

// ‚úÖ Ê≠£Á¢∫ÔºöSingle Query Ê®°Âºè
const productsWithDetails = await supabase.rpc('rpc_get_products_with_details', {
  p_product_ids: productIds,
  p_include_details: true
});
```

#### Field Resolver ÂÑ™Âåñ
```typescript
// ‰ΩøÁî® DataLoader ÈÅøÂÖçÈáçË§áÊü•Ë©¢
const productDetailsLoader = new DataLoader(async (productIds: string[]) => {
  const details = await supabase.rpc('rpc_batch_get_product_details', {
    p_product_ids: productIds
  });
  return productIds.map(id => details.find(d => d.product_id === id));
});

// GraphQL Field Resolver
const resolvers = {
  Product: {
    details: async (parent: Product) => {
      return productDetailsLoader.load(parent.id);
    }
  }
};
```

### Á∑©Â≠òÁ≠ñÁï•

#### Â§öÂ±§Á∑©Â≠òÊû∂Êßã
```typescript
export class CacheStrategy {
  // L1: Apollo Server ÈüøÊáâÁ∑©Â≠òÔºà1-5ÂàÜÈêòÔºâ
  getServerCacheHints(operation: string) {
    return {
      maxAge: 300, // 5 ÂàÜÈêò
      scope: 'PRIVATE' // Êàñ 'PUBLIC'
    };
  }

  // L2: Apollo Client Ê≠£Ë¶èÂåñÁ∑©Â≠ò
  configureApolloCache() {
    return new InMemoryCache({
      typePolicies: {
        Query: {
          fields: {
            // ÂÆöÁæ©Á∑©Â≠òÂêà‰ΩµÁ≠ñÁï•
          }
        }
      }
    });
  }

  // L3: React Query Á∑©Â≠òÂ±§ÔºàÂèØÈÅ∏ÔºåÁî®ÊñºË§áÈõúÁãÄÊÖãÁÆ°ÁêÜÔºâ
  getQueryOptions(operation: string) {
    return {
      staleTime: 5 * 60 * 1000, // 5 ÂàÜÈêò
      cacheTime: 10 * 60 * 1000, // 10 ÂàÜÈêò
      refetchOnWindowFocus: false
    };
  }

  // Á∑©Â≠òÁ≠ñÁï•ÈÅ∏Êìá
  getCachePolicy(operation: string) {
    return {
      'realtime-data': 'network-only',
      'static-data': 'cache-first',
      'user-data': 'cache-and-network'
    }[operation] || 'cache-first';
  }
}
```

---

## üîí ÂÆâÂÖ®ËàáÊ¨äÈôêÊéßÂà∂

### GraphQL Ê¨äÈôêÊ®°Âºè
```typescript
// Áµ±‰∏ÄÊ¨äÈôêÊ™¢Êü•‰∏≠Èñì‰ª∂
export function requireAuth(resolver: Function) {
  return async (parent: any, args: any, context: any, info: any) => {
    if (!context.user) {
      throw new GraphQLError('Authentication required', {
        extensions: { code: 'UNAUTHENTICATED' }
      });
    }
    return resolver(parent, args, context, info);
  };
}

// ËßíËâ≤Ê¨äÈôêÊ™¢Êü•
export function requireRole(roles: string[]) {
  return (resolver: Function) => async (parent: any, args: any, context: any, info: any) => {
    const userRole = context.user?.role;
    if (!roles.includes(userRole)) {
      throw new GraphQLError('Insufficient permissions', {
        extensions: { code: 'FORBIDDEN' }
      });
    }
    return resolver(parent, args, context, info);
  };
}

// ‰ΩøÁî®ÁØÑ‰æã
const resolvers = {
  Query: {
    sensitiveData: requireAuth(requireRole(['admin', 'manager'])(
      async (_, args, context) => {
        return await getSensitiveData(args, context.user);
      }
    ))
  }
};
```

---

## üß™ Ê∏¨Ë©¶Á≠ñÁï•

### GraphQL Ê∏¨Ë©¶ÁØÑ‰æã
```typescript
// __tests__/graphql/new-feature.test.ts
import { createTestClient } from 'apollo-server-testing';
import { gql } from 'apollo-server-core';

describe('NewFeature GraphQL', () => {
  let testClient: TestClient;

  beforeEach(() => {
    testClient = createTestClient(server);
  });

  it('should fetch feature data', async () => {
    const query = gql`
      query GetNewFeatureData($input: NewFeatureInput!) {
        newFeatureData(input: $input) {
          items {
            id
            name
            status
          }
          total
          aggregates {
            totalValue
            averageScore
          }
        }
      }
    `;

    const { data, errors } = await testClient.query({
      query,
      variables: {
        input: {
          filters: { status: 'active' },
          pagination: { limit: 10, offset: 0 }
        }
      }
    });

    expect(errors).toBeUndefined();
    expect(data.newFeatureData.items).toHaveLength(10);
    expect(data.newFeatureData.total).toBeGreaterThan(0);
  });
});
```

---

## üìà Áõ£ÊéßËàáÈô§ÈåØ

### GraphQL Êü•Ë©¢Áõ£Êéß
```typescript
// lib/monitoring/graphql-monitor.ts
export class GraphQLMonitor {
  static trackQuery(operation: string, duration: number, success: boolean) {
    // Ë®òÈåÑÊü•Ë©¢ÊÄßËÉΩ
    console.log(`[GraphQL] ${operation}: ${duration}ms ${success ? '‚úÖ' : '‚ùå'}`);
    
    // ÁôºÈÄÅÂà∞Áõ£ÊéßÁ≥ªÁµ±
    if (duration > 1000) {
      console.warn(`[GraphQL] Slow query detected: ${operation} took ${duration}ms`);
    }
  }

  static trackError(operation: string, error: Error) {
    console.error(`[GraphQL] Error in ${operation}:`, error);
    // ÁôºÈÄÅÈåØË™§Â†±Âëä
  }
}
```

### ÈñãÁôºÂ∑•ÂÖ∑ÈÖçÁΩÆ
```typescript
// next.config.js
module.exports = {
  experimental: {
    instrumentationHook: true
  },
  
  // GraphQL ÈñãÁôºÂ∑•ÂÖ∑
  webpack: (config, { dev }) => {
    if (dev) {
      config.devtool = 'source-map';
    }
    return config;
  }
};
```

---

## üöÄ ÈÉ®ÁΩ≤ÊåáÂçó

### ÁîüÁî¢Áí∞Â¢ÉÈÖçÁΩÆ
```typescript
// GraphQL ÁîüÁî¢ÂÑ™Âåñ
const apolloServer = new ApolloServer({
  typeDefs,
  resolvers,
  plugins: [
    // Êü•Ë©¢Ë§áÈõúÂ∫¶ÈôêÂà∂
    require('graphql-query-complexity').createComplexityLimitRule(1000),
    
    // Êü•Ë©¢Ê∑±Â∫¶ÈôêÂà∂
    require('graphql-depth-limit')(10),
    
    // ÈÄüÁéáÈôêÂà∂
    require('graphql-rate-limit')({
      max: 1000,
      window: '15m'
    })
  ],
  
  // ÁîüÁî¢Áí∞Â¢ÉÁ¶ÅÁî® introspection
  introspection: process.env.NODE_ENV !== 'production',
  playground: process.env.NODE_ENV !== 'production'
});
```

---

## üìö Áõ∏ÈóúÊñáÊ™î
- [Single Query Ê®°ÂºèÊåáÂçó](./Single-Query-Pattern-Guide.md)
- [Card Êû∂ÊßãÈñãÁôºÊåáÂçó](./CardÊû∂ÊßãÈñãÁôºÊåáÂçó.md)
- [TypeScript ÈÅ∑ÁßªÊåáÂçó](./TypeScript-Migration-Guide.md)
- [GraphQL-Card ÈÅ∑ÁßªÁ≠ñÁï•](../expert-discussions/2025-07-27-GraphQL-Card-Migration-Strategy.md)

---

**ÊåáÂçóÂª∫Á´ã**: AI Âçî‰ΩúËÄÖ  
**ÊäÄË°ìÂØ©Ê†∏**: Êû∂ÊßãÂ∞àÂÆ∂  
**Âü∑Ë°åË≤†Ë≤¨**: ÈñãÁôºÂúòÈöä  
**ÊúÄÂæåÊõ¥Êñ∞**: 2025-07-28 18:00