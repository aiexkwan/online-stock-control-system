# 測試覆蓋率提升計劃

**計劃創建日期**: 2025-07-11  
**當前測試覆蓋率**: ~10%  
**目標覆蓋率**: 短期 30% | 長期 80%  

## 執行摘要

本計劃旨在系統性地提升 NewPennine 項目的測試覆蓋率，通過版本化的方式逐步實施，確保關鍵業務功能的穩定性和可維護性。

## 版本規劃總覽

| 版本 | 預期覆蓋率 | 重點領域 | 關鍵成果 |
|------|-----------|---------|---------|
| v1.1 | 15% | 技術債務修復 + 核心服務測試 | 測試基礎設施完善 |
| v1.2 | 20% | UI 組件 + Critical API Routes | 前端組件穩定性 |
| v1.3 | 25% | 業務邏輯 Hooks + 頁面組件 | 核心功能覆蓋 |
| v1.4 | 30% | 剩餘 API + Services | 達成短期目標 |
| v2.0 | 40% | E2E 測試擴展 | 端到端流程保障 |
| v2.1 | 50% | 性能測試套件 | 性能基準建立 |
| v2.2 | 60% | 邊緣案例覆蓋 | 錯誤處理完善 |
| v3.0 | 80% | 全面覆蓋 + 自動化 | 達成長期目標 |

## 詳細版本計劃

### Version 1.1 - 測試基礎設施強化 (10% → 15%)

#### 技術債務修復
- [ ] 升級 Next.js API Route 測試環境
  - 實施 `next-test-api-route-handler`
  - 建立標準化 API route 測試模板
- [ ] 完善 Supabase Mock 策略  
  - 整合 MSW (Mock Service Worker)
  - 建立 Supabase RPC mock 系統
- [ ] 擴展測試數據工廠
  - 添加場景化測試數據集
  - 實現測試數據清理機制

#### 核心服務測試 (0% → 100% for critical services)
- [ ] **PalletSearchService** (高優先級)
  - `searchPallet()` 測試
  - `batchSearchPallets()` 測試
  - 邊界情況處理
- [ ] **TransactionLogService** (高優先級)
  - 事務生命週期測試
  - 回滾機制測試
  - 並發處理測試
- [ ] **InventoryService** (高優先級)
  - 庫存更新邏輯測試
  - 數據一致性驗證

### Version 1.2 - UI 組件與關鍵 API (15% → 20%)

#### UI 組件測試擴展
- [ ] **Dialog 組件套件** (複雜度高)
  - 基本 Dialog 測試
  - 核心 Dialog 變體測試
  - 響應式行為測試
  - 動畫性能測試
- [ ] **Select 組件套件**
  - Radix Select 無障礙測試
  - 鍵盤導航測試
  - 大數據量性能測試

#### Critical API Routes 測試
- [ ] `/api/inventory/stock-levels`
  - 參數驗證測試
  - 分頁功能測試
  - 過濾邏輯測試
- [ ] `/api/admin/dashboard`  
  - 數據聚合測試
  - 權限檢查測試
  - 緩存機制測試
- [ ] `/api/ask-database`
  - AI 查詢解析測試
  - SQL 注入防護測試
  - 錯誤處理測試

### Version 1.3 - 業務邏輯深度覆蓋 (20% → 25%)

#### 關鍵 Hooks 測試
- [ ] **useUserId** (身份驗證核心)
  - 認證狀態管理測試
  - 緩存機制測試
  - 錯誤恢復測試
- [ ] **usePdfGeneration** (標籤列印核心)
  - PDF 生成流程測試
  - 錯誤處理測試
  - 批量處理測試
- [ ] **usePalletGeneration**
  - 號碼生成邏輯測試
  - 並發安全測試

#### 核心頁面組件測試
- [ ] **Order Loading Page**
  - 批量掃描功能測試
  - 虛擬滾動性能測試
  - 異常檢測測試
- [ ] **Stock Count Page**
  - 盤點流程測試
  - 數據驗證測試
  - 批量處理測試

### Version 1.4 - 全面服務覆蓋 (25% → 30%)

#### 剩餘服務測試
- [ ] **AdminDataService**
  - 統計數據準確性測試
  - 複雜查詢性能測試
- [ ] **EmailService**
  - 郵件發送流程測試
  - 模板渲染測試
- [ ] **AnomalyDetectionService**
  - 異常檢測算法測試
  - 誤報率測試

#### 剩餘 API Routes
- [ ] `/api/stock-count/*` 系列
- [ ] `/api/reports/*` 系列
- [ ] `/api/analyze-order-pdf-assistant`

### Version 2.0 - E2E 測試擴展 (30% → 40%)

#### 端到端測試套件
- [ ] 完整訂單處理流程
- [ ] 庫存盤點全流程
- [ ] 標籤打印全流程
- [ ] 用戶權限管理流程

#### 集成測試強化
- [ ] 跨服務事務測試
- [ ] 實時數據同步測試
- [ ] 第三方服務集成測試

### Version 2.1 - 性能測試建立 (40% → 50%)

#### 性能基準測試
- [ ] API 響應時間基準
- [ ] 前端渲染性能基準
- [ ] 數據庫查詢性能基準

#### 負載測試
- [ ] 並發用戶測試
- [ ] 大數據量處理測試
- [ ] 內存洩漏檢測

### Version 2.2 - 邊緣案例完善 (50% → 60%)

#### 錯誤處理測試
- [ ] 網絡錯誤恢復
- [ ] 數據不一致處理
- [ ] 權限異常處理

#### 邊界條件測試
- [ ] 極限數據量測試
- [ ] 並發衝突測試
- [ ] 超時處理測試

### Version 3.0 - 全面覆蓋達成 (60% → 80%)

#### 測試自動化
- [ ] CI/CD 集成優化
- [ ] 自動化回歸測試
- [ ] 測試報告自動生成

#### 維護性提升
- [ ] 測試代碼重構
- [ ] 測試文檔完善
- [ ] 最佳實踐指南

## 實施策略

### 測試優先級原則
1. **業務關鍵性**: 優先測試核心業務功能
2. **使用頻率**: 高頻使用功能優先
3. **複雜度**: 複雜邏輯需要更多測試
4. **風險評估**: 高風險區域優先覆蓋

### 測試類型分配
- 單元測試: 60%
- 集成測試: 25%
- E2E 測試: 10%
- 性能測試: 5%

### 團隊協作模式
1. 每個版本設立測試冠軍
2. Code Review 必須包含測試
3. 測試驅動開發 (TDD) 鼓勵
4. 定期測試覆蓋率審查

## 成功指標

### 量化指標
- 測試覆蓋率百分比
- 測試執行時間
- 缺陷逃逸率
- 測試維護成本

### 質量指標
- 測試可讀性評分
- 測試穩定性（flaky test 比例）
- 測試文檔完整性
- 團隊測試信心指數

## 風險與緩解

### 主要風險
1. **時間壓力**: 可能影響測試質量
   - 緩解: 設立最小可行測試標準
2. **技術債務**: 現有代碼難以測試
   - 緩解: 漸進式重構配合測試
3. **團隊抗性**: 開發人員不願寫測試
   - 緩解: 培訓和激勵機制

## 工具與資源

### 測試工具
- Jest + React Testing Library
- MSW (Mock Service Worker)
- Playwright (E2E)
- React Query DevTools

### 監控工具
- Jest Coverage Reports
- SonarQube (可選)
- Bundle Size Monitor

### 學習資源
- 內部測試最佳實踐文檔
- 測試編寫指南
- 測試案例庫

## 結語

本計劃通過系統化的版本規劃，逐步提升測試覆蓋率，確保 NewPennine 系統的穩定性和可維護性。每個版本都有明確的目標和可衡量的成果，使團隊能夠有序推進測試工作。

---

*最後更新: 2025-07-11*