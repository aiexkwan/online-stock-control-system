# Stock Transfer 快取實施文檔

## 已實施的優化

### 1. 托盤資料快取 (usePalletCache)

#### 功能特點：
- **TTL (Time To Live)**: 5分鐘預設快取時間
- **最大快取容量**: 100個托盤（可調整）
- **背景刷新**: 自動刷新即將過期的快取項目
- **預加載**: 頁面載入時預加載常用托盤前綴

#### 實施細節：

```typescript
// 快取配置
const cacheOptions = {
  ttl: 5 * 60 * 1000,           // 5分鐘
  maxSize: 50,                   // 最多快取50個托盤
  preloadPatterns: ['PM-', 'PT-'], // 預加載常用前綴
  enableBackgroundRefresh: true   // 啟用背景刷新
};
```

### 2. 預加載機制

#### 頁面載入時預加載：
- 自動加載最近使用的托盤（基於歷史記錄）
- 支援多個前綴模式批量預加載
- 非阻塞式異步加載

```typescript
// 預加載實施
useEffect(() => {
  const initPreload = async () => {
    await preloadPallets(['PM-', 'PT-', 'PL-']);
  };
  initPreload();
}, []);
```

### 3. 快取策略

#### 快取命中流程：
1. 搜尋時先檢查記憶體快取
2. 快取命中直接返回，無需查詢資料庫
3. 快取未命中才執行資料庫查詢
4. 查詢結果自動更新快取

#### 快取失效：
- 托盤轉移成功後自動使相關快取失效
- 確保下次查詢取得最新資料

### 4. 背景刷新機制

- 每30秒檢查一次即將過期的快取項目
- 在快取過期前20%時間內自動刷新
- 批量刷新以減少資料庫查詢次數

### 5. 效能改進預期

#### 搜尋速度提升：
- **首次搜尋**: 正常速度（需查詢資料庫）
- **重複搜尋**: 近乎即時（從快取讀取）
- **預加載項目**: 即時響應

#### 資料庫負載減少：
- 減少重複查詢
- 批量查詢優化
- 背景刷新分散負載

## 使用指南

### 1. 監控快取狀態
```typescript
const stats = getCacheStats();
console.log('快取大小:', stats.size);
console.log('快取項目:', stats.items);
```

### 2. 手動使快取失效
```typescript
// 使特定托盤快取失效
invalidateCache('PM-20240315-001');

// 清除所有快取
invalidateCache();
```

### 3. 調整快取參數
根據使用情況調整：
- **TTL**: 如果資料變動頻繁，減少快取時間
- **maxSize**: 根據記憶體使用情況調整
- **preloadPatterns**: 根據最常用的托盤前綴調整

## 下一步優化建議

1. **智能預加載**
   - 基於使用者行為模式預加載
   - 根據時段調整預加載策略

2. **離線快取**
   - 使用 IndexedDB 持久化快取
   - 支援離線操作

3. **快取分析**
   - 記錄命中率統計
   - 優化快取策略

4. **實時更新**
   - 使用 Supabase Realtime 自動更新快取
   - 確保多用戶環境下資料一致性