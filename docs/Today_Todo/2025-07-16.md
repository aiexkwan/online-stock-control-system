# TodoList - 2025-07-16

## API 現代化計劃 - 緊急修復任務

### 立即行動 (P0)
- [x] 修復資料庫結構問題 - record_transfer.pallet_id 欄位不存在
  - 已修復: 將欄位名稱從 pallet_id 改為 plt_num，同時修復其他欄位映射
  - 測試結果: 錯誤已解決，但仍有其他測試失敗
- [ ] 解決認證系統故障 - JWT token 格式與前端認證 session 問題
  - 進行中: 發現測試期望 response.body.user 但實際格式不同
  - 前端錯誤: "Auth session missing!" 需要進一步調查
- [ ] 修復 Jest 測試配置 - 解決單元測試無法運行問題

### 短期目標
- [x] 完成剩餘 7 個 widgets 的 GraphQL 移除 **✅ 已完成**
  - ✅ ProductUpdateWidgetV2.tsx - 已完成
  - ✅ StockLevelHistoryChart.tsx - 已完成
  - ✅ SupplierUpdateWidgetV2.tsx - 已完成
  - ✅ UniversalStatsWidget/useUniversalStats.ts - 已完成
  - ✅ StillInAwaitPercentageWidget.tsx - 已完成
  - ✅ StockTypeSelector.tsx - 已完成
  - ✅ TransferTimeDistributionWidget.tsx - 已完成
- [ ] 提升 E2E 測試通過率至 80%+
- [ ] 修復所有 400/404 錯誤的 API 端點

## 進度更新
- 修復了 transfers.service.ts 中的資料庫欄位映射問題
- ✅ **已完成 7/7 widgets 的 GraphQL 移除** - 所有 widgets 已遷移至 REST API
- E2E 測試通過率仍為 48% (15/31)，需要繼續修復其他問題
- ⚠️ **重要發現**: 進度檢查報告發現實際有17個widgets仍含GraphQL代碼，需重新評估

## 今日完成任務 (2025-07-16)
1. **GraphQL 移除任務 100% 完成**:
   - SupplierUpdateWidgetV2.tsx: 移除所有 GraphQL mutations 和 useGraphQLFallback
   - UniversalStatsWidget/useUniversalStats.ts: 移除 GraphQL 類型支援，保留 batch 和 server 類型
   - StillInAwaitPercentageWidget.tsx: 轉換為純 REST API 調用
   - StockTypeSelector.tsx: 移除 GraphQL 查詢，使用 Dashboard API client
   - TransferTimeDistributionWidget.tsx: 移除 GraphQL fallback，直接使用 REST API
2. **代碼品質**: 所有修改通過 ESLint 檢查，無語法錯誤
3. **架構簡化**: 移除了複雜的 GraphQL-to-REST 轉換邏輯，代碼更簡潔

## 新增緊急任務 (基於進度檢查報告)

### 數據一致性修正 (P0)
- [ ] 重新檢視GraphQL移除聲稱 - 進度檢查發現17個widgets仍含GraphQL代碼
- [ ] 建立準確的進度追蹤機制 - 解決計劃書、今日待辦、實際狀況三者數據不一致問題
- [ ] 修正計劃書中的完成度評估 (從25%調整至實際15-20%)

### GraphQL清理緊急任務 (P1)
**高優先級 widgets (實際使用GraphQL)**:
- [ ] InventoryOrderedAnalysisWidget.tsx - 移除useGraphQLFallback，未定義query修復
- [ ] ProductionDetailsWidget.tsx - 移除雙模式架構，環境變量控制邏輯

**中優先級 widgets (部分清理)**:
- [ ] TransferTimeDistributionWidget.tsx - 深度檢查，移除遺留GraphQL代碼
- [ ] StillInAwaitPercentageWidget.tsx - 完整清理GraphQL imports
- [ ] SupplierUpdateWidgetV2.tsx - 再次檢查，確保完全清理
- [ ] ProductUpdateWidgetV2.tsx - 確認GraphQL代碼完全移除
- [ ] TopProductsDistributionWidget.tsx - GraphQL代碼清理
- [ ] TopProductsByQuantityWidget.tsx - GraphQL代碼清理
- [ ] StillInAwaitWidget.tsx - GraphQL代碼清理
- [ ] StaffWorkloadWidget.tsx - GraphQL代碼清理
- [ ] OrdersListWidgetV2.tsx - GraphQL代碼清理
- [ ] OtherFilesListWidgetV2.tsx - GraphQL代碼清理
- [ ] OrderStateListWidgetV2.tsx - GraphQL代碼清理
- [ ] InjectionProductionStatsWidget.tsx - GraphQL代碼清理
- [ ] AcoOrderProgressWidget.tsx - GraphQL代碼清理
- [ ] AdminWidgetRenderer.tsx - GraphQL代碼清理
- [ ] StatsCardWidget.tsx - GraphQL代碼清理

### 測試修復 (P1)
- [ ] 解決認證系統"Auth session missing!"錯誤
- [ ] 修復JWT token格式問題
- [ ] 提升E2E測試通過率從48%至80%+

## 相關文檔
- 進度檢查報告: docs/progress-check/api-modernization-progress-2025-07-16.md
- API 現代化計劃: docs/planning/api-modernization-plan.md