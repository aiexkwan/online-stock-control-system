# è³‡æ–™åº«æ¶æ§‹é©—è­‰å ±å‘Š - Data Architect

**é©—è­‰æ™‚é–“**: 2025-08-27 08:52:22  
**é©—è­‰æ–¹å¼**: Supabase MCP å·¥å…·å¯¦æ™‚æŸ¥è©¢  
**åŸ·è¡Œè€…**: Data Architect å°ˆæ¥­è§’è‰²

## ä¸€ã€è³‡æ–™åº«è¡¨æ ¼è©³ç´°çµ±è¨ˆ

### 1.1 è¡¨æ ¼æ•¸é‡çµ±è¨ˆï¼ˆå¯¦éš›æŸ¥è©¢çµæœï¼‰

| Schema   | è¡¨æ ¼æ•¸é‡ |
|----------|---------|
| auth     | 16      |
| public   | 23      |
| storage  | 7       |
| **ç¸½è¨ˆ** | **46**  |

> âš ï¸ **é‡è¦ç™¼ç¾**: å¯¦éš› public schema ä¸­åªæœ‰ 23 å€‹è¡¨ï¼Œè€Œéæ–‡æª”ä¸­è¨˜è¼‰çš„ 30 å€‹è¡¨

### 1.2 Public Schema è¡¨æ ¼æ¸…å–®

```sql
-- å¯¦éš›å­˜åœ¨çš„ 23 å€‹è¡¨æ ¼
1. API
2. audit_logs
3. context_summaries
4. data_code
5. data_id
6. data_order
7. data_slateinfo
8. data_supplier
9. doc_upload
10. grn_level
11. order_loading_history
12. pallet_number_buffer
13. query_record
14. record_aco
15. record_grn
16. record_history
17. record_inventory
18. record_palletinfo
19. record_stocktake
20. record_transfer
21. report_void
22. stock_level
23. work_level
```

### 1.3 å¤–éµé—œä¿‚çµ±è¨ˆï¼ˆå¯¦éš›æŸ¥è©¢çµæœï¼‰

| Schema   | å¤–éµæ•¸é‡ |
|----------|---------|
| auth     | 11      |
| public   | 16      |
| storage  | 5       |
| **ç¸½è¨ˆ** | **32**  |

> âš ï¸ **é‡è¦ç™¼ç¾**: public schema ä¸­æœ‰ 16 å€‹å¤–éµï¼Œè€Œéæ–‡æª”ä¸­è¨˜è¼‰çš„ 17 å€‹

## äºŒã€RLS ç­–ç•¥çµ±è¨ˆ

### 2.1 RLS ç­–ç•¥åˆ†å¸ƒ

| Schema   | ç¸½ç­–ç•¥æ•¸ |
|----------|---------|
| public   | 109     |
| storage  | 10      |
| **ç¸½è¨ˆ** | **119** |

> âš ï¸ **é‡è¦ç™¼ç¾**: å¯¦éš› RLS ç­–ç•¥æ•¸ç‚º 119 å€‹ï¼Œè€Œéæ–‡æª”ä¸­è¨˜è¼‰çš„ 88 å€‹

### 2.2 å„è¡¨æ ¼ RLS ç­–ç•¥è©³ç´°ï¼ˆPublic Schemaï¼‰

| è¡¨æ ¼åç¨±             | ç­–ç•¥æ•¸ |
|---------------------|--------|
| API                 | 4      |
| audit_logs          | 4      |
| context_summaries   | 4      |
| data_code           | 5      |
| data_id             | 6      |
| data_order          | 7      |
| data_slateinfo      | 4      |
| data_supplier       | 4      |
| doc_upload          | 4      |
| grn_level           | 5      |
| order_loading_history| 4      |
| pallet_number_buffer| 2      |
| query_record        | 5      |
| record_aco          | 4      |
| record_grn          | 6      |
| record_history      | 6      |
| record_inventory    | 6      |
| record_palletinfo   | 5      |
| record_stocktake    | 4      |
| record_transfer     | 6      |
| report_void         | 4      |
| stock_level         | 5      |
| work_level          | 5      |

## ä¸‰ã€è³‡æ–™åº«å®‰å…¨å¯©è¨ˆçµæœ

### 3.1 å®‰å…¨é¢¨éšªï¼ˆERROR ç´šåˆ¥ï¼‰

1. **Security Definer Views** (3å€‹)
   - `public.security_metrics`
   - `public.data_id_decrypted`
   - `public.rls_policy_overview`
   - **é¢¨éšª**: é€™äº›è¦–åœ–ä½¿ç”¨ SECURITY DEFINERï¼Œæœƒä»¥å‰µå»ºè€…æ¬Šé™åŸ·è¡Œ
   - **å»ºè­°**: å¯©æŸ¥ä¸¦è€ƒæ…®ç§»é™¤ SECURITY DEFINER å±¬æ€§

### 3.2 å®‰å…¨è­¦å‘Šï¼ˆWARN ç´šåˆ¥ï¼‰

1. **Function Search Path Mutable** (15å€‹å‡½æ•¸)
   - åŒ…æ‹¬åŠ å¯†ç›¸é—œå‡½æ•¸ï¼š`encrypt_sensitive_data`, `decrypt_sensitive_data`
   - ç­–ç•¥ç®¡ç†å‡½æ•¸ï¼š`create_unified_policy`, `apply_standard_policies`
   - **é¢¨éšª**: æœªè¨­ç½® search_path å¯èƒ½å°è‡´ SQL æ³¨å…¥é¢¨éšª
   - **å»ºè­°**: ç‚ºæ‰€æœ‰å‡½æ•¸è¨­ç½®æ˜ç¢ºçš„ search_path

2. **Extensions in Public Schema** (2å€‹)
   - `pg_trgm` (1.6ç‰ˆæœ¬)
   - `vector` (0.8.0ç‰ˆæœ¬)
   - **å»ºè­°**: ç§»å‹•åˆ°å°ˆç”¨ schema

## å››ã€è³‡æ–™åº«æ“´å±•ä½¿ç”¨æƒ…æ³

### 4.1 å·²å®‰è£æ“´å±•ï¼ˆ8å€‹ï¼‰

| æ“´å±•åç¨±            | Schema      | ç‰ˆæœ¬   | ç”¨é€”                        |
|-------------------|-------------|--------|----------------------------|
| plpgsql           | pg_catalog  | 1.0    | PL/pgSQL ç¨‹åºèªè¨€           |
| pg_stat_statements| extensions  | 1.10   | SQL èªå¥æ€§èƒ½ç›£æ§            |
| pgjwt             | extensions  | 0.2.0  | JWT Token è™•ç†              |
| pgcrypto          | extensions  | 1.3    | åŠ å¯†åŠŸèƒ½                    |
| uuid-ossp         | extensions  | 1.1    | UUID ç”Ÿæˆ                   |
| supabase_vault    | vault       | 0.3.1  | Supabase Vault æ“´å±•         |
| pg_graphql        | graphql     | 1.5.11 | GraphQL æ”¯æŒ                |
| pg_cron           | pg_catalog  | 1.6    | å®šæ™‚ä»»å‹™èª¿åº¦                |
| pg_trgm           | public      | 1.6    | æ–‡æœ¬ç›¸ä¼¼åº¦æœç´¢              |
| vector            | public      | 0.8.0  | å‘é‡æ•¸æ“šé¡å‹èˆ‡æœç´¢          |

### 4.2 å¯ç”¨ä½†æœªå®‰è£æ“´å±•ï¼ˆé‡è¦ï¼‰

- **postgis**: åœ°ç†ç©ºé–“æ•¸æ“šè™•ç†
- **timescaledb**: æ™‚åºæ•¸æ“šå„ªåŒ–
- **pgmq**: PostgreSQL æ¶ˆæ¯éšŠåˆ—
- **hypopg**: å‡è¨­ç´¢å¼•åˆ†æ
- **pg_hashids**: HashID ç”Ÿæˆ

## äº”ã€GraphQL å±¤æ•´åˆç‹€æ…‹

### 5.1 GraphQL é…ç½®é©—è­‰

**codegen.yml é…ç½®**ï¼š
- âœ… Schema ç”Ÿæˆè·¯å¾‘: `./lib/graphql/export-schema.js`
- âœ… æ–‡æª”æº: `app/**/*.tsx`, `lib/graphql/queries/**/*.graphql`
- âœ… ç”Ÿæˆç›®æ¨™: `types/generated/graphql.ts`
- âœ… Apollo React Hooks æ”¯æŒ

### 5.2 Apollo Client é…ç½®

**é—œéµé…ç½®**ï¼š
- âœ… Supabase GraphQL ç«¯é»æ”¯æŒ
- âœ… JWT èªè­‰æ•´åˆ
- âœ… æ€§èƒ½ç›£æ§ Link (`PerformanceLink`)
- âœ… éŒ¯èª¤è™•ç†èˆ‡é‡è©¦æ©Ÿåˆ¶
- âœ… é«˜ç´šç·©å­˜ç­–ç•¥é…ç½®

### 5.3 GraphQL æ–‡ä»¶çµ±è¨ˆ

**ç¸½è¨ˆ**: 65 å€‹ TypeScript æ–‡ä»¶
- Resolvers: 22 å€‹
- Schema å®šç¾©: 8 å€‹
- Queries: 11 å€‹
- DataLoaders: 5 å€‹ï¼ˆN+1 å•é¡Œå„ªåŒ–ï¼‰
- ä¸­é–“ä»¶: 3 å€‹
- å…¶ä»–å·¥å…·: 16 å€‹

## å…­ã€è³‡æ–™åº«é·ç§»ç‹€æ…‹

### 6.1 é·ç§»çµ±è¨ˆ

- **ç¸½é·ç§»æ•¸**: 287 å€‹
- **æœ€æ—©é·ç§»**: 2025-05-14 (create_increment_grn_pallet_counter_function)
- **æœ€æ–°é·ç§»**: 2025-08-25 (optimize_database_verified_final)

### 6.2 é‡è¦é·ç§»é‡Œç¨‹ç¢‘

1. **2025-07-02**: çµ±ä¸€ RPC å‡½æ•¸ç³»çµ±å¯¦ç¾
2. **2025-07-08**: æ€§èƒ½å„ªåŒ–èˆ‡ç›£æ§ç³»çµ±
3. **2025-07-16**: å„ªåŒ–çš„å„€è¡¨æ¿çµ±è¨ˆ RPC
4. **2025-08-14**: æ‰¹é‡è™•ç†èˆ‡ç·©å­˜å¤±æ•ˆç³»çµ±
5. **2025-08-22**: å¢å¼·çš„ RLS å®‰å…¨ç­–ç•¥
6. **2025-08-25**: è³‡æ–™åº«å„ªåŒ–æœ€çµ‚é©—è­‰

## ä¸ƒã€æ•¸æ“šå±¤èˆ‡APIå±¤æ•´åˆ

### 7.1 Supabase å®¢æˆ¶ç«¯é…ç½®

**å®¢æˆ¶ç«¯è·¯å¾‘**: `/app/utils/supabase/client.ts`
- âœ… ä½¿ç”¨ `@supabase/ssr` å¯¦ç¾ SSR æ”¯æŒ
- âœ… PKCE æµç¨‹èªè­‰
- âœ… Cookie ç®¡ç†æ•´åˆ
- âœ… TypeScript é¡å‹æ”¯æŒ

### 7.2 è³‡æ–™å±¤ç‰¹æ€§

1. **å¯¦æ™‚åŠŸèƒ½**: Supabase Realtime æ”¯æŒ
2. **Row Level Security**: 119 å€‹ç­–ç•¥ä¿è­·æ•¸æ“šå®‰å…¨
3. **å­˜å„²æ•´åˆ**: Storage schema æ”¯æŒæ–‡ä»¶ç®¡ç†
4. **GraphQL æ•´åˆ**: pg_graphql æ“´å±•æä¾›åŸç”Ÿ GraphQL æ”¯æŒ

## å…«ã€æ€§èƒ½å„ªåŒ–å»ºè­°

### 8.1 ç«‹å³éœ€è¦è™•ç†

1. **ä¿®æ­£ Search Path å•é¡Œ**
   - 15 å€‹å‡½æ•¸éœ€è¦è¨­ç½®æ˜ç¢ºçš„ search_path
   - å„ªå…ˆè™•ç†åŠ å¯†å’Œç­–ç•¥ç›¸é—œå‡½æ•¸

2. **ç§»å‹• Public Schema æ“´å±•**
   - å°‡ `pg_trgm` å’Œ `vector` ç§»è‡³å°ˆç”¨ schema

3. **å¯©æŸ¥ Security Definer Views**
   - è©•ä¼° 3 å€‹ä½¿ç”¨ SECURITY DEFINER çš„è¦–åœ–

### 8.2 æ¶æ§‹å„ªåŒ–å»ºè­°

1. **ç´¢å¼•ç­–ç•¥**
   - è€ƒæ…®ç‚ºé«˜é »æŸ¥è©¢è¡¨æ ¼æ·»åŠ è¤‡åˆç´¢å¼•
   - è©•ä¼°ä½¿ç”¨ `hypopg` é€²è¡Œç´¢å¼•åˆ†æ

2. **åˆ†å€ç­–ç•¥**
   - `record_history` è¡¨å¯è€ƒæ…®æŒ‰æ™‚é–“åˆ†å€
   - `audit_logs` è¡¨å¯å¯¦æ–½è‡ªå‹•æ­¸æª”

3. **N+1 å•é¡Œå„ªåŒ–**
   - å·²æœ‰ 5 å€‹ DataLoader å¯¦ç¾
   - å»ºè­°æ“´å±•åˆ°æ›´å¤šæŸ¥è©¢å ´æ™¯

## ä¹ã€æ•¸æ“šå®Œæ•´æ€§ä¿è­‰

### 9.1 ç¾æœ‰æ©Ÿåˆ¶

1. **å¤–éµç´„æŸ**: 32 å€‹å¤–éµç¢ºä¿åƒç…§å®Œæ•´æ€§
2. **RLS ç­–ç•¥**: 119 å€‹ç­–ç•¥ç¢ºä¿è¨ªå•æ§åˆ¶
3. **è§¸ç™¼å™¨å‡½æ•¸**: è‡ªå‹•æ›´æ–°æ™‚é–“æˆ³ç­‰
4. **äº‹å‹™ç®¡ç†**: RPC å‡½æ•¸æ”¯æŒäº‹å‹™å›æ»¾

### 9.2 å»ºè­°å¢å¼·

1. **æ•¸æ“šé©—è­‰å±¤**
   - åœ¨ RPC å‡½æ•¸ä¸­åŠ å…¥æ›´åš´æ ¼çš„è¼¸å…¥é©—è­‰
   - ä½¿ç”¨ Zod schemas é€²è¡Œé¡å‹é©—è­‰

2. **å¯©è¨ˆè¿½è¹¤**
   - `audit_logs` è¡¨å·²å­˜åœ¨
   - å»ºè­°æ“´å±•åˆ°æ›´å¤šé—œéµæ“ä½œ

## åã€ç¸½çµèˆ‡è¡Œå‹•è¨ˆåŠƒ

### 10.1 é—œéµç™¼ç¾

| é …ç›® | æ–‡æª”è¨˜è¼‰ | å¯¦éš›ç‹€æ…‹ | å·®ç•° |
|------|---------|---------|------|
| Public è¡¨æ ¼æ•¸ | 30 | 23 | -7 |
| å¤–éµé—œä¿‚æ•¸ | 17 | 16 (public) / 32 (ç¸½è¨ˆ) | éœ€æ›´æ–°æ–‡æª” |
| RLS ç­–ç•¥æ•¸ | 88 | 119 | +31 |
| GraphQL æ–‡ä»¶ | 65 | 65 | âœ… ä¸€è‡´ |

### 10.2 å„ªå…ˆè¡Œå‹•é …ç›®

1. **é«˜å„ªå…ˆç´š**ï¼ˆç«‹å³åŸ·è¡Œï¼‰
   - ä¿®å¾© 15 å€‹å‡½æ•¸çš„ search_path å•é¡Œ
   - å¯©æŸ¥ 3 å€‹ SECURITY DEFINER è¦–åœ–
   - æ›´æ–°ç³»çµ±æ–‡æª”åæ˜ å¯¦éš›æ¶æ§‹

2. **ä¸­å„ªå…ˆç´š**ï¼ˆæœ¬é€±å…§ï¼‰
   - ç§»å‹• public schema ä¸­çš„æ“´å±•
   - å¯¦æ–½æ•¸æ“šè¡¨åˆ†å€ç­–ç•¥
   - åŠ å¼·æ•¸æ“šé©—è­‰å±¤

3. **ä½å„ªå…ˆç´š**ï¼ˆè¨ˆåŠƒä¸­ï¼‰
   - è©•ä¼°æ–°æ“´å±•çš„ä½¿ç”¨ï¼ˆå¦‚ timescaledbï¼‰
   - å„ªåŒ–è¤‡åˆç´¢å¼•ç­–ç•¥
   - æ“´å±• DataLoader è¦†è“‹ç¯„åœ

### 10.3 æ¶æ§‹å¥åº·è©•åˆ†

**æ•´é«”è©•åˆ†: 8.5/10**

- âœ… **å„ªå‹¢**ï¼šå®Œå–„çš„ RLS ç­–ç•¥ã€è±å¯Œçš„é·ç§»æ­·å²ã€GraphQL æ•´åˆè‰¯å¥½
- âš ï¸ **å¾…æ”¹é€²**ï¼šå®‰å…¨å‡½æ•¸é…ç½®ã€æ–‡æª”æº–ç¢ºæ€§ã€æ“´å±•çµ„ç¹”
- ğŸ“Š **æ€§èƒ½**ï¼šæœ‰ DataLoader å„ªåŒ–ï¼Œä½†å¯é€²ä¸€æ­¥åŠ å¼·

---

**å ±å‘Šç”Ÿæˆæ™‚é–“**: 2025-08-27 08:52:22  
**ä¸‹æ¬¡å¯©æŸ¥å»ºè­°**: 2025-09-03ï¼ˆä¸€é€±å¾Œï¼‰  
**è²¬ä»»äºº**: Data Architect Team