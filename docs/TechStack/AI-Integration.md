# AI 整合 (AI Integration)

_最後更新日期: 2025-09-01 22:54:59_

## 模型與 SDK

- **使用模型**: OpenAI GPT-4o-mini, GPT-4o, GPT-3.5-turbo
- **SDK**: openai 4.104.0, @anthropic-ai/sdk 0.40.1

### 模型選用策略

- **`GPT-4o-mini`**: 作為大部分常規任務的首選模型，在成本和性能之間取得了最佳平衡，用於聊天機器人的即時響應等場景。
- **`GPT-4o`**: 用於需要高質量、複雜推理能力的任務，例如 `ask-database` 的自然語言轉 SQL 查詢。
- **`GPT-3.5-turbo`**: 在對成本極度敏感且任務相對簡單的場景下作為備用選項。

## 核心功能詳解

### 聊天機器人系統 (`ChatbotCard`)

- **實現狀態**: ⚠️ 需要重新評估 (301 行代碼)
- **位置**: `app/(app)/admin/cards/ChatbotCard.tsx`
- **核心特性**:
  - 流式 AI 回應 (Server-Sent Events)
  - 智能會話管理與上下文記憶
  - 異常檢測功能 (限權限用戶)
  - 動態查詢建議與快速操作
  - 錯誤處理與自動重試機制
- **技術整合**:
  - Supabase 認證系統整合
  - 用戶權限管理
  - 性能監控與快取優化

### 資料庫查詢系統 (`ask-database`)

- **實現狀態**: ✅ 完全實現 (1,044 行代碼)
- **位置**: `app/api/ask-database/route.ts`
- **架構特性**:
  - 統一 API 端點 (支援流式與標準模式)
  - 多層智能快取系統 (L1-L3)
  - SQL 安全驗證與自動優化
  - 錯誤分類與自動恢復
  - 會話上下文管理
- **AI 模型配置**:
  - 主要模型: `gpt-4o-mini` (日常查詢優化)
  - 複雜查詢: `gpt-4o` (高級推理任務)
  - 備用選項: `gpt-3.5-turbo` (成本敏感場景)
- **安全機制**:
  - 嚴格 SQL 注入防護 (僅允許 SELECT)
  - 用戶權限驗證與阻擋清單
  - 查詢範圍限制與結果驗證

### PDF 分析服務

- **實現狀態**: ⚠️ 優化中 (OptimizedPDFExtractionService)
- **位置**: `app/services/OptimizedPDFExtractionService.ts`
- **性能目標**: < 5 秒處理時間, < 2000 tokens/請求
- **核心特性**:
  - 增強快取機制 (EnhancedPDFCache)
  - 多重處理策略 (分塊、優化、備用)
  - Token 使用優化與估算
  - 性能指標追蹤
- **應用場景**: GRN 自動處理、供應商文件解析

## 系統安全與配置

### AI 調用安全

- **API 金鑰管理**: 環境變數安全存儲 (OPENAI_API_KEY)
- **LoggerSanitizer 整合**: 敏感資料過濾與日誌清理
- **用戶權限控制**: 基於 Supabase Auth 的訪問管理
- **速率限制**: 防止 AI API 濫用的保護機制
- **阻擋清單**: 特定用戶群組訪問限制

### 性能優化策略

- **多層快取系統**:
  - L1: 內存 LRU 快取 (4 小時 TTL, 2000 條目)
  - L2/L3: 資料庫智能快取 (模糊匹配、語義匹配)
- **流式處理**: Server-Sent Events 實時響應與進度回報
- **Token 優化**: 動態估算、內容分塊、模型選擇優化
- **併發管理**: 合理的請求處理與資源分配

### 監控與分析

- **性能指標**:
  - 響應時間 (目標 < 5 秒)
  - Token 使用量 (目標 < 2000 tokens/請求)
  - 快取命中率追蹤
- **錯誤處理**: 智能分類、自動恢復、用戶友好回饋
- **使用統計**: 查詢模式分析與系統優化建議

## 技術棧整合狀況

### AI SDK 版本確認

- ✅ **OpenAI SDK**: `4.104.0` (最新穩定版)
- ✅ **Anthropic SDK**: `@anthropic-ai/sdk 0.40.1` (備用選項)
- ✅ **相關工具**: tiktoken 1.0.21, pdf-parse 1.1.1, pdf-lib 1.17.1

### 系統整合驗證

- ✅ **Next.js 15.4.4**: API Routes 與 App Router 完整整合
- ✅ **Supabase 2.49.8**: 認證系統與資料庫查詢整合
- ✅ **TypeScript 5.8.3**: 完整型別安全與開發體驗
- ✅ **React 18.3.1**: 流式 UI 更新與狀態管理

### 部署與維運

- ✅ **Vercel 部署**: 無伺服器函數與邊緣運算支援
- ✅ **環境管理**: 開發、測試、生產環境隔離
- ✅ **日誌系統**: 結構化日誌與敏感資料保護
- ✅ **監控告警**: 性能與錯誤監控機制
