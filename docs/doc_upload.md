# 文件上傳 (Upload Files)

## 概述

本文件說明系統中 "文件上傳" (Upload Files) 功能的工作流程。此功能通常位於管理員面板 (`/admin`) 的 "System Tools" (或類似) 類別下，允許授權使用者 (如管理員) 上傳特定類型和大小的文件到 Supabase Storage 中預先設定好的儲存桶 (bucket) 和文件夾 (folder)。

## 相關頁面及組件

### 主要觸發位置
- `/admin`: 管理員面板。使用者可以從導航欄或功能列表中找到 "Upload Files" 選項並點擊，以打開文件上傳的對話框或界面。

### 核心組件
- `app/admin/components/UploadFilesDialog.tsx` (或類似名稱): 文件上傳的核心對話框/界面組件。
    - **`FileDropZone`**: 文件拖放區域。
        - 支援拖拽文件到此區域或點擊此區域打開系統文件選擇器。
        - 視覺上會有虛線邊框，在拖拽文件懸停時高亮。
    - **`FolderSelector`**: 文件夾選擇下拉選單。
        - 允許使用者選擇文件將被上傳到哪個預設的文件夾 (例如 `stockPic` 或 `productSpec`)。
        - 根據使用者選擇的檔案格式，可能會自動篩選可用的目標文件夾。
    - **`FileNameInput`**: 文件名輸入框。
        - 預設填入原始文件名 (不含路徑)。
        - 允許使用者修改文件名。
        - 會對文件名進行驗證 (如不能為空、不能包含非法字元)。
    - **`UploadButton`**: 確認上傳按鈕。
    - **進度條**: 顯示文件上傳的進度。
- **通知組件**: 如 `Sonner Toast`，用於顯示操作成功、失敗或驗證錯誤的訊息。

### 後端/核心邏輯
- **Supabase Storage**:
    - **儲存桶 (Bucket)**: 例如名為 `documents` 的儲存桶。
    - **文件夾 (Folders)**: 在儲存桶內部預設的文件夾，例如：
        - `stockPic/`: 用於儲存庫存相關圖片 (如 `.png`, `.jpeg`)。
        - `productSpec/`: 用於儲存產品規格文檔 (如 `.pdf`, `.doc`, `.docx`)。
- **Server Actions 或 API Route (用於上傳)**:
    - 處理文件接收、驗證 (後端再次驗證文件類型、大小等)。
    - 與 Supabase Storage SDK 互動，執行實際的上傳操作。
    - 返回上傳結果 (成功則包含文件 URL，失敗則包含錯誤訊息)。

## 工作流程

1.  **觸發功能**:
    *   使用者在 `/admin` 頁面點擊 "Upload Files" 選項。
    *   `UploadFilesDialog` (或類似界面) 彈出或顯示。

2.  **選擇文件**:
    *   使用者可以將文件拖拽到 `FileDropZone` 區域。
    *   或者，點擊 `FileDropZone` 區域，從系統文件選擇器中選擇一個文件。
    *   **前端驗證**:
        *   **文件格式**: 檢查文件擴展名是否在允許的列表中 (例如 `.pdf`, `.doc`, `.docx`, `.png`, `.jpeg`, `.jpg`)。
        *   **文件大小**: 檢查文件大小是否超過上限 (例如 10MB)。
        *   如果驗證失敗，顯示錯誤提示，不允許繼續。

3.  **選擇目標文件夾**:
    *   一旦文件被選中且通過初步驗證，`FolderSelector` 下拉選單會被啟用。
    *   下拉選單中會列出可用的目標文件夾。
    *   系統可能會根據選中文件的類型，自動過濾或推薦合適的文件夾 (例如，圖片文件自動建議 `stockPic`)。
    *   使用者選擇一個目標文件夾。如果文件類型與選定文件夾的要求不符，會提示錯誤。

4.  **確認/修改文件名**:
    *   `FileNameInput` 輸入框會自動填入原始文件名 (不含擴展名之前的部分，擴展名通常保留且不可編輯，或系統自動附加)。
    *   使用者可以按需修改文件名。
    *   **文件名驗證**:
        *   不能為空。
        *   不能包含非法字元 (如 `/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `|`)。

5.  **執行上傳**:
    *   使用者點擊 "Confirm Upload" (或類似) 按鈕。
    *   按鈕狀態變為 "Uploading..." 並可能顯示進度條。
    *   前端將文件、選定的目標文件夾路徑 (例如 `stockPic/` 或 `productSpec/`) 以及最終的文件名傳遞給後端 Server Action 或 API Route。

6.  **後端處理與 Supabase Storage 上傳**:
    *   後端再次進行安全驗證 (文件類型、大小，以及使用者權限)。
    *   使用 Supabase Storage SDK 將文件上傳到指定的儲存桶和文件夾路徑下，使用使用者確定的文件名。
    *   處理可能的上傳錯誤 (如網路問題、Supabase 權限錯誤、儲存空間不足等)。

7.  **結果反饋**:
    *   **成功**:
        *   後端返回成功訊息，以及該文件在 Supabase Storage 中的公開 URL (或訪問路徑)。
        *   前端 Toast 通知使用者上傳成功，並可能顯示文件 URL。
        *   進度條達到 100%。
        *   `UploadFilesDialog` 狀態被重置，準備下一次上傳。
    *   **失敗**:
        *   後端返回錯誤訊息。
        *   前端 Toast 通知使用者上傳失敗及原因。
        *   按鈕恢復到可點擊狀態，使用者可以嘗試修正問題後重新上傳。

## UI 與使用者體驗特性

-   **拖拽支持**: 提供便捷的文件選擇方式。
-   **即時驗證**: 在使用者選擇文件、文件夾或輸入文件名時，即時提供驗證反饋。
-   **視覺引導**:
    -   拖拽區域在文件懸停時有高亮等視覺變化。
    -   清晰的圖示和提示文字引導使用者操作。
-   **進度顯示**: 上傳大文件時，進度條給予使用者明確的等待預期。
-   **狀態清晰**: 明確的空閒、拖拽中、文件已選、上傳中、成功、失敗等狀態。
-   **響應式設計**: 界面在不同設備上均能良好顯示和操作。

## 安全與驗證考量

-   **文件類型白名單**: 嚴格限制可上傳的文件擴展名和 MIME 類型，前後端均需驗證。
-   **文件大小限制**: 防止過大文件消耗伺服器資源和儲存空間。
-   **文件名清理與驗證**: 防止惡意文件名或路徑遍歷嘗試。
-   **權限控制**: 確保只有授權使用者 (如管理員) 才能訪問此上傳功能。Supabase Storage Policy 也應配置以限制訪問。
-   **重複文件名處理**: 需明確如何處理文件名衝突 (例如，不允許同名文件，或自動重命名)。`uploadDoc.md` 未明確，但實際系統應考慮。

## 注意事項

-   Supabase Storage 的 bucket 和文件夾需要預先創建並設定好訪問策略 (Policies)。
-   為了更好的使用者體驗，大文件上傳時，除了進度條，還可以考慮分塊上傳和斷點續傳功能 (雖然 `uploadDoc.md` 未提及，但屬於進階優化)。 