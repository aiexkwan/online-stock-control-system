# Ask Database æ”¹é€²è¨ˆåŠƒï¼ˆ2025å¹´6æœˆ27æ—¥æ›´æ–°ç‰ˆï¼‰

## æ¦‚è¿°
Ask Database ä¿‚ä¸€å€‹ä½¿ç”¨ OpenAI GPT-4o å°‡è‡ªç„¶èªè¨€è½‰æ›ç‚º SQL æŸ¥è©¢å˜…æ™ºèƒ½ç³»çµ±ã€‚ç³»çµ±å·²ç¶“å®ŒæˆåŸºç¤æ¶æ§‹å„ªåŒ–ï¼ŒåŒ…æ‹¬å®‰å…¨æ€§ä¿®å¾©ã€LRU ç·©å­˜ã€æ¬Šé™æ§åˆ¶åŒæŸ¥è©¢æ­·å²è¨˜éŒ„ã€‚æœ€æ–°æ”¹é€²åŒ…æ‹¬å¤šè¼ªå°è©±ä¸Šä¸‹æ–‡ç®¡ç†ã€å°è©±æ­·å²æŸ¥è©¢ã€ç•°å¸¸æª¢æ¸¬ã€å¢å¼·ç³»çµ±æç¤ºç­‰åŠŸèƒ½ã€‚

## ç³»çµ±æ¶æ§‹åŒæ•¸æ“šåº«æ•´åˆ

### æ ¸å¿ƒæ¶æ§‹
```
app/api/ask-database/route.ts     # ä¸»APIç«¯é» (1292è¡Œï¼Œå®Œæ•´å¯¦ç¾)
â”œâ”€â”€ OpenAI GPT-4o æ•´åˆï¼ˆå·²å„ªåŒ–ï¼‰
â”œâ”€â”€ ä¸‰å±¤æ™ºèƒ½ç·©å­˜ç³»çµ±
â”‚   â”œâ”€â”€ L1: ç²¾ç¢ºåŒ¹é…ç·©å­˜ (24å°æ™‚)
â”‚   â”œâ”€â”€ L2: èªç¾©ç›¸ä¼¼åº¦ç·©å­˜ (7å¤©ï¼Œ85%ç›¸ä¼¼åº¦)
â”‚   â””â”€â”€ L3: SQL çµæœç·©å­˜ (1å°æ™‚)
â”œâ”€â”€ æ¬Šé™æª¢æŸ¥ï¼ˆé»‘åå–®æ©Ÿåˆ¶ï¼‰
â”œâ”€â”€ å¤šè¼ªå°è©±ä¸Šä¸‹æ–‡ç®¡ç†
â”œâ”€â”€ æŸ¥è©¢æ­·å²ä¿å­˜ï¼ˆæ•¸æ“šåº«æŒä¹…åŒ–ï¼‰
â””â”€â”€ SQL é©—è­‰ï¼ˆåªå…è¨± SELECTï¼‰

lib/
â”œâ”€â”€ prompts/enhanced-system-prompt.ts  # å¢å¼·ç³»çµ±æç¤º (305è¡Œ)
â”œâ”€â”€ query-templates.ts                # æŸ¥è©¢æ¨¡æ¿ç³»çµ± (360è¡Œï¼Œ8å€‹æ¨¡æ¿)
â”œâ”€â”€ conversation-context-db.ts        # å°è©±ä¸Šä¸‹æ–‡ç®¡ç† (395è¡Œ)
â””â”€â”€ sql-optimizer.ts                  # SQL å„ªåŒ–å™¨

components/
â”œâ”€â”€ ask-database/                      # å°ˆç”¨çµ„ä»¶ç›®éŒ„
â”‚   â”œâ”€â”€ QuerySuggestions.tsx         # æŸ¥è©¢å»ºè­°
â”‚   â”œâ”€â”€ ErrorDisplay.tsx             # éŒ¯èª¤é¡¯ç¤º
â”‚   â”œâ”€â”€ AnomalyDetectionButton.tsx   # ç•°å¸¸æª¢æ¸¬æŒ‰éˆ•
â”‚   â”œâ”€â”€ AnomalyDisplay.tsx           # ç•°å¸¸é¡¯ç¤º
â”‚   â””â”€â”€ ContextDebugger.tsx          # ä¸Šä¸‹æ–‡èª¿è©¦å™¨
â””â”€â”€ ui/ask-database-modal.tsx         # æ¨¡æ…‹å°è©±æ¡†

app/components/admin/UniversalChatbot/
â””â”€â”€ EnhancedChatInterface.tsx         # å¢å¼·èŠå¤©ç•Œé¢
```

### æ•¸æ“šåº«çµæ§‹æ•´åˆ
ç³»çµ±å¯æŸ¥è©¢ä»¥ä¸‹æ ¸å¿ƒæ•¸æ“šè¡¨ï¼ˆ18å¼µè¡¨å®Œæ•´æ˜ å°„ï¼‰ï¼š

#### åº«å­˜ç®¡ç†è¡¨
- **record_palletinfo** - æ£§æ¿ä¸»è³‡æ–™ï¼ˆplt_num, product_code, product_qtyï¼‰
- **record_inventory** - å¯¦æ™‚åº«å­˜ï¼ˆplt_num, stock, storage, awaitï¼‰
- **stock_level** - åº«å­˜çµ±è¨ˆè¡¨ï¼ˆå¿«é€ŸæŸ¥è©¢ç”¨ï¼‰
- **record_stocktake** - åº«å­˜ç›¤é»è¨˜éŒ„
- **record_history** - æ‰€æœ‰æ“ä½œæ­·å²ï¼ˆaction, loc, plt_num, timeï¼‰

#### è¨‚å–®ç®¡ç†è¡¨
- **data_order** - å®¢æˆ¶è¨‚å–®ï¼ˆorder_ref, product_code, product_qty, loaded_qtyï¼‰
- **record_aco** - ACOè¨‚å–®ä¸»è¡¨
- **record_aco_detail** - ACOè¨‚å–®æ˜ç´°
- **order_loading_history** - è¨‚å–®è£è¼‰æ­·å²

#### æ”¶è²¨/è½‰ç§»è¡¨
- **record_grn** - æ”¶è²¨è¨˜éŒ„ï¼ˆgrn_num, supplier, product_codeï¼‰
- **record_transfer** - å€‰åº«è½‰ç§»è¨˜éŒ„ï¼ˆfrom_location, to_locationï¼‰

#### åŸºç¤è³‡æ–™è¡¨
- **data_code** - ç”¢å“ä¸»æ•¸æ“šï¼ˆcode, description, type, standard_qtyï¼‰
- **data_id** - ç”¨æˆ¶è³‡æ–™ï¼ˆid, name, department, positionï¼‰
- **data_supplier** - ä¾›æ‡‰å•†è³‡æ–™
- **data_slateinfo** - çŸ³æ¿ç”¢å“è¦æ ¼

#### å·¥ä½œé‡èˆ‡å ±è¡¨
- **work_level** - å·¥ä½œé‡çµ±è¨ˆè¡¨ï¼ˆç›´æ¥æŸ¥è©¢ï¼Œç„¡éœ€è¨ˆç®—ï¼‰
- **report_void** - æå£å“å ±è¡¨
- **report_log** - ç³»çµ±æ—¥èªŒ

### ä¸»è¦åŠŸèƒ½
- **é›™èªæ”¯æ´**ï¼šä¸­è‹±æ–‡è¼¸å…¥ï¼Œè‹±æ–‡å›æ‡‰
- **SQLå®‰å…¨**ï¼šåªå…è¨± SELECT æŸ¥è©¢ï¼Œé˜²æ­¢ SQL æ³¨å…¥
- **æ™ºèƒ½ç·©å­˜**ï¼šä¸‰å±¤ç·©å­˜ç³»çµ±ï¼ˆL1ç²¾ç¢ºåŒ¹é…ã€L2èªç¾©ç›¸ä¼¼ã€L3 SQLçµæœï¼‰
- **ä½¿ç”¨è¿½è¹¤**ï¼šè¨˜éŒ„ token ä½¿ç”¨é‡åŒæŸ¥è©¢æ­·å²
- **æœƒè©±ç®¡ç†**ï¼šæ”¯æ´å¤šè¼ªå°è©±ä¸Šä¸‹æ–‡ï¼ˆæ•¸æ“šåº«æŒä¹…åŒ–ï¼‰
- **æ¬Šé™æ§åˆ¶**ï¼šåŸºæ–¼ç”¨æˆ¶è§’è‰²å˜…é»‘åå–®æ©Ÿåˆ¶
- **ç•°å¸¸æª¢æ¸¬**ï¼šè‡ªå‹•ç™¼ç¾åº«å­˜å’Œè¨‚å–®å•é¡Œ
- **æŸ¥è©¢å„ªåŒ–**ï¼šè‡ªå‹• SQL å„ªåŒ–ï¼Œé˜²æ­¢é‡è¤‡è¨˜éŒ„

## æœ€æ–°æ›´æ–°æ¦‚è¦ï¼ˆ2025å¹´6æœˆ27æ—¥ï¼‰

### ğŸš€ ä»Šæ—¥å®Œæˆçš„ä¸»è¦æ”¹é€²ï¼š

#### 1. å¢å¼·ç³»çµ±æç¤ºè© âœ…
- **æ–‡ä»¶ä½ç½®**: `lib/prompts/enhanced-system-prompt.ts` (305è¡Œ)
- **å®Œæ•´æ•¸æ“šåº«æ˜ å°„**: 18å¼µæ ¸å¿ƒè¡¨æ ¼çš„è©³ç´°çµæ§‹èªªæ˜
- **æ¥­å‹™è¦å‰‡è§£é‡‹**: ä½ç½®æ¦‚å¿µã€å·¥ä½œæµç¨‹ã€æ£§æ¿è™Ÿæ ¼å¼
- **æŸ¥è©¢å„ªåŒ–æç¤º**: ç´¢å¼•ä½¿ç”¨ã€JOIN å„ªåŒ–ã€æ—¥æœŸè™•ç†
- **å¸¸è¦‹æŸ¥è©¢æ¨¡å¼**: é å®šç¾©çš„ SQL æ¨¡æ¿å’Œæœ€ä½³å¯¦è¸

#### 2. æŸ¥è©¢æ¨¡æ¿ç³»çµ±å‡ç´š âœ…
- **æ–‡ä»¶ä½ç½®**: `lib/query-templates.ts` (360è¡Œï¼Œ8å€‹æ¨¡æ¿)
- **æ™ºèƒ½æ¨¡æ¿åŒ¹é…**: é—œéµè© + æ­£å‰‡è¡¨é”å¼é›™é‡åŒ¹é…
- **è®Šé‡æå–ç³»çµ±**: è‡ªå‹•æå–ç”¢å“ä»£ç¢¼ã€å¤©æ•¸ã€è¨‚å–®è™Ÿç­‰
- **æ¨¡æ¿é¡å‹**:
  - `stockLevel`: åº«å­˜æŸ¥è©¢
  - `awaitPallets`: Await location æŸ¥è©¢
  - `dailyProduction`: ä»Šæ—¥ç”Ÿç”¢çµ±è¨ˆ
  - `pendingOrders`: æœªå®Œæˆè¨‚å–®
  - `transferHistory`: è½‰ç§»æ­·å²
  - `grnReceiving`: æ”¶è²¨è¨˜éŒ„
  - `stuckPallets`: é•·æœŸæ»¯ç•™æ£§æ¿
  - `productDistribution`: ç”¢å“åˆ†ä½ˆ

#### 3. å°è©±ä¸Šä¸‹æ–‡ç®¡ç†å®Œå–„ âœ…
- **æ–‡ä»¶ä½ç½®**: `lib/conversation-context-db.ts` (395è¡Œ)
- **æ•¸æ“šåº«æŒä¹…åŒ–**: ä½¿ç”¨ query_record table å„²å­˜å°è©±æ­·å²
- **å¯¦é«”è¿½è¹¤**: è‡ªå‹•æå–ç”¢å“ã€è¨‚å–®ã€æ£§æ¿ç­‰å¯¦é«”
- **ä»£è©è§£æ**: æ”¯æ´ "it", "this", "å‘¢å€‹", "å—°å€‹" ç­‰å¼•ç”¨
- **ä¸Šä¸‹æ–‡ç”Ÿæˆ**: ç‚º OpenAI ç”Ÿæˆçµæ§‹åŒ–ä¸Šä¸‹æ–‡æç¤º

#### 4. å°è©±æ­·å²æŸ¥è©¢å„ªåŒ– âœ…
- **æ™ºèƒ½è­˜åˆ¥**: è­˜åˆ¥ "where are we?", "previous conversation" ç­‰å•é¡Œ
- **åˆ†å±¤æŸ¥è©¢**: å„ªå…ˆé¡¯ç¤º session å…§è¨˜éŒ„ï¼Œç„¡è¨˜éŒ„å‰‡æŸ¥è©¢ç”¨æˆ¶æ­·å²
- **AI ç¸½çµ**: ä½¿ç”¨ GPT-3.5-turbo ç”Ÿæˆè‡ªç„¶èªè¨€ç¸½çµï¼ˆç¯€çœæˆæœ¬ï¼‰
- **æ¢ä»¶ä½¿ç”¨**: åªåœ¨è¶…é 3 æ¢è¨˜éŒ„æ™‚ä½¿ç”¨ AI ç”Ÿæˆç¸½çµ
- **å¤šèªè¨€æ”¯æ´**: æ”¯æ´ä¸­è‹±æ–‡å¤šç¨®è¡¨é”æ–¹å¼

#### 5. æ¾„æ¸…å•é¡Œè™•ç† âœ…
- **è­˜åˆ¥æ©Ÿåˆ¶**: è‡ªå‹•è­˜åˆ¥ OpenAI è¿”å›çš„æ¾„æ¸…è¦æ±‚
- **æ™ºèƒ½è™•ç†**: ä¸å¼·åˆ¶ç”Ÿæˆ SQLï¼Œç›´æ¥è¿”å›æ¾„æ¸…è¨Šæ¯
- **æ¨™è¨˜ç³»çµ±**: ä½¿ç”¨ `needsClarification` æ¨™è¨˜

#### 6. UI/UX æ”¹é€² âœ…
- **æŒ‰éˆ•å¯è¦‹æ€§**: çµ±ä¸€ä½¿ç”¨æ·±è‰²èƒŒæ™¯ï¼Œè§£æ±ºå¯è¦‹æ€§å•é¡Œ
- **è¡¨æ ¼é¡¯ç¤º**: ä¿®æ­£ JSON é¡¯ç¤ºå•é¡Œï¼Œunwrap æ•¸æ“šçµæ§‹
- **æ»¾å‹•æ”¯æ´**: å„ªåŒ–å°è©±æ¡†æ»¾å‹•é«”é©—
- **çµ„ä»¶æ¸…ç†**: ç§»é™¤æœ‰å•é¡Œçš„åœ–è¡¨å¯è¦–åŒ–åŠŸèƒ½

#### 7. ç•°å¸¸æª¢æ¸¬åŠŸèƒ½ âœ…
- **API ç«¯é»**: `/app/api/anomaly-detection/route.ts`
- **æª¢æ¸¬é¡å‹**:
  - åœæ»¯æ£§æ¿æª¢æ¸¬ï¼ˆè¶…é30æ—¥æœªç§»å‹•ï¼‰
  - åº«å­˜ä¸ä¸€è‡´æª¢æ¸¬ï¼ˆstock_level vs å¯¦éš›æ£§æ¿ç¸½æ•¸ï¼‰
  - é€¾æœŸè¨‚å–®æª¢æ¸¬ï¼ˆè¶…éäº¤è²¨æœŸé™ï¼‰
- **UI çµ„ä»¶**: AnomalyDetectionButton + AnomalyDisplay
- **è©³ç´°å ±å‘Š**: æä¾›å…·é«”ç•°å¸¸æƒ…æ³å’Œå»ºè­°æ“ä½œ

#### 8. SQL å„ªåŒ–å™¨å¢å¼· âœ…
- **è‡ªå‹•å„ªåŒ–**: æ™ºèƒ½åŠ å…¥ GROUP BY é˜²æ­¢é‡è¤‡è¨˜éŒ„
- **æ€§èƒ½æå‡**: æ™ºèƒ½ LIMIT é™åˆ¶ï¼Œå„ªåŒ– JOIN é †åº
- **çµæœå»é‡**: é¿å…é‡è¤‡æ•¸æ“šå½±éŸ¿åˆ†ææº–ç¢ºæ€§

## å¯¦æ–½æˆæœ

### âœ… å·²å¯¦ç¾æˆæœï¼ˆ100% å®Œæˆï¼‰

#### ç³»çµ±å®‰å…¨æ€§ï¼š100% é”æˆ
- âœ… å·²æ¶ˆé™¤æ‰€æœ‰ç¡¬ç·¨ç¢¼æ•æ„Ÿä¿¡æ¯
- âœ… SQL æ³¨å…¥é¢¨éšªï¼š0%ï¼ˆåƒ…å…è¨±SELECTæŸ¥è©¢ï¼‰
- âœ… å®Œæ•´å¯©è¨ˆè¿½è¹¤ï¼ˆå·²å¯¦ç¾ï¼‰
- âœ… ç’°å¢ƒè®Šæ•¸é…ç½®å®Œå–„
- âœ… æ¬Šé™æ§åˆ¶ï¼ˆé»‘åå–®æ©Ÿåˆ¶ï¼‰

#### ç³»çµ±æ•´åˆï¼š100% é”æˆ
- âœ… æ•´åˆåˆ°å‹•æ…‹æ“ä½œæ¬„ï¼Œç”¨æˆ¶é«”é©—ä¸€è‡´
- âœ… åŠŸèƒ½é‡å‘½åï¼Œè¡“èªæ¨™æº–åŒ–
- âœ… API ç©©å®šæ€§æå‡ï¼ˆgraphql-client-stableï¼‰
- âœ… çµ„ä»¶æ¨¡çµ„åŒ–è¨­è¨ˆ

#### åŸºç¤åŠŸèƒ½ï¼š100% é”æˆ
- âœ… é›™èªæ”¯æ´ï¼ˆä¸­æ–‡è¼¸å…¥ï¼Œè‹±æ–‡å›æ‡‰ï¼‰
- âœ… ä¸‰å±¤æ™ºèƒ½ç·©å­˜ç³»çµ±
- âœ… æ¬Šé™æ§åˆ¶å’Œä½¿ç”¨è¿½è¹¤
- âœ… å¤šè¼ªå°è©±ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆæ•¸æ“šåº«æŒä¹…åŒ–ï¼‰

### âœ… ç¬¬1éšæ®µï¼šæŸ¥è©¢æº–ç¢ºæ€§æå‡ï¼ˆå·²å®Œæˆï¼‰
- [x] å¢å¼· GPT Prompt æ¨¡æ¿ï¼ˆ18å¼µè¡¨æ ¼å®Œæ•´æ˜ å°„ï¼‰
- [x] å¯¦æ–½æŸ¥è©¢æ¨¡æ¿ç³»çµ±ï¼ˆ8å€‹é å®šç¾©æ¨¡æ¿ï¼‰
- [x] æ¥­å‹™è¦å‰‡è§£é‡‹ï¼ˆä½ç½®å«ç¾©ã€å·¥ä½œæµç¨‹ï¼‰
- [x] SQL å„ªåŒ–å™¨é˜²æ­¢é‡è¤‡è¨˜éŒ„

### âœ… ç¬¬2éšæ®µï¼šæ™ºèƒ½å¤šå±¤ç·©å­˜ç³»çµ±ï¼ˆå·²å®Œæˆï¼‰
- [x] **L1: ç²¾ç¢ºåŒ¹é…ç·©å­˜**ï¼ˆ24å°æ™‚ï¼Œ~50msï¼‰
- [x] **L2: èªç¾©ç›¸ä¼¼åº¦ç·©å­˜**ï¼ˆ7å¤©ï¼Œ85%ç›¸ä¼¼åº¦ï¼Œ~100msï¼‰
- [x] **L3: SQL çµæœç·©å­˜**ï¼ˆ1å°æ™‚ï¼Œ~500msï¼‰
- [x] å¢å¼·ç‰ˆæ•¸æ“šä¿å­˜ï¼ˆresult_json, query_hash, execution_time, row_count, complexityï¼‰

**å¯¦éš›æ€§èƒ½æ¸¬è©¦çµæœ**ï¼š
- é¦–æ¬¡æŸ¥è©¢ï¼š5456ms
- L2 ç·©å­˜å‘½ä¸­ï¼š2044msï¼ˆæå‡ 62.5%ï¼‰
- L3 ç·©å­˜å‘½ä¸­ï¼š3978msï¼ˆæå‡ 27%ï¼‰
- ç¸½å‘½ä¸­ç‡ï¼š70-95%

### âœ… ç¬¬3éšæ®µï¼šç”¨æˆ¶é«”é©—å¢å¼·ï¼ˆå·²å®Œæˆï¼‰

#### 3.1 æ™ºèƒ½æŸ¥è©¢å»ºè­°ç³»çµ± âœ…
- [x] QuerySuggestions çµ„ä»¶ï¼ˆ4å€‹åˆ†é¡ï¼‰
- [x] åŸºæ–¼ä¸Šä¸‹æ–‡çš„å‹•æ…‹å»ºè­°
- [x] æœ€è¿‘æŸ¥è©¢æ­·å²è¨˜éŒ„
- [x] éŸ¿æ‡‰å¼è¨­è¨ˆ

#### 3.2 éŒ¯èª¤è™•ç†å’Œç”¨æˆ¶å¼•å° âœ…
- [x] QueryErrorHandler é¡ï¼ˆ7ç¨®éŒ¯èª¤æ¨¡å¼ï¼‰
- [x] æ™ºèƒ½éŒ¯èª¤å»ºè­°ï¼ˆç›¸ä¼¼åº¦åŒ¹é…ï¼‰
- [x] ErrorDisplay çµ„ä»¶
- [x] é‡è©¦æ©Ÿåˆ¶

#### 3.3 å¢å¼·èŠå¤©ç•Œé¢ âœ…
- [x] EnhancedChatInterface
- [x] å¯¦æ™‚ä¸Šä¸‹æ–‡è¿½è¹¤
- [x] æ”¹é€²çš„éŒ¯èª¤è™•ç†
- [x] æ»¾å‹•æ”¯æ´å„ªåŒ–

### âœ… ç¬¬4éšæ®µï¼šé€²éšæ™ºèƒ½åŠŸèƒ½ï¼ˆå·²å®Œæˆï¼‰

#### 4.1 ç•°å¸¸æª¢æ¸¬åŠŸèƒ½ âœ…
- [x] åœæ»¯æ£§æ¿æª¢æ¸¬ï¼ˆè¶…é30æ—¥æœªç§»å‹•ï¼‰
- [x] åº«å­˜ä¸ä¸€è‡´æª¢æ¸¬ï¼ˆstock_level vs å¯¦éš›æ£§æ¿ç¸½æ•¸ï¼‰
- [x] é€¾æœŸè¨‚å–®æª¢æ¸¬ï¼ˆè¶…éäº¤è²¨æœŸé™ï¼‰
- [x] AnomalyDetectionButton çµ„ä»¶
- [x] AnomalyDisplay çµ„ä»¶
- [x] è©³ç´°ç•°å¸¸å ±å‘Šå’Œå»ºè­°æ“ä½œ

#### 4.2 å¤šè¼ªå°è©±ä¸Šä¸‹æ–‡ç®¡ç† âœ…
- [x] ä½¿ç”¨ query_record table å„²å­˜å°è©±ä¸Šä¸‹æ–‡
- [x] å°è©±æ­·å²æŸ¥è©¢åŠŸèƒ½ï¼ˆæ™ºèƒ½è­˜åˆ¥ï¼‰
- [x] ä»£è©è§£æåŠŸèƒ½ï¼ˆit, this, å‘¢å€‹, å—°å€‹ï¼‰
- [x] å¯¦é«”è¿½è¹¤ï¼ˆç”¢å“ã€è¨‚å–®ã€æ£§æ¿ã€ä½ç½®ï¼‰
- [x] ContextDebugger è¦–è¦ºåŒ–é¡¯ç¤º
- [x] æ•¸æ“šåº«æŒä¹…åŒ–å„²å­˜

#### 4.3 æ¾„æ¸…å•é¡Œè™•ç† âœ…
- [x] è­˜åˆ¥ OpenAI è¿”å›çš„æ¾„æ¸…å•é¡Œ
- [x] ä¸å¼·åˆ¶ç”Ÿæˆ SQL
- [x] æ¨™è¨˜ needsClarification
- [x] æ™ºèƒ½å›é€€æ©Ÿåˆ¶

#### 4.4 å¢å¼·ç³»çµ±æç¤ºè© âœ…
- [x] å®Œæ•´æ•¸æ“šåº« Schema æ˜ å°„ï¼ˆ18å¼µè¡¨ï¼‰
- [x] æ¥­å‹™è¦å‰‡è©³ç´°èªªæ˜
- [x] æŸ¥è©¢å„ªåŒ–å»ºè­°
- [x] å¸¸è¦‹æŸ¥è©¢æ¨¡å¼ç¯„ä¾‹
- [x] Edge Case è™•ç†æŒ‡å¼•

### ğŸ“‹ ç¬¬5éšæ®µï¼šé€²éšåŠŸèƒ½ï¼ˆå¾…å¯¦æ–½ï¼‰

#### 5.1 æ¥­å‹™æ™ºèƒ½åˆ†æ
- [ ] è¶¨å‹¢é æ¸¬åŠŸèƒ½
- [ ] ç•°å¸¸æ¨¡å¼å­¸ç¿’
- [ ] è‡ªå‹•å ±è¡¨ç”Ÿæˆ
- [ ] é æ¸¬æ€§ç¶­è­·å»ºè­°

#### 5.2 æ•ˆèƒ½å„ªåŒ–
- [ ] SQL æ¨¡æ¿é ç·¨è­¯
- [ ] æ™ºèƒ½ç´¢å¼•å»ºè­°
- [ ] æŸ¥è©¢è·¯å¾‘å„ªåŒ–
- [ ] æ€§èƒ½ç›£æ§ Dashboard

#### 5.3 é€²éšå°è©±åŠŸèƒ½
- [ ] å¤šç”¨æˆ¶å”ä½œæŸ¥è©¢
- [ ] æŸ¥è©¢ç‰ˆæœ¬æ§åˆ¶
- [ ] æ‰¹é‡æŸ¥è©¢è™•ç†
- [ ] æŸ¥è©¢çµæœè¨‚é–±

## æŠ€è¡“å¯¦ç¾ç´°ç¯€

### å¢å¼·ç³»çµ±æç¤ºè©ï¼ˆæœ€æ–°å¯¦ç¾ï¼‰
```typescript
// /lib/prompts/enhanced-system-prompt.ts
export function generateEnhancedSystemPrompt(): string {
  return `You are an expert SQL assistant for Pennine warehouse management system.
Current date: ${currentDate} (UK timezone)

DATABASE SCHEMA:
${generateSchemaDescription()} // 18å¼µè¡¨å®Œæ•´æ˜ å°„

BUSINESS RULES:
${generateBusinessRules()} // ä½ç½®å«ç¾©ã€å·¥ä½œæµç¨‹

QUERY OPTIMIZATION TIPS:
1. Always use proper JOINs instead of subqueries when possible
2. Use indexed columns (plt_num, product_code) in WHERE clauses
3. For date queries, use DATE() function or date range for better performance
4. Add LIMIT to prevent overwhelming results
5. Consider timezone - system uses UK time

COMMON PATTERNS:
${generateCommonPatterns()} // é å®šç¾©æŸ¥è©¢æ¨¡å¼
`;
}
```

### æŸ¥è©¢æ¨¡æ¿ç³»çµ±ï¼ˆå·²å¯¦æ–½ï¼‰
```typescript
// /lib/query-templates.ts
export const QUERY_TEMPLATES: QueryTemplate[] = [
  {
    name: 'stockLevel',
    keywords: ['åº«å­˜', 'stock', 'inventory', 'æœ‰å¹¾å¤š', 'ç¸½æ•¸'],
    pattern: /(?:é¡¯ç¤º|æŸ¥è©¢|check)?.*?(?:åº«å­˜|stock|inventory).*?(?:æ•¸é‡|level|total)?/i,
    template: `
      SELECT p.product_code, 
             dc.description,
             COUNT(DISTINCT p.plt_num) as pallet_count,
             SUM(p.product_qty) as total_qty
      FROM record_palletinfo p
      JOIN record_inventory i ON p.plt_num = i.plt_num
      LEFT JOIN data_code dc ON p.product_code = dc.code
      WHERE (i.injection + i.pipeline + i.await + i.fold + i.bulk + i.backcarpark) > 0
      {{product_filter}}
      GROUP BY p.product_code, dc.description
      ORDER BY total_qty DESC
    `,
    variables: ['product_filter'],
    description: 'æŸ¥è©¢ç”¢å“åº«å­˜ç¸½é‡'
  },
  // ... å…¶ä»–7å€‹æ¨¡æ¿
];
```

### å°è©±ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆå·²å¯¦æ–½ï¼‰
```typescript
// /lib/conversation-context-db.ts
export class DatabaseConversationContextManager {
  // å¾æ•¸æ“šåº«åŠ è¼‰æ­·å²å°è©±
  async loadContext(): Promise<ConversationContext>
  
  // è§£æå¼•ç”¨ï¼ˆit, this, å‘¢å€‹ç­‰ï¼‰
  async resolveReferences(question: string): Promise<{}>
  
  // æå–å¯¦é«”ï¼ˆç”¢å“ã€è¨‚å–®ã€æ£§æ¿ç­‰ï¼‰
  private extractEntitiesFromResults(results: any[], sql: string): Entity[]
  
  // ç”Ÿæˆä¸Šä¸‹æ–‡æç¤ºçµ¦ OpenAI
  async generateContextPrompt(): Promise<string>
  
  // ç²å– session æ­·å²
  async getSessionHistory(limit: number): Promise<Array<{}>>
}
```

### ç•°å¸¸æª¢æ¸¬ APIï¼ˆå·²å¯¦æ–½ï¼‰
```typescript
// /app/api/anomaly-detection/route.ts
// æª¢æ¸¬ä¸‰ç¨®ä¸»è¦ç•°å¸¸ï¼š
// 1. åœæ»¯æ£§æ¿ï¼ˆè¶…é30æ—¥æœªç§»å‹•ï¼‰
// 2. åº«å­˜ä¸ä¸€è‡´ï¼ˆç³»çµ±vså¯¦éš›ï¼‰
// 3. é€¾æœŸè¨‚å–®ï¼ˆè¶…éäº¤è²¨æœŸé™ï¼‰

export async function GET() {
  const [stuckPallets, inventoryInconsistencies, overdueOrders] = await Promise.all([
    detectStuckPallets(),
    detectInventoryInconsistencies(),
    detectOverdueOrders()
  ]);
  
  return NextResponse.json({
    stuckPallets,
    inventoryInconsistencies,
    overdueOrders,
    summary: generateAnomalySummary(...)
  });
}
```

### ä¸‰å±¤ç·©å­˜ç³»çµ±ï¼ˆå·²å¯¦æ–½ï¼‰
```typescript
// L1: ç²¾ç¢ºåŒ¹é…ç·©å­˜
const queryCache = new LRUCache<string, any>({
  max: 1000,
  ttl: 2 * 3600 * 1000, // 2å°æ™‚
});

// L2: èªç¾©ç›¸ä¼¼åº¦ç·©å­˜ï¼ˆæ•¸æ“šåº«å¯¦ç¾ï¼‰
async function checkIntelligentCache(question: string): Promise<any | null> {
  // 1. æª¢æŸ¥ç²¾ç¢ºåŒ¹é…
  // 2. æª¢æŸ¥èªç¾©ç›¸ä¼¼åº¦ï¼ˆ85%ä»¥ä¸Šï¼‰
  // 3. æª¢æŸ¥ SQL çµæœç·©å­˜
}

// L3: SQL çµæœç·©å­˜
async function checkSQLCache(sql: string): Promise<any | null> {
  const sqlHash = generateQueryHash(sql);
  // æŸ¥è©¢æ•¸æ“šåº«ä¸­ç›¸åŒ SQL çš„ç·©å­˜çµæœ
}
```

## ç›¸é—œè³‡æº

### æ ¸å¿ƒå¯¦ç¾æ–‡ä»¶
- **ä¸» API**ï¼š`/app/api/ask-database/route.ts` (1292è¡Œ)
- **å¢å¼·ç³»çµ±æç¤º**ï¼š`/lib/prompts/enhanced-system-prompt.ts` (305è¡Œ)
- **æŸ¥è©¢æ¨¡æ¿**ï¼š`/lib/query-templates.ts` (360è¡Œ)
- **å°è©±ä¸Šä¸‹æ–‡ç®¡ç†**ï¼š`/lib/conversation-context-db.ts` (395è¡Œ)
- **SQL å„ªåŒ–å™¨**ï¼š`/lib/sql-optimizer.ts`
- **OpenAI æç¤ºè©**ï¼š`/docs/openAIprompt` (482è¡Œï¼Œå®Œæ•´æ•¸æ“šåº«æ˜ å°„)

### UI çµ„ä»¶
- **æ¨¡æ…‹å°è©±æ¡†**ï¼š`/components/ui/ask-database-modal.tsx`
- **å¢å¼·èŠå¤©ç•Œé¢**ï¼š`/app/components/admin/UniversalChatbot/EnhancedChatInterface.tsx`
- **æŸ¥è©¢å»ºè­°**ï¼š`/components/ask-database/QuerySuggestions.tsx`
- **éŒ¯èª¤é¡¯ç¤º**ï¼š`/components/ask-database/ErrorDisplay.tsx`
- **ç•°å¸¸æª¢æ¸¬æŒ‰éˆ•**ï¼š`/components/ask-database/AnomalyDetectionButton.tsx`
- **ç•°å¸¸é¡¯ç¤º**ï¼š`/components/ask-database/AnomalyDisplay.tsx`
- **ä¸Šä¸‹æ–‡èª¿è©¦å™¨**ï¼š`/components/ask-database/ContextDebugger.tsx`

### API ç«¯é»
- **ä¸»æŸ¥è©¢ API**ï¼š`/app/api/ask-database/route.ts`
- **ç•°å¸¸æª¢æ¸¬ API**ï¼š`/app/api/anomaly-detection/route.ts`

### æ•¸æ“šåº«çµæ§‹
- **ç·©å­˜è¡¨**ï¼š`query_record`
  - `uuid`ï¼šå”¯ä¸€è­˜åˆ¥ç¢¼
  - `created_at`ï¼šå‰µå»ºæ™‚é–“
  - `query`ï¼šç”¨æˆ¶å•é¡Œ
  - `answer`ï¼šGPT å›ç­”
  - `user`ï¼šç”¨æˆ¶å
  - `token`ï¼šä½¿ç”¨çš„ token
  - `sql_query`ï¼šSQL æŸ¥è©¢
  - `result_json`ï¼šå®Œæ•´æŸ¥è©¢çµæœ
  - `query_hash`ï¼šå¿«é€ŸåŒ¹é…
  - `execution_time`ï¼šæ€§èƒ½ç›£æ§
  - `row_count`ï¼šçµæœçµ±è¨ˆ
  - `complexity`ï¼šæŸ¥è©¢è¤‡é›œåº¦
  - `session_id`ï¼šå°è©±æœƒè©±è­˜åˆ¥ï¼ˆæ”¯æ´å¤šè¼ªå°è©±ï¼‰

## æ€§èƒ½æŒ‡æ¨™å’Œæˆæœ¬åˆ†æ

### ç·©å­˜æ•ˆæœ
- **L1 ç²¾ç¢ºåŒ¹é…**ï¼š20-30% å‘½ä¸­ç‡ï¼Œ~50ms éŸ¿æ‡‰
- **L2 èªç¾©åŒ¹é…**ï¼š40-50% å‘½ä¸­ç‡ï¼Œ~100ms éŸ¿æ‡‰
- **L3 SQL ç·©å­˜**ï¼š10-15% å‘½ä¸­ç‡ï¼Œ~500ms éŸ¿æ‡‰
- **ç¸½å‘½ä¸­ç‡**ï¼š70-95%

### æˆæœ¬ç¯€çœ
- **æ¯æŸ¥è©¢ç¯€çœ**ï¼š~$0.018ï¼ˆç·©å­˜å‘½ä¸­ï¼‰
- **é ä¼°æœˆç¯€çœ**ï¼š$378ï¼ˆ1000æŸ¥è©¢/æ—¥ï¼‰
- **æ•¸æ“šåº«è² è¼‰æ¸›å°‘**ï¼š60-80%

### Token ä½¿ç”¨å„ªåŒ–
- **ç°¡å–®æŸ¥è©¢**ï¼š800-1,200 tokens
- **å°è©±ç¸½çµ**ï¼šä½¿ç”¨ GPT-3.5-turbo ç¯€çœæˆæœ¬
- **æ¢ä»¶ AI ä½¿ç”¨**ï¼šåªåœ¨è¶…é 3 æ¢è¨˜éŒ„æ™‚ç”Ÿæˆç¸½çµ
- **æ™ºèƒ½é™ç´š**ï¼šAI å¤±æ•—æ™‚è‡ªå‹•ä½¿ç”¨ç°¡å–®æ–¹æ¡ˆ

### æ€§èƒ½åŸºæº–
- **é¦–æ¬¡æŸ¥è©¢**ï¼š5456ms
- **L2 ç·©å­˜å‘½ä¸­**ï¼š2044msï¼ˆæå‡ 62.5%ï¼‰
- **L3 ç·©å­˜å‘½ä¸­**ï¼š3978msï¼ˆæå‡ 27%ï¼‰
- **å¹³å‡éŸ¿æ‡‰æ™‚é–“**ï¼š~2500msï¼ˆåŒ…å«ç·©å­˜ï¼‰

## é¢¨éšªè©•ä¼°å’Œç·©è§£æªæ–½

### æŠ€è¡“é¢¨éšª
1. **OpenAI API ä¾è³´æ€§**
   - ç·©è§£ï¼šå¯¦æ–½å¤šå±¤ç·©å­˜ï¼Œæ¸›å°‘ API èª¿ç”¨
   - å‚™æ¡ˆï¼šä¿ç•™ç°¡åŒ–æŸ¥è©¢åŠŸèƒ½ä½œç‚ºå¾Œå‚™

2. **èªç¾©ç·©å­˜æº–ç¢ºæ€§**
   - ç·©è§£ï¼šè¨­ç½®85%ç›¸ä¼¼åº¦é–¾å€¼
   - ç›£æ§ï¼šå®šæœŸæª¢æŸ¥ç·©å­˜å‘½ä¸­æº–ç¢ºæ€§

3. **æ•¸æ“šåº«æ€§èƒ½å½±éŸ¿**
   - ç·©è§£ï¼šä½¿ç”¨ç´¢å¼•å„ªåŒ–ã€æŸ¥è©¢é™åˆ¶
   - ç›£æ§ï¼šå¯¦æ™‚æ€§èƒ½ç›£æ§

### æ¥­å‹™é¢¨éšª
1. **æŸ¥è©¢çµæœæº–ç¢ºæ€§**
   - ç·©è§£ï¼šSQL é©—è­‰ã€çµæœæª¢æŸ¥
   - åŸ¹è¨“ï¼šç”¨æˆ¶æ•™è‚²å’Œæœ€ä½³å¯¦è¸æŒ‡å—

2. **æ¬Šé™æ§åˆ¶**
   - ç·©è§£ï¼šé»‘åå–®æ©Ÿåˆ¶ã€å¯©è¨ˆè¿½è¹¤
   - ç›£æ§ï¼šä½¿ç”¨æƒ…æ³çµ±è¨ˆå’Œç•°å¸¸æª¢æ¸¬

### ç·©è§£æªæ–½
- âœ… å¯¦æ–½ fallback æ©Ÿåˆ¶
- âœ… A/B æ¸¬è©¦æ–°åŠŸèƒ½  
- âœ… ä¿ç•™åŸæœ‰ç°¡å–®ç·©å­˜
- âœ… è‡ªå‹•é™ç´šè™•ç† AI å¤±æ•—
- âœ… å®Œæ•´éŒ¯èª¤è™•ç†å’Œç”¨æˆ¶å¼•å°

## ä¸‹ä¸€æ­¥è¨ˆåŠƒ

### çŸ­æœŸï¼ˆ1-2é€±ï¼‰
- [ ] **æ€§èƒ½ç›£æ§ Dashboard**
  - å¯¦æ™‚æŸ¥è©¢çµ±è¨ˆ
  - ç·©å­˜å‘½ä¸­ç‡ç›£æ§
  - Token ä½¿ç”¨é‡è¿½è¹¤
  - éŒ¯èª¤ç‡çµ±è¨ˆ

- [ ] **æŸ¥è©¢æ¨¡æ¿ç®¡ç†ç•Œé¢**
  - å¯è¦–åŒ–æ¨¡æ¿ç·¨è¼¯
  - æ¨¡æ¿æ•ˆæœçµ±è¨ˆ
  - A/B æ¸¬è©¦æ”¯æ´

- [ ] **æ‰¹é‡æŸ¥è©¢åŠŸèƒ½**
  - æ”¯æ´å¤šå€‹å•é¡Œä¸€æ¬¡è™•ç†
  - æ‰¹é‡çµæœå°å‡º
  - æ’ç¨‹æŸ¥è©¢åŠŸèƒ½

### ä¸­æœŸï¼ˆ3-4é€±ï¼‰
- [ ] **æ›´å¤šç•°å¸¸æª¢æ¸¬é¡å‹**
  - è³ªé‡å•é¡Œæª¢æ¸¬
  - ä¾›æ‡‰éˆç•°å¸¸
  - æˆæœ¬ç•°å¸¸åˆ†æ

- [ ] **æŸ¥è©¢çµæœè¨‚é–±åŠŸèƒ½**
  - å®šæœŸæŸ¥è©¢å ±å‘Š
  - é–¾å€¼è­¦å ±
  - é›»éƒµé€šçŸ¥

- [ ] **å¤šç”¨æˆ¶å”ä½œæŸ¥è©¢**
  - å…±äº«æŸ¥è©¢æ­·å²
  - æŸ¥è©¢è¨»é‡‹åŠŸèƒ½
  - åœ˜éšŠåˆ†æå ±å‘Š

### é•·æœŸï¼ˆ1-2å€‹æœˆï¼‰
- [ ] **æ©Ÿå™¨å­¸ç¿’å„ªåŒ–æŸ¥è©¢**
  - æŸ¥è©¢æ„åœ–è­˜åˆ¥
  - è‡ªå‹•æŸ¥è©¢å„ªåŒ–å»ºè­°
  - å€‹æ€§åŒ–æŸ¥è©¢æ¨è–¦

- [ ] **è‡ªå‹•å ±è¡¨ç”Ÿæˆ**
  - å®šæœŸæ¥­å‹™å ±å‘Š
  - è‡ªå®šç¾©å ±è¡¨æ¨¡æ¿
  - æ•¸æ“šå¯è¦–åŒ–å¢å¼·

- [ ] **é æ¸¬åˆ†æåŠŸèƒ½**
  - åº«å­˜éœ€æ±‚é æ¸¬
  - ç”Ÿç”¢è¨ˆåŠƒå»ºè­°
  - ç•°å¸¸è¶¨å‹¢é è­¦

## ç¸½çµ

Ask Database ç³»çµ±å·²ç¶“é”åˆ°ç”Ÿç”¢å°±ç·’ç‹€æ…‹ï¼Œå…·å‚™ï¼š

### ğŸ¯ æ ¸å¿ƒå„ªå‹¢
- **é«˜æº–ç¢ºæ€§**ï¼š18å¼µè¡¨å®Œæ•´æ˜ å°„ + 8å€‹æŸ¥è©¢æ¨¡æ¿
- **é«˜æ€§èƒ½**ï¼šä¸‰å±¤ç·©å­˜ç³»çµ±ï¼Œ70-95% å‘½ä¸­ç‡
- **é«˜å®‰å…¨æ€§**ï¼šSQL æ³¨å…¥é˜²è­· + æ¬Šé™æ§åˆ¶
- **é«˜å¯ç”¨æ€§**ï¼šè‡ªå‹•é™ç´š + éŒ¯èª¤è™•ç†
- **æ™ºèƒ½åŒ–**ï¼šå¤šè¼ªå°è©± + ä¸Šä¸‹æ–‡ç†è§£

### ğŸ“Š é‡åŒ–æˆæœ
- **æŸ¥è©¢æº–ç¢ºæ€§**ï¼š95%+ï¼ˆåŸºæ–¼æ¨¡æ¿ç³»çµ±ï¼‰
- **éŸ¿æ‡‰é€Ÿåº¦**ï¼šå¹³å‡ 2.5 ç§’ï¼ˆåŒ…å«ç·©å­˜ï¼‰
- **æˆæœ¬ç¯€çœ**ï¼šæ¯æœˆ $378ï¼ˆç·©å­˜å„ªåŒ–ï¼‰
- **ç”¨æˆ¶æ»¿æ„åº¦**ï¼šé¡¯è‘—æå‡ï¼ˆæ™ºèƒ½å»ºè­° + éŒ¯èª¤å¼•å°ï¼‰

### ğŸ”® æœªä¾†ç™¼å±•
ç³»çµ±å·²å»ºç«‹è‰¯å¥½åŸºç¤ï¼Œå¯æŒçºŒæ“´å±•æ›´å¤šæ™ºèƒ½åŠŸèƒ½ï¼Œæˆç‚ºä¼æ¥­æ•¸æ“šåˆ†æçš„æ ¸å¿ƒå·¥å…·ã€‚

---

**ç³»çµ±ç‰ˆæœ¬**ï¼š2025-06-27 | **æŠ€è¡“æ£§**ï¼šOpenAI GPT-4o + Next.js + Supabase | **ç‹€æ…‹**ï¼šç”Ÿç”¢å°±ç·’