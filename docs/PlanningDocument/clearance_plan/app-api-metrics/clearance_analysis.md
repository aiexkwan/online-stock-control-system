# ç³»çµ±æ¸…ç†åˆ†æå ±å‘Šï¼š/app/api/metrics

**åˆ†ææ—¥æœŸ**: 2025-08-30
**ç›®æ¨™è·¯å¾‘**: `/app/api/metrics`
**åˆ†æé¡å‹**: å¾ªåºæ·±åº¦æ¸…ç†åˆ†æ

## åŸ·è¡Œæ‘˜è¦

### èƒŒæ™¯

- å·²å®Œæˆæ¸…ç†ï¼š`/app/api/metrics/business` å’Œ `/app/api/metrics/database` å­ç›®éŒ„
- ç•¶å‰ä»»å‹™ï¼šåˆ†æ `/app/api/metrics` ç›®éŒ„çš„å‰©é¤˜å…§å®¹
- æ ¸å¿ƒå•é¡Œï¼šå‰©é¤˜çš„ metrics ç›®éŒ„å…§å®¹æ˜¯å¦çœŸæ­£è¢«ä½¿ç”¨ï¼Ÿå¯å¦å®‰å…¨åˆªé™¤ï¼Ÿ

---

## ç¬¬1æ­¥ï¼šéœæ…‹åˆ†æ

_åŸ·è¡Œè€…ï¼šcode-reviewer_

### 1.1 ç›®éŒ„çµæ§‹æª¢æŸ¥

```
app/api/metrics/
â””â”€â”€ route.ts (3054 bytes)
```

**ç™¼ç¾**ï¼š

- ç›®éŒ„åƒ…å‰©ä¸€å€‹æª”æ¡ˆ `route.ts`
- å­ç›®éŒ„ `/business` å’Œ `/database` å·²è¢«æ¸…ç†
- æª”æ¡ˆå¤§å°ï¼š3054 bytesï¼Œç´„106è¡Œä»£ç¢¼

### 1.2 æª”æ¡ˆå±¬æ€§åˆ†æ

**æª”æ¡ˆåŠŸèƒ½**ï¼š

- æä¾› API ç‰ˆæœ¬ä½¿ç”¨çµ±è¨ˆ
- ç³»çµ±å¥åº·æª¢æŸ¥å’ŒæŒ‡æ¨™æ”¶é›†
- æ”¯æ´ GETï¼ˆç²å–çµ±è¨ˆï¼‰ã€DELETEï¼ˆæ¸…é™¤çµ±è¨ˆï¼‰ã€HEADï¼ˆå¿«é€Ÿå¥åº·æª¢æŸ¥ï¼‰

**æŠ€è¡“ç‰¹å¾µ**ï¼š

- å°å…¥ `@/lib/middleware/apiVersioning` çš„ `getVersionStats` å’Œ `clearVersionStats`
- æä¾›ç‰ˆæœ¬åˆ†ä½ˆã€éŒ¯èª¤ç‡ã€ç³»çµ±æŒ‡æ¨™ç­‰è³‡è¨Š
- Migration Date: 2025-08-11ï¼ˆæ•´åˆè‡ªv1ï¼‰

### 1.3 æŠ€è¡“å‚µå‹™ç‰¹å¾µ

**è­˜åˆ¥æ¨™è¨˜**ï¼š

- âœ… æœ‰é·ç§»è¨»é‡‹ï¼šã€ŒConsolidated from v1 - API usage and version statisticsã€
- âœ… åŠŸèƒ½é‡è¤‡ï¼šç‰ˆæœ¬çµ±è¨ˆåŠŸèƒ½å¯èƒ½èˆ‡å…¶ä»–ç›£æ§ç³»çµ±é‡ç–Š
- âš ï¸ ä½ä½¿ç”¨ç‡ï¼šç„¡æ¸¬è©¦è¦†è“‹ï¼Œç„¡å¯¦éš›èª¿ç”¨è­‰æ“š

### 1.4 æ¸…ç†å°è±¡è­˜åˆ¥

**ç¬¦åˆæ¸…ç†æ¨™æº–**ï¼š

- âœ… å·²é·ç§»åŠŸèƒ½ï¼ˆå¾v1æ•´åˆï¼‰
- âœ… ç„¡æ¸¬è©¦è¦†è“‹
- âœ… ç„¡å¯¦éš›ä½¿ç”¨è­‰æ“š
- âš ï¸ ä½†æä¾›ç³»çµ±ç›£æ§åŠŸèƒ½

---

## ç¬¬2æ­¥ï¼šä¾è³´åˆ†æ

_åŸ·è¡Œè€…ï¼šfrontend-developer & backend-architect_

### 2.1 ä»£ç¢¼å¼•ç”¨è¿½è¹¤

**ç›´æ¥å¼•ç”¨æª¢æŸ¥**ï¼š

- `/api/metrics` ç«¯é»è¢«å¼•ç”¨æ–¼ï¼š
  - `middleware.ts` - å…¬é–‹APIè·¯å¾‘åˆ—è¡¨ä¸­
  - `lib/middleware/apiRedirects.ts` - v1åˆ°ä¸»ç‰ˆæœ¬çš„é‡å®šå‘æ˜ å°„
  - `lib/security/security-middleware.ts` - å®‰å…¨ä¸­é–“ä»¶è±å…è·¯å¾‘

**å‡½æ•¸ä¾è³´**ï¼š

- `getVersionStats()` - åƒ…è¢« `app/api/metrics/route.ts` ä½¿ç”¨
- `clearVersionStats()` - åƒ…è¢« `app/api/metrics/route.ts` ä½¿ç”¨
- é€™å…©å€‹å‡½æ•¸å®šç¾©åœ¨ `lib/middleware/apiVersioning.ts`

### 2.2 è·¯ç”±èˆ‡ä¸­é–“ä»¶ä¾è³´

**ä¸­é–“ä»¶é…ç½®**ï¼š

```typescript
// middleware.ts
publicApiPaths: [
  '/api/metrics', // Consolidated metrics API (2025-08-11)
  ...
]
```

**APIé‡å®šå‘**ï¼š

```typescript
// lib/middleware/apiRedirects.ts
'/api/v1/metrics': '/api/metrics'
```

### 2.3 é…ç½®æ–‡ä»¶å¼•ç”¨

**ç„¡ç›´æ¥é…ç½®ä¾è³´**ï¼š

- æœªåœ¨ç’°å¢ƒè®Šé‡ä¸­ç™¼ç¾ç›¸é—œé…ç½®
- æœªåœ¨ `next.config.js` ä¸­ç™¼ç¾ç‰¹æ®Šé…ç½®

### 2.4 GraphQLç³»çµ±ä¾è³´

**GraphQLæ•´åˆç‹€æ³**ï¼š

- âŒ ç„¡GraphQL schemaå®šç¾©
- âŒ ç„¡GraphQL resolverå¼•ç”¨
- âŒ å®Œå…¨ç¨ç«‹æ–¼GraphQLç³»çµ±

---

## ç¬¬3æ­¥ï¼šé‹è¡Œæ™‚åˆ†æ

_åŸ·è¡Œè€…ï¼štest-automator & error-detective_

### 3.1 é‹è¡Œæ™‚å½±éŸ¿è©•ä¼°

**ç«¯é»åŠŸèƒ½åˆ†æ**ï¼š

- GET /api/metrics - è¿”å›ç³»çµ±æŒ‡æ¨™å’Œç‰ˆæœ¬çµ±è¨ˆ
- DELETE /api/metrics - æ¸…é™¤ç‰ˆæœ¬çµ±è¨ˆï¼ˆé–‹ç™¼ç”¨é€”ï¼‰
- HEAD /api/metrics - å¿«é€Ÿå¥åº·æª¢æŸ¥

**æ½›åœ¨å½±éŸ¿**ï¼š

- ç„¡å‰ç«¯çµ„ä»¶ç›´æ¥èª¿ç”¨æ­¤ç«¯é»
- å¯èƒ½è¢«å¤–éƒ¨ç›£æ§ç³»çµ±ä½¿ç”¨
- æä¾›ç³»çµ±å¥åº·ç‹€æ…‹ä¿¡æ¯

### 3.2 æ¸¬è©¦è¦†è“‹åˆ†æ

**æ¸¬è©¦ç‹€æ³**ï¼š

- âŒ ç„¡å–®å…ƒæ¸¬è©¦
- âŒ ç„¡æ•´åˆæ¸¬è©¦
- âŒ ç„¡E2Eæ¸¬è©¦è¦†è“‹
- âŒ `getVersionStats` å’Œ `clearVersionStats` ç„¡æ¸¬è©¦

**é¢¨éšªè©•ä¼°**ï¼š

- ä½é¢¨éšªï¼šåŠŸèƒ½ç°¡å–®ï¼Œä¸»è¦æ˜¯æ•¸æ“šèšåˆ
- ç„¡é—œéµæ¥­å‹™é‚è¼¯

### 3.3 éŒ¯èª¤æ—¥èªŒæª¢æŸ¥

**éŒ¯èª¤è™•ç†**ï¼š

- æœ‰åŸºæœ¬çš„ try-catch éŒ¯èª¤è™•ç†
- éŒ¯èª¤æ™‚è¿”å› 500 ç‹€æ…‹ç¢¼
- åŒ…å« correlationId ç”¨æ–¼è¿½è¹¤

**æ—¥èªŒè¨˜éŒ„**ï¼š

- ä½¿ç”¨ console.error è¨˜éŒ„éŒ¯èª¤
- ç„¡çµæ§‹åŒ–æ—¥èªŒæ•´åˆ

---

## ç¬¬4æ­¥ï¼šå½±éŸ¿è©•ä¼°

_åŸ·è¡Œè€…ï¼šsecurity-auditor & performance-engineer_

### 4.1 å®‰å…¨å½±éŸ¿è©•ä¼°

**å®‰å…¨é…ç½®**ï¼š

- ç«¯é»åœ¨ `publicApiPaths` ä¸­ï¼Œç„¡éœ€èªè­‰
- æš´éœ²ç³»çµ±å…§éƒ¨æŒ‡æ¨™ï¼ˆmemoryã€cpuä½¿ç”¨ï¼‰
- DELETE ç«¯é»ç„¡æ¬Šé™æ§åˆ¶ï¼ˆåƒ…é–‹ç™¼ç”¨é€”ï¼‰

**å®‰å…¨é¢¨éšª**ï¼š

- ä½é¢¨éšªï¼šåªè®€å–çµ±è¨ˆæ•¸æ“š
- æ½›åœ¨ä¿¡æ¯æ´©éœ²ï¼šæš´éœ²ç³»çµ±è³‡æºä½¿ç”¨æƒ…æ³
- DELETE ç«¯é»æ‡‰æœ‰ç’°å¢ƒæª¢æŸ¥

### 4.2 æ€§èƒ½å½±éŸ¿åˆ†æ

**æ€§èƒ½ç‰¹å¾µ**ï¼š

- ä½¿ç”¨å…§å­˜çµ±è¨ˆï¼ˆMapçµæ§‹ï¼‰
- ç„¡æ•¸æ“šåº«æŸ¥è©¢
- è¼•é‡ç´šè¨ˆç®—
- éŸ¿æ‡‰æ™‚é–“å¿«é€Ÿ

**åˆªé™¤å½±éŸ¿**ï¼š

- âœ… ç„¡æ€§èƒ½å½±éŸ¿
- âœ… æ¸›å°‘å…§å­˜ä½¿ç”¨ï¼ˆç§»é™¤çµ±è¨ˆMapï¼‰
- âœ… æ¸›å°‘ä»£ç¢¼ç¶­è­·è² æ“”

### 4.3 ç³»çµ±ç©©å®šæ€§è©•ä¼°

**ä¾è³´ç©©å®šæ€§**ï¼š

- åƒ…ä¾è³´ `apiVersioning.ts` çš„å…©å€‹å‡½æ•¸
- é€™å…©å€‹å‡½æ•¸åƒ…è¢«æ­¤ç«¯é»ä½¿ç”¨
- åˆªé™¤ä¸æœƒå½±éŸ¿å…¶ä»–ç³»çµ±åŠŸèƒ½

**ç›£æ§å½±éŸ¿**ï¼š

- å¯èƒ½å½±éŸ¿å¤–éƒ¨ç›£æ§å·¥å…·ï¼ˆå¦‚æœ‰ï¼‰
- å»ºè­°ç¢ºèªç„¡å¤–éƒ¨ä¾è³´å¾Œå†åˆªé™¤

---

## ç¬¬5æ­¥ï¼šç¶œåˆåˆ†æå ±å‘Š

_åŸ·è¡Œè€…ï¼šdocs-architect_

### 5.1 é—œéµç™¼ç¾

**æŠ€è¡“å‚µå‹™è­‰æ“š**ï¼š

1. **é·ç§»éºç•™**ï¼š2025-08-11 å¾ v1 æ•´åˆï¼Œå±¬æ–¼APIç‰ˆæœ¬é·ç§»çš„ä¸€éƒ¨åˆ†
2. **é›¶ä½¿ç”¨ç‡**ï¼šç„¡å‰ç«¯èª¿ç”¨ï¼Œç„¡æ¸¬è©¦è¦†è“‹
3. **åŠŸèƒ½é‡è¤‡**ï¼šç‰ˆæœ¬çµ±è¨ˆåŠŸèƒ½èˆ‡ `apiVersioning.ts` ç·Šå¯†è€¦åˆ
4. **ç¨ç«‹æ€§é«˜**ï¼šèˆ‡æ ¸å¿ƒæ¥­å‹™ç³»çµ±ç„¡é—œè¯

**ä¾è³´é—œä¿‚**ï¼š

- è¢«å¼•ç”¨ï¼š3å€‹é…ç½®æ–‡ä»¶ï¼ˆmiddlewareã€redirectã€securityï¼‰
- ä¾è³´å‡½æ•¸ï¼š2å€‹ï¼ˆåƒ…è¢«æ­¤ç«¯é»ä½¿ç”¨ï¼‰
- GraphQLï¼šå®Œå…¨ç„¡é—œ

### 5.2 é¢¨éšªè©•ä¼°

| é¢¨éšªé¡åˆ¥ | ç­‰ç´š | èªªæ˜               |
| -------- | ---- | ------------------ |
| æ¥­å‹™å½±éŸ¿ | ä½   | ç„¡æ¥­å‹™é‚è¼¯ä¾è³´     |
| æŠ€è¡“é¢¨éšª | ä½   | ç¨ç«‹ç«¯é»ï¼Œåˆªé™¤ç°¡å–® |
| å®‰å…¨é¢¨éšª | ä¸­   | æš´éœ²ç³»çµ±å…§éƒ¨ä¿¡æ¯   |
| ç›£æ§å½±éŸ¿ | ä¸­   | å¯èƒ½æœ‰å¤–éƒ¨ç›£æ§ä¾è³´ |

### 5.3 å»ºè­°æ±ºç­–

**æ¸…ç†å»ºè­°ï¼šå¯ä»¥å®‰å…¨åˆªé™¤** âœ…

**ç†ç”±**ï¼š

1. ç¬¦åˆæ‰€æœ‰æŠ€è¡“å‚µå‹™æ¸…ç†æ¨™æº–
2. ç„¡å¯¦éš›æ¥­å‹™ä½¿ç”¨
3. å®‰å…¨é¢¨éšªï¼ˆæš´éœ²ç³»çµ±ä¿¡æ¯ï¼‰
4. ç¶­è­·æˆæœ¬å¤§æ–¼åƒ¹å€¼

**åˆªé™¤ç¯„åœ**ï¼š

1. `app/api/metrics/route.ts`
2. `lib/middleware/apiVersioning.ts` ä¸­çš„ï¼š
   - `getVersionStats()`
   - `clearVersionStats()`
   - `versionStats` Map
   - `recordVersionUsage()` ï¼ˆå¦‚ç„¡å…¶ä»–ä½¿ç”¨ï¼‰
3. ç›¸é—œé…ç½®å¼•ç”¨ï¼ˆ3è™•ï¼‰

---

## ç¬¬6æ­¥ï¼šæ–‡æª”å¯©æ ¸

_åŸ·è¡Œè€…ï¼šdocumentation-normalizer_

### 6.1 æ–‡æª”å®Œæ•´æ€§æª¢æŸ¥

**åˆ†æå®Œæ•´æ€§**ï¼š

- âœ… éœæ…‹åˆ†æï¼šå®Œæˆæª”æ¡ˆçµæ§‹å’Œå±¬æ€§æª¢æŸ¥
- âœ… ä¾è³´åˆ†æï¼šè¿½è¹¤æ‰€æœ‰å¼•ç”¨å’Œä¾è³´
- âœ… é‹è¡Œæ™‚åˆ†æï¼šè©•ä¼°æ¸¬è©¦å’ŒéŒ¯èª¤è™•ç†
- âœ… å½±éŸ¿è©•ä¼°ï¼šå®‰å…¨ã€æ€§èƒ½ã€ç©©å®šæ€§è©•ä¼°
- âœ… ç¶œåˆå ±å‘Šï¼šæä¾›æ˜ç¢ºæ±ºç­–å»ºè­°

### 6.2 æ±ºç­–ä¾æ“šé©—è­‰

**é—œéµç™¼ç¾é©—è­‰**ï¼š

- âœ… **recordVersionUsage** è¢« middleware.ts ä½¿ç”¨ï¼ˆéœ€ä¿ç•™ï¼‰
- âœ… å…¶ä»–çµ±è¨ˆå‡½æ•¸åƒ…è¢« metrics/route.ts ä½¿ç”¨
- âœ… ç„¡æ¥­å‹™é‚è¼¯ä¾è³´
- âœ… ç¬¦åˆæŠ€è¡“å‚µå‹™æ¸…ç†æ¨™æº–

### 6.3 æœ€çµ‚å»ºè­°

## ğŸ¯ **æœ€çµ‚æ±ºç­–ï¼šéƒ¨åˆ†åˆªé™¤**

### åˆªé™¤æ¸…å–®ï¼š

1. **åˆªé™¤æª”æ¡ˆ**ï¼š
   - `app/api/metrics/route.ts`

2. **åˆªé™¤å‡½æ•¸**ï¼ˆå¾ `lib/middleware/apiVersioning.ts`ï¼‰ï¼š
   - `getVersionStats()`
   - `clearVersionStats()`
   - `versionStats` Map è®Šé‡
   - ç›¸é—œçš„ `VersionStats` interfaceï¼ˆç¬¬321-327è¡Œï¼‰

3. **ä¿ç•™å‡½æ•¸**ï¼š
   - âš ï¸ **ä¿ç•™** `recordVersionUsage()` - è¢« middleware.ts ä½¿ç”¨

4. **æ›´æ–°é…ç½®**ï¼š
   - å¾ `middleware.ts` ç§»é™¤ `/api/metrics` è·¯å¾‘
   - å¾ `lib/middleware/apiRedirects.ts` ç§»é™¤é‡å®šå‘
   - å¾ `lib/security/security-middleware.ts` ç§»é™¤è±å…è·¯å¾‘

### åŸ·è¡Œå„ªå…ˆç´šï¼š

1. é«˜å„ªå…ˆç´šï¼šåˆªé™¤ route.ts å’Œç›¸é—œé…ç½®
2. ä¸­å„ªå…ˆç´šï¼šæ¸…ç† apiVersioning.ts ä¸­çš„æœªä½¿ç”¨å‡½æ•¸
3. ä½å„ªå…ˆç´šï¼šå„ªåŒ– recordVersionUsage çš„å¯¦ç¾ï¼ˆå¯é¸ï¼‰

---

## é™„éŒ„

### A. è©³ç´°æª”æ¡ˆæ¸…å–®

```
app/api/metrics/
â””â”€â”€ route.ts (106è¡Œï¼Œ3054 bytes)
    â”œâ”€â”€ GET /api/metrics - ç³»çµ±æŒ‡æ¨™
    â”œâ”€â”€ DELETE /api/metrics - æ¸…é™¤çµ±è¨ˆ
    â””â”€â”€ HEAD /api/metrics - å¥åº·æª¢æŸ¥
```

### B. ä¾è³´é—œä¿‚åœ–

```mermaid
graph TD
    A[app/api/metrics/route.ts] --> B[lib/middleware/apiVersioning.ts]
    B --> C[getVersionStats]
    B --> D[clearVersionStats]
    B --> E[recordVersionUsage]
    B --> F[versionStats Map]

    G[middleware.ts] --> E
    G --> A
    H[lib/middleware/apiRedirects.ts] --> A
    I[lib/security/security-middleware.ts] --> A

    style A fill:#ff9999
    style C fill:#ffcccc
    style D fill:#ffcccc
    style F fill:#ffcccc
    style E fill:#90EE90
```

### C. åŸ·è¡Œè¨˜éŒ„

| æ™‚é–“             | æ“ä½œ         | çµæœ               |
| ---------------- | ------------ | ------------------ |
| 2025-08-30 16:20 | å»ºç«‹åˆ†æå ±å‘Š | âœ…                 |
| 2025-08-30 16:21 | éœæ…‹åˆ†æ     | âœ… ç™¼ç¾1å€‹æª”æ¡ˆ     |
| 2025-08-30 16:22 | ä¾è³´åˆ†æ     | âœ… ç™¼ç¾3å€‹é…ç½®å¼•ç”¨ |
| 2025-08-30 16:23 | é‹è¡Œæ™‚åˆ†æ   | âœ… ç„¡æ¸¬è©¦è¦†è“‹      |
| 2025-08-30 16:24 | å½±éŸ¿è©•ä¼°     | âœ… ä½é¢¨éšª          |
| 2025-08-30 16:25 | ç¶œåˆå ±å‘Š     | âœ… å»ºè­°éƒ¨åˆ†åˆªé™¤    |
| 2025-08-30 16:26 | æ–‡æª”å¯©æ ¸     | âœ… å®Œæˆ            |

### D. æ¸…ç†åŸ·è¡Œè…³æœ¬ï¼ˆå»ºè­°ï¼‰

```bash
#!/bin/bash
# æ¸…ç† /app/api/metrics æŠ€è¡“å‚µå‹™

# 1. å‚™ä»½
mkdir -p Backup/metrics-cleanup-$(date +%Y%m%d_%H%M%S)
cp -r app/api/metrics Backup/metrics-cleanup-$(date +%Y%m%d_%H%M%S)/
cp lib/middleware/apiVersioning.ts Backup/metrics-cleanup-$(date +%Y%m%d_%H%M%S)/

# 2. åˆªé™¤ä¸»æª”æ¡ˆ
rm -rf app/api/metrics

# 3. æ¸…ç†é…ç½®ï¼ˆéœ€æ‰‹å‹•ç·¨è¼¯ï¼‰
echo "è«‹æ‰‹å‹•ç·¨è¼¯ä»¥ä¸‹æª”æ¡ˆï¼š"
echo "- middleware.ts: ç§»é™¤ '/api/metrics' å¾ publicApiPaths"
echo "- lib/middleware/apiRedirects.ts: ç§»é™¤ '/api/v1/metrics' é‡å®šå‘"
echo "- lib/security/security-middleware.ts: ç§»é™¤ç›¸é—œè±å…"
echo "- lib/middleware/apiVersioning.ts: ç§»é™¤æœªä½¿ç”¨çš„çµ±è¨ˆå‡½æ•¸"

# 4. é©—è­‰
npm run typecheck
npm run build
```
