# ğŸ“š RPC å‡½æ•¸åº«ç´¢å¼•

> æœ€å¾Œæ›´æ–°ï¼š2025-08-05

## ç›®éŒ„

- [æ£§æ¿ç®¡ç†](#æ£§æ¿ç®¡ç†)
- [åº«å­˜ç®¡ç†](#åº«å­˜ç®¡ç†)
- [è¨‚å–®è™•ç†](#è¨‚å–®è™•ç†)
- [å ±è¡¨ç”Ÿæˆ](#å ±è¡¨ç”Ÿæˆ)
- [ç³»çµ±ç¶­è­·](#ç³»çµ±ç¶­è­·)

---

## æ£§æ¿ç®¡ç†

### ğŸ”§ generate_atomic_pallet_numbers_v6

ç”Ÿæˆå”¯ä¸€çš„æ‰˜ç›¤ç·¨è™Ÿå’Œç³»åˆ—ï¼Œä½¿ç”¨é ç”Ÿæˆçš„ç·©è¡æ± ã€‚

- **åƒæ•¸**ï¼š
  - `p_count` (integer) - ç”Ÿæˆæ•¸é‡
  - `p_session_id` (text) - æœƒè©±IDï¼ˆå¯é¸ï¼‰
- **è¿”å›**ï¼šåŒ…å« pallet_number å’Œ series çš„è¡¨æ ¼
- **æ ¼å¼**ï¼š
  - æ‰˜ç›¤ç·¨è™Ÿï¼šDDMMYY/1-300
  - ç³»åˆ—ï¼šDDMMYY-XXXXXX

### ğŸ” search_pallet_info

æœç´¢æ£§æ¿ä¿¡æ¯ï¼ˆæ”¯æ´æ£§æ¿è™Ÿæˆ–ç³»åˆ—è™Ÿï¼‰

- **åƒæ•¸**ï¼š
  - `p_search_type` (text) - æœç´¢é¡å‹
  - `p_search_value` (text) - æœç´¢å€¼
- **è¿”å›**ï¼šåŒ¹é…çš„æ£§æ¿è¨˜éŒ„åŠç•¶å‰ä½ç½®

### ğŸ” search_pallet_optimized_v2

å„ªåŒ–ç‰ˆæ£§æ¿æœç´¢åŠŸèƒ½ï¼ˆæ¨è–¦ä½¿ç”¨ï¼‰

- **åƒæ•¸**ï¼š
  - `p_search_type` (text) - æœç´¢é¡å‹ï¼ˆpallet/product/locationï¼‰
  - `p_search_value` (text) - æœç´¢å€¼
- **è¿”å›**ï¼šåŒ¹é…çš„æ£§æ¿è¨˜éŒ„ï¼Œæ”¯æ´æ›´å¤šæœç´¢é¸é …

### ğŸ“¦ batch_search_pallets

æ‰¹é‡æœç´¢å¤šå€‹æ£§æ¿

- **åƒæ•¸**ï¼š
  - `p_patterns` (text[]) - æ£§æ¿è™Ÿç¢¼æ•¸çµ„
- **è¿”å›**ï¼šæ‰€æœ‰åŒ¹é…çš„æ£§æ¿è¨˜éŒ„

### ğŸš› rpc_transfer_pallet

åŸå­æ€§è½‰ç§»æ£§æ¿åˆ°æ–°ä½ç½®

- **åƒæ•¸**ï¼š
  - `p_pallet_num` (text) - æ£§æ¿è™Ÿ
  - `p_to_location` (text) - ç›®æ¨™ä½ç½®
  - `p_user_id` (integer) - ç”¨æˆ¶ID
  - `p_user_name` (text) - ç”¨æˆ¶å
- **è¿”å›**ï¼šæ“ä½œçµæœ

### ğŸ–¨ï¸ rpc_get_pallet_reprint_info

ç²å–æ£§æ¿é‡å°ä¿¡æ¯

- **åƒæ•¸**ï¼š
  - `p_pallet_num` (text) - æ£§æ¿è™Ÿ
- **è¿”å›**ï¼šæ£§æ¿è©³æƒ…åŠç”¢å“æè¿°

---

## åº«å­˜ç®¡ç†

### âŒ update_stock_level_void (V2)

ä½œå»¢æ£§æ¿æ™‚æ›´æ–°åº«å­˜æ°´å¹³

- **åƒæ•¸**ï¼š
  - `p_product_code` (text) - ç”¢å“ä»£ç¢¼
  - `p_quantity` (bigint) - ä½œå»¢æ•¸é‡ï¼ˆå¿…é ˆç‚ºæ­£æ•¸ï¼‰
  - `p_operation` (text) - æ“ä½œé¡å‹ï¼ˆé è¨­ï¼š'void'ï¼‰
- **æ”¯æ´çš„æ“ä½œé¡å‹**ï¼š
  - `void` - ä¸€èˆ¬ä½œå»¢
  - `Print Extra` - æ‰“å°å¤šé¤˜æ¨™ç±¤
  - `Wrong Label` - éŒ¯èª¤æ¨™ç±¤
  - `Wrong Quantity` - éŒ¯èª¤æ•¸é‡
  - `Used Material` - å·²ä½¿ç”¨ææ–™
  - `Damaged` - æå£
- **åŠŸèƒ½**ï¼š
  - æ¸›å°‘æŒ‡å®šç”¢å“çš„åº«å­˜è¨˜éŒ„
  - æ’å…¥æ–°è¨˜éŒ„è€Œéæ›´æ–°ï¼ˆä¿æŒæ­·å²ï¼‰
  - ç¢ºä¿åº«å­˜ä¸æœƒè®Šæˆè² æ•¸
- **æ›´æ–°**ï¼š2025-08-02 - æ”¯æ´æ–°çš„ Void Reasons

### ğŸ”„ refresh_pallet_location_mv

åˆ·æ–°æ£§æ¿ä½ç½®ç‰©åŒ–è¦–åœ–

- **åƒæ•¸**ï¼šç„¡
- **åŠŸèƒ½**ï¼šæ›´æ–° pallet_location_mv ä»¥åæ˜ æœ€æ–°çš„æ£§æ¿ä½ç½®ä¿¡æ¯
- **ä½¿ç”¨å ´æ™¯**ï¼šæ‰¹é‡æ“ä½œå¾Œæˆ–å®šæœŸç¶­è­·

---

## è¨‚å–®è™•ç†

### ğŸ“¥ rpc_load_pallet_to_order

å°‡æ£§æ¿åŠ è¼‰åˆ°è¨‚å–®

- **åƒæ•¸**ï¼š
  - `p_order_ref` (text) - è¨‚å–®è™Ÿ
  - `p_pallet_input` (text) - æ£§æ¿è¼¸å…¥
  - `p_user_id` (integer) - ç”¨æˆ¶IDï¼ˆé è¨­ï¼š0ï¼‰
  - `p_user_name` (text) - ç”¨æˆ¶åï¼ˆé è¨­ï¼š'System'ï¼‰
- **è¿”å›**ï¼šæ“ä½œçµæœå’Œæ›´æ–°çš„è¨‚å–®ä¿¡æ¯

### â†©ï¸ rpc_undo_load_pallet

æ’¤éŠ·æ£§æ¿åŠ è¼‰

- **åƒæ•¸**ï¼š
  - `p_order_ref` (text) - è¨‚å–®è™Ÿ
  - `p_pallet_num` (text) - æ£§æ¿è™Ÿ
  - `p_product_code` (text) - ç”¢å“ä»£ç¢¼
  - `p_quantity` (integer) - æ•¸é‡
  - `p_user_id` (integer) - ç”¨æˆ¶IDï¼ˆé è¨­ï¼š0ï¼‰
  - `p_user_name` (text) - ç”¨æˆ¶åï¼ˆé è¨­ï¼š'System'ï¼‰

---

## å ±è¡¨ç”Ÿæˆ

### ğŸ“Š rpc_get_void_pallet_report_aggregation

ç”Ÿæˆä½œå»¢æ£§æ¿å ±è¡¨

- **åƒæ•¸**ï¼š
  - `p_start_date` (text) - é–‹å§‹æ—¥æœŸ
  - `p_end_date` (text) - çµæŸæ—¥æœŸ
  - `p_product_filter` (text) - ç”¢å“éæ¿¾ï¼ˆå¯é¸ï¼‰
  - `p_reason_filter` (text) - åŸå› éæ¿¾ï¼ˆå¯é¸ï¼‰
  - `p_limit` (integer) - é™åˆ¶æ•¸é‡ï¼ˆé è¨­ï¼š1000ï¼‰
  - `p_offset` (integer) - åç§»é‡ï¼ˆé è¨­ï¼š0ï¼‰
- **è¿”å›**ï¼šåŒ¯ç¸½çš„ä½œå»¢è¨˜éŒ„

---

## ç³»çµ±ç¶­è­·

### ğŸ§¹ api_cleanup_pallet_buffer

å„ªåŒ–ç‰ˆæ£§æ¿ç·©è¡å€æ¸…ç†ï¼ˆç”± cron job æ¯ 5 åˆ†é˜è‡ªå‹•åŸ·è¡Œï¼‰

- **åƒæ•¸**ï¼šç„¡
- **åŠŸèƒ½**ï¼š
  - åˆªé™¤éä»Šæ—¥çš„æ‰€æœ‰è¨˜éŒ„
  - åˆªé™¤å·²ä½¿ç”¨ï¼ˆ`used = 'True'`ï¼‰è¶…é 4 å°æ™‚çš„è¨˜éŒ„
  - åˆªé™¤è¢«é–å®šï¼ˆ`used = 'Holded'`ï¼‰è¶…é 5 åˆ†é˜çš„è¨˜éŒ„
  - **ä¿ç•™**æ‰€æœ‰æœªä½¿ç”¨ï¼ˆ`used = 'False'`ï¼‰çš„ç•¶æ—¥è¨˜éŒ„
- **Cron Job**ï¼š`cleanup-pallet-buffer` - æ¯ 5 åˆ†é˜åŸ·è¡Œ

### ğŸ”„ reset_daily_pallet_buffer

é‡ç½®æ¯æ—¥æ£§æ¿ç·©è¡å€ï¼ˆç”± cron job æ¯æ—¥ UTC 00:00 è‡ªå‹•åŸ·è¡Œï¼‰

- **åƒæ•¸**ï¼šç„¡
- **åŠŸèƒ½**ï¼š
  - æ¸…ç©º pallet_number_buffer è¡¨
  - é‡æ–°ç”Ÿæˆ 300 å€‹æ£§æ¿è™Ÿç¢¼
  - æ ¼å¼ï¼šDDMMYY/1-300 (pallet_number), DDMMYY-XXXXXX (series)
- **Cron Job**ï¼š`reset-pallet-buffer-daily` - æ¯æ—¥ UTC 00:00 åŸ·è¡Œï¼ˆè‹±åœ‹å†¬ä»¤æ™‚åˆå¤œï¼‰

### ğŸ“Š get_pallet_buffer_status

ç²å–æ£§æ¿ç·©è¡å€ç‹€æ…‹

- **åƒæ•¸**ï¼šç„¡
- **è¿”å›**ï¼šç·©è¡å€ç•¶å‰ç‹€æ…‹ä¿¡æ¯

### âœ… check_pallet_buffer_health

æª¢æŸ¥æ£§æ¿ç·©è¡å€å¥åº·ç‹€æ…‹

- **åƒæ•¸**ï¼šç„¡
- **è¿”å›**ï¼šå¥åº·ç‹€æ…‹å ±å‘Š
  - `unused_count` - å¯ç”¨æ•¸é‡
  - `used_count` - å·²ä½¿ç”¨æ•¸é‡
  - `holded_count` - è¢«é–å®šæ•¸é‡
  - `health_status` - healthy (â‰¥100), warning (â‰¥50), critical (<50)

### ğŸ”„ auto_check_pallet_buffer_health

è‡ªå‹•æª¢æŸ¥ä¸¦è£œå……æ£§æ¿è™Ÿç¢¼ï¼ˆç”± cron job æ¯å°æ™‚è‡ªå‹•åŸ·è¡Œï¼‰

- **åƒæ•¸**ï¼šç„¡
- **åŠŸèƒ½**ï¼š
  - æª¢æŸ¥ç•¶æ—¥å¯ç”¨çš„æ£§æ¿è™Ÿç¢¼æ•¸é‡
  - å¦‚æœå°‘æ–¼ 50 å€‹ï¼Œè‡ªå‹•**æ–°å¢**è™Ÿç¢¼è‡³ 100 å€‹
  - **ä¸æœƒé‡ç½®**ï¼Œåªæœƒå»¶çºŒç¾æœ‰åºè™Ÿç¹¼çºŒæ·»åŠ 
  - ç¢ºä¿ä¸æœƒæœ‰é‡è¤‡çš„æ£§æ¿è™Ÿç¢¼
- **Cron Job**ï¼š`check-pallet-buffer-health-hourly` - æ¯å°æ™‚åŸ·è¡Œ

---

## ä½¿ç”¨ç¤ºä¾‹

### ä½œå»¢æ£§æ¿

```sql
-- ä½¿ç”¨æ–°çš„ Void Reason
SELECT update_stock_level_void('PROD001', 100, 'Wrong Label');

-- æå£ä½œå»¢
SELECT update_stock_level_void('PROD002', 50, 'Damaged');
```

### æœç´¢æ£§æ¿

```sql
-- æŒ‰æ£§æ¿è™Ÿæœç´¢
SELECT * FROM search_pallet_optimized_v2('pallet', 'P240102/001');

-- æŒ‰ç”¢å“ä»£ç¢¼æœç´¢
SELECT * FROM search_pallet_optimized_v2('product', 'PROD001');
```

### è½‰ç§»æ£§æ¿

```sql
SELECT rpc_transfer_pallet('P240102/001', 'Warehouse A', 123, 'John Doe');
```

---

## è‡ªå‹•åŒ– Cron Jobs

### æ£§æ¿ç·©è¡å€ç®¡ç†

ç³»çµ±å·²é…ç½®ä»¥ä¸‹è‡ªå‹•åŒ–ä»»å‹™ï¼Œç¢ºä¿æ£§æ¿è™Ÿç¢¼ä¾›æ‡‰ç©©å®šï¼š

1. **`cleanup-pallet-buffer`** - æ¯ 5 åˆ†é˜
   - åŸ·è¡Œ `api_cleanup_pallet_buffer()`
   - æ¸…ç†éæœŸå’Œå·²ä½¿ç”¨çš„æ£§æ¿è™Ÿç¢¼

2. **`reset-pallet-buffer-daily`** - æ¯æ—¥ UTC 00:00
   - åŸ·è¡Œ `reset_daily_pallet_buffer()`
   - é‡ç½®ä¸¦ç”Ÿæˆç•¶æ—¥ 300 å€‹æ–°æ£§æ¿è™Ÿç¢¼

3. **`check-pallet-buffer-health-hourly`** - æ¯å°æ™‚
   - åŸ·è¡Œ `auto_check_pallet_buffer_health()`
   - æª¢æŸ¥ä¸¦è£œå……æ£§æ¿è™Ÿç¢¼è‡³ 100 å€‹

---

## æ³¨æ„äº‹é …

1. æ‰€æœ‰ RPC å‡½æ•¸éƒ½ä½¿ç”¨ `SECURITY DEFINER`ï¼Œç¢ºä¿é©ç•¶çš„æ¬Šé™æ§åˆ¶
2. å¤§éƒ¨åˆ†å‡½æ•¸åŒ…å«éŒ¯èª¤è™•ç†ï¼Œæœƒè¿”å›éŒ¯èª¤ä¿¡æ¯è€Œéæ‹‹å‡ºç•°å¸¸
3. æ¶‰åŠå¤šè¡¨æ“ä½œçš„å‡½æ•¸é€šå¸¸ä½¿ç”¨äº‹å‹™ç¢ºä¿æ•¸æ“šä¸€è‡´æ€§
4. æ£§æ¿ç·©è¡å€ç®¡ç†å·²å®Œå…¨è‡ªå‹•åŒ–ï¼Œç„¡éœ€æ‰‹å‹•ç¶­è­·
