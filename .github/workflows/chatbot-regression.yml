name: ChatbotCard å›žæ­¸æ¸¬è©¦

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'app/(app)/admin/cards/ChatbotCard.tsx'
      - 'app/(app)/admin/components/**'
      - 'app/(app)/admin/hooks/**'
      - 'app/(app)/admin/context/**'
      - '__tests__/**chatbot**'
      - '__tests__/regression/**'
      - '__tests__/e2e/**'
      - '__tests__/performance/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'app/(app)/admin/cards/ChatbotCard.tsx'
      - 'app/(app)/admin/components/**'
      - 'app/(app)/admin/hooks/**'
      - 'app/(app)/admin/context/**'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'é¸æ“‡æ¸¬è©¦å¥—ä»¶'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - e2e
          - performance
      performance_baseline:
        description: 'æ€§èƒ½åŸºæº–æ¸¬è©¦'
        required: false
        default: 'false'
        type: boolean

jobs:
  regression-tests:
    name: å›žæ­¸æ¸¬è©¦
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
        
    timeout-minutes: 30
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: å®‰è£ä¾è³´
      run: |
        npm ci
        npx playwright install --with-deps
        
    - name: é©—è­‰ç’°å¢ƒè¨­ç½®
      run: |
        node --version
        npm --version
        npx playwright --version
        
    - name: å»ºç«‹æ¸¬è©¦ç’°å¢ƒ
      run: |
        mkdir -p test-results
        cp .env.example .env.local || true
        
    - name: åŸ·è¡Œ TypeScript æª¢æŸ¥
      run: npm run typecheck
      
    - name: åŸ·è¡Œ ESLint æª¢æŸ¥
      run: npm run lint
      
    - name: å»ºç½®å°ˆæ¡ˆ
      run: npm run build
      
    - name: åŸ·è¡Œå–®å…ƒå›žæ­¸æ¸¬è©¦
      if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'unit' || github.event.inputs.test_suite == '' }}
      run: npm run test:unit:chatbot
      
    - name: åŸ·è¡Œè·¨ç€è¦½å™¨å…¼å®¹æ€§æ¸¬è©¦
      if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'integration' || github.event.inputs.test_suite == '' }}
      run: npm run test:crossbrowser:chatbot
      
    - name: å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨ (èƒŒæ™¯)
      if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'e2e' || github.event.inputs.test_suite == 'performance' || github.event.inputs.test_suite == '' }}
      run: |
        npm run dev -- --port 3001 &
        sleep 30
        curl -f http://localhost:3001 || exit 1
        
    - name: åŸ·è¡Œ E2E å›žæ­¸æ¸¬è©¦
      if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'e2e' || github.event.inputs.test_suite == '' }}
      run: npm run test:e2e:chatbot
      
    - name: åŸ·è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦
      if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'performance' || github.event.inputs.performance_baseline == 'true' || github.event.inputs.test_suite == '' }}
      run: npm run test:performance:baseline
      
    - name: åŸ·è¡Œå®Œæ•´å›žæ­¸æ¸¬è©¦å¥—ä»¶
      if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '' }}
      run: npm run test:regression:chatbot:ci
      
    - name: ä¸Šå‚³æ¸¬è©¦çµæžœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-node-${{ matrix.node-version }}
        path: |
          test-results/
          playwright-report/
          coverage/
        retention-days: 7
        
    - name: ä¸Šå‚³ Playwright å ±å‘Š
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-report-node-${{ matrix.node-version }}
        path: playwright-report/
        retention-days: 3
        
    - name: æ€§èƒ½å›žæ­¸æª¢æŸ¥
      if: always()
      run: |
        if [ -f "test-results/regression-report-*.json" ]; then
          echo "ðŸ“Š å›žæ­¸æ¸¬è©¦çµæžœæ‘˜è¦:"
          node -e "
            const fs = require('fs');
            const files = fs.readdirSync('test-results').filter(f => f.startsWith('regression-report-'));
            if (files.length > 0) {
              const report = JSON.parse(fs.readFileSync('test-results/' + files[0]));
              console.log('ç¸½æ¸¬è©¦æ•¸:', report.summary.totalTests);
              console.log('é€šéŽ:', report.summary.totalPassed);
              console.log('å¤±æ•—:', report.summary.totalFailed);
              console.log('æˆåŠŸçŽ‡:', report.summary.successRate.toFixed(1) + '%');
              
              if (report.summary.totalFailed > 0) {
                console.log('âŒ æª¢æ¸¬åˆ°æ¸¬è©¦å¤±æ•—');
                process.exit(1);
              }
              
              // æª¢æŸ¥æ€§èƒ½å›žæ­¸
              const performanceData = report.suites.performance?.performanceMetrics;
              if (performanceData) {
                const pageLoadMetric = performanceData.find(m => m.testName === 'pageLoad');
                if (pageLoadMetric && pageLoadMetric.improvement < 15) {
                  console.log('âš ï¸ æ€§èƒ½æ”¹é€²æœªé”åˆ° 15% ç›®æ¨™');
                  process.exit(2);
                }
              }
              
              console.log('âœ… æ‰€æœ‰å›žæ­¸æ¸¬è©¦é€šéŽ');
            }
          "
        fi
        
  lighthouse-audit:
    name: Lighthouse æ€§èƒ½å¯©è¨ˆ
    runs-on: ubuntu-latest
    needs: regression-tests
    if: ${{ github.event.inputs.performance_baseline == 'true' || github.event_name == 'push' }}
    
    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: å®‰è£ä¾è³´
      run: npm ci
      
    - name: å»ºç½®å°ˆæ¡ˆ
      run: npm run build
      
    - name: å•Ÿå‹•ç”Ÿç”¢ä¼ºæœå™¨
      run: |
        npm start &
        sleep 30
        
    - name: åŸ·è¡Œ Lighthouse CI
      run: |
        npm install -g @lhci/cli
        lhci autorun --config=.lighthouserc.js || true
        
    - name: ä¸Šå‚³ Lighthouse çµæžœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lighthouse-results
        path: .lighthouseci/
        retention-days: 7
        
  notify-results:
    name: é€šçŸ¥æ¸¬è©¦çµæžœ
    runs-on: ubuntu-latest
    needs: [regression-tests, lighthouse-audit]
    if: always()
    
    steps:
    - name: ä¸‹è¼‰æ¸¬è©¦çµæžœ
      uses: actions/download-artifact@v4
      with:
        pattern: test-results-*
        merge-multiple: true
        path: test-results/
        
    - name: å‰µå»ºçµæžœæ‘˜è¦
      run: |
        echo "## ðŸ§ª ChatbotCard å›žæ­¸æ¸¬è©¦çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.regression-tests.result }}" == "success" ]; then
          echo "âœ… å›žæ­¸æ¸¬è©¦: **é€šéŽ**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ å›žæ­¸æ¸¬è©¦: **å¤±æ•—**" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.lighthouse-audit.result }}" == "success" ]; then
          echo "âœ… Lighthouse å¯©è¨ˆ: **é€šéŽ**" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.lighthouse-audit.result }}" == "skipped" ]; then
          echo "â­ï¸ Lighthouse å¯©è¨ˆ: **è·³éŽ**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Lighthouse å¯©è¨ˆ: **å¤±æ•—**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æ¸¬è©¦è¦†è“‹ç¯„åœ" >> $GITHUB_STEP_SUMMARY
        echo "- å–®å…ƒæ¸¬è©¦: ChatbotCard æ ¸å¿ƒåŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
        echo "- æ•´åˆæ¸¬è©¦: çµ„ä»¶å”ä½œå’Œç‹€æ…‹ç®¡ç†" >> $GITHUB_STEP_SUMMARY
        echo "- E2E æ¸¬è©¦: å®Œæ•´ç”¨æˆ¶æµç¨‹" >> $GITHUB_STEP_SUMMARY
        echo "- æ€§èƒ½æ¸¬è©¦: 15-20% æ”¹é€²ç›®æ¨™é©—è­‰" >> $GITHUB_STEP_SUMMARY
        echo "- è·¨ç€è¦½å™¨: Chrome, Firefox, Safari, Edge" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### é‡æ§‹æŒ‡æ¨™" >> $GITHUB_STEP_SUMMARY
        echo "- ä»£ç¢¼è¡Œæ•¸: 1074 â†’ 312 è¡Œ (-70%)" >> $GITHUB_STEP_SUMMARY
        echo "- ç‹€æ…‹æ•¸é‡: 17 â†’ 6 å€‹ (-65%)" >> $GITHUB_STEP_SUMMARY
        echo "- è¨˜æ†¶é«”ä½¿ç”¨: ç›®æ¨™æ¸›å°‘ 17.8%" >> $GITHUB_STEP_SUMMARY
        echo "- æ€§èƒ½æ”¹é€²: ç›®æ¨™ 15-20%" >> $GITHUB_STEP_SUMMARY