name: å„ªåŒ–æ¸¬è©¦åŸ·è¡Œæµç¨‹

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  JEST_CACHE_ENABLED: 'true'

jobs:
  # ä¸¦è¡Œæ¸¬è©¦ä½œæ¥­
  test-parallel:
    name: ä¸¦è¡Œæ¸¬è©¦åŸ·è¡Œ
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        test-group: [unit, integration, services]
      fail-fast: false

    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£ä¾è³´
        run: npm ci --prefer-offline --no-audit

      - name: æ¢å¾© Jest ç·©å­˜
        uses: actions/cache@v3
        with:
          path: |
            .jest-cache
            node_modules/.cache/jest
          key: jest-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json', 'jest.config.js') }}
          restore-keys: |
            jest-cache-${{ runner.os }}-

      - name: é‹è¡Œæ¸¬è©¦ - ${{ matrix.test-group }}
        run: |
          case "${{ matrix.test-group }}" in
            "unit")
              npm run test:unit -- --ci --coverage --maxWorkers=2
              ;;
            "integration")
              npm run test:integration -- --ci --maxWorkers=1
              ;;
            "services")
              npm test -- --testPathPattern='app/services|app/void-pallet/services' --ci --coverage --maxWorkers=2
              ;;
          esac

      - name: ä¸Šå‚³è¦†è“‹ç‡å ±å‘Š
        if: matrix.test-group == 'unit' || matrix.test-group == 'services'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: ${{ matrix.test-group }}
          name: ${{ matrix.test-group }}-coverage

      - name: ä¸Šå‚³æ¸¬è©¦çµæœ
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.test-group }}
          path: |
            coverage/
            junit.xml
          retention-days: 7

  # æ€§èƒ½æ¸¬è©¦ä½œæ¥­
  performance-test:
    name: æ€§èƒ½æ¸¬è©¦
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£ä¾è³´
        run: npm ci --prefer-offline --no-audit

      - name: é‹è¡Œæ€§èƒ½æ¸¬è©¦
        run: npm run test:performance

      - name: é‹è¡Œç·©å­˜çµ±è¨ˆ
        run: npm run test:cache-stats

      - name: ç”Ÿæˆæ€§èƒ½å ±å‘Š
        run: |
          echo "## æ¸¬è©¦æ€§èƒ½å ±å‘Š" >> performance-report.md
          echo "æ¸¬è©¦æ™‚é–“: $(date)" >> performance-report.md
          echo "" >> performance-report.md
          npm run test:cache-stats >> performance-report.md

      - name: ä¸Šå‚³æ€§èƒ½å ±å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: performance-report.md

  # E2E æ¸¬è©¦ä½œæ¥­
  e2e-test:
    name: E2E æ¸¬è©¦
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: å®‰è£ä¾è³´
        run: npm ci --prefer-offline --no-audit

      - name: å®‰è£ Playwright Browsers
        run: npx playwright install --with-deps

      - name: é‹è¡Œ E2E æ¸¬è©¦
        run: npm run test:e2e

      - name: ä¸Šå‚³ E2E å ±å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-report
          path: playwright-report/
          retention-days: 7

  # æ¸¬è©¦çµæœæ‘˜è¦
  test-summary:
    name: æ¸¬è©¦çµæœæ‘˜è¦
    runs-on: ubuntu-latest
    needs: [test-parallel, performance-test, e2e-test]
    if: always()

    steps:
      - name: Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: ä¸‹è¼‰æ‰€æœ‰æ¸¬è©¦çµæœ
        uses: actions/download-artifact@v3

      - name: ç”Ÿæˆæ¸¬è©¦æ‘˜è¦
        run: |
          echo "# ğŸ§ª æ¸¬è©¦åŸ·è¡Œæ‘˜è¦" > test-summary.md
          echo "åŸ·è¡Œæ™‚é–“: $(date)" >> test-summary.md
          echo "" >> test-summary.md

          echo "## ğŸ“Š è¦†è“‹ç‡çµ±è¨ˆ" >> test-summary.md
          if [ -d "test-results-unit/coverage" ]; then
            echo "- å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡: å·²ç”Ÿæˆ" >> test-summary.md
          fi
          if [ -d "test-results-services/coverage" ]; then
            echo "- æœå‹™æ¸¬è©¦è¦†è“‹ç‡: å·²ç”Ÿæˆ" >> test-summary.md
          fi

          echo "" >> test-summary.md
          echo "## âš¡ æ€§èƒ½æŒ‡æ¨™" >> test-summary.md
          if [ -f "performance-report/performance-report.md" ]; then
            cat performance-report/performance-report.md >> test-summary.md
          fi

          echo "" >> test-summary.md
          echo "## ğŸ­ E2E æ¸¬è©¦" >> test-summary.md
          if [ -d "e2e-report" ]; then
            echo "- E2E æ¸¬è©¦å ±å‘Š: å·²ç”Ÿæˆ" >> test-summary.md
          fi

      - name: ç™¼å¸ƒæ¸¬è©¦æ‘˜è¦
        uses: actions/upload-artifact@v3
        with:
          name: final-test-summary
          path: test-summary.md

      - name: è©•è«– PRï¼ˆå¦‚æœæ˜¯ PRï¼‰
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('test-summary.md')) {
              const summary = fs.readFileSync('test-summary.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }

  # ç·©å­˜æ¸…ç†ä½œæ¥­ï¼ˆæ¯é€±åŸ·è¡Œï¼‰
  cache-cleanup:
    name: ç·©å­˜æ¸…ç†
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: æ¸…ç†éæœŸç·©å­˜
        run: |
          echo "æ¸…ç† GitHub Actions ç·©å­˜..."
          # é€™è£¡å¯ä»¥æ·»åŠ æ¸…ç†é‚è¼¯

# å®šæœŸæ¸…ç†ç·©å­˜ï¼ˆæ¯é€±æ—¥åŸ·è¡Œï¼‰
on:
  schedule:
    - cron: '0 0 * * 0'  # æ¯é€±æ—¥åˆå¤œåŸ·è¡Œ
