# SQL 注入保護測試

## 概述
這是一個專門測試 NewPennine WMS 系統中 `execute_sql_query` RPC 函數 SQL 注入保護機制的測試腳本。

## 測試檔案
- **主要測試腳本**: `scripts/test-sql-injection-protection.js`
- **用途**: 驗證 SQL 注入攻擊防護措施的有效性

## 如何執行測試

### 前置條件
1. 確保 `.env.local` 檔案包含正確的 Supabase 配置
2. 確保 `execute_sql_query` RPC 函數已部署到數據庫

### 執行命令
```bash
# 直接執行測試
node scripts/test-sql-injection-protection.js

# 或者可以考慮添加到 package.json scripts
npm run test:sql-injection  # (需要先添加到 package.json)
```

## 測試類別

### 1. DML 語句注入測試
- **DELETE** 語句注入
- **UPDATE** 語句注入  
- **INSERT** 語句注入

### 2. DDL 語句注入測試
- **DROP TABLE** 注入
- **CREATE TABLE** 注入
- **ALTER TABLE** 注入
- **TRUNCATE** 注入

### 3. 系統表存取測試
- PostgreSQL 系統表存取嘗試
- 用戶表存取嘗試
- 數據庫配置存取嘗試

### 4. 多語句執行測試
- 分號分隔多語句
- 嵌套查詢與分號

### 5. 註釋繞過測試
- 單行註釋繞過
- 多行註釋繞過

### 6. UNION 注入測試
- UNION 注入嘗試
- UNION ALL 注入

### 7. 布林盲注測試
- 布林盲注測試
- 子查詢布林測試

### 8. 時間盲注測試
- pg_sleep 時間延遲
- 複雜時間延遲

### 9. 合法查詢測試
驗證正常查詢不會被誤判為惡意查詢

## 最新測試結果

### 安全性評分: 80.0% (16/20 通過)
### 功能性評分: 50.0% (2/4 通過)

## 安全機制分析

### 現有保護措施 ✅
1. **關鍵字過濾**: 成功阻止 INSERT、UPDATE、DELETE、DROP、CREATE、ALTER、TRUNCATE
2. **查詢類型限制**: 只允許 SELECT 和 WITH 查詢
3. **成本控制**: 防止過於昂貴的查詢執行
4. **超時保護**: 30秒查詢超時限制
5. **行數限制**: 防止返回過多數據

### 識別到的問題 ⚠️
1. **註釋處理**: 某些註釋語法可能導致語法錯誤而非安全錯誤
2. **列名驗證**: 部分測試因列名不存在而失敗，這實際上是好的保護
3. **UNION 查詢**: 一些 UNION 查詢因為權限或語法問題被阻止
4. **時間延遲**: pg_sleep 函數被超時機制正確阻止

## 安全建議

### 高優先級 🔴
1. **加強查詢解析**: 實施更精確的 SQL 語句解析，而非僅依賴關鍵字匹配
2. **權限層級控制**: 確保即使繞過關鍵字檢查，用戶也無法存取敏感數據
3. **查詢白名單**: 考慮實施預定義查詢模板系統

### 中優先級 🟡
1. **錯誤訊息優化**: 統一錯誤訊息，避免洩露內部結構資訊
2. **審計日誌**: 記錄所有被阻止的查詢嘗試以便監控
3. **速率限制**: 實施 API 調用頻率限制

### 低優先級 🟢
1. **查詢成本估算**: 繼續優化查詢成本控制機制
2. **響應時間標準化**: 避免透過響應時間差異洩露信息

## 檔案結構

```
scripts/
├── test-sql-injection-protection.js  # 主測試腳本
└── README-sql-injection-test.md      # 本文檔
```

## 測試結果解讀

### ✅ SECURE (安全)
表示攻擊被正確阻止或允許的合法操作正常執行

### ❌ VULNERABLE (漏洞)  
表示:
- 預期被阻止的攻擊未被阻止
- 預期被允許的合法操作被錯誤阻止

### ⚠️ UNEXPECTED (意外)
表示出現了未預期的錯誤或行為

## 定期測試建議

1. **每次部署前**: 執行完整測試套件
2. **每月安全檢查**: 重新評估安全機制
3. **更新後驗證**: 任何 RPC 函數修改後重新測試
4. **新威脅應對**: 根據最新 SQL 注入技術更新測試案例

## 聯繫資訊
如有安全問題或需要協助，請聯繫開發團隊。

---
*最後更新: 2025-07-12*
*測試版本: v1.0*