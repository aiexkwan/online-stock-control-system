import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import request from 'supertest';
import { AppModule } from '../src/app.module';
import { TestHelpers } from './test-helpers';

/**
 * v1.3.2 åŠŸèƒ½é©—è­‰æ¸¬è©¦å¥—ä»¶
 *
 * å°ˆé–€é‡å° v1.3.2 ç‰ˆæœ¬æ–°å¢çš„åŠŸèƒ½å’Œä¿®å¾©é€²è¡Œæ¸¬è©¦
 * åŒ…æ‹¬ï¼š
 * - JWT èªè­‰æµç¨‹
 * - åˆ†ææ¨¡çµ„ API ç«¯é»
 * - å‰ç«¯ widgets åŠŸèƒ½
 * - ç³»çµ±æ•´åˆæ€§é©—è­‰
 */
describe('v1.3.2 Feature Validation (e2e)', () => {
  let app: INestApplication;
  let authToken: string;

  // ç³»çµ±ç™»å…¥æ†‘æ“š
  const systemCredentials = {
    email: 'akwan@pennineindustries.com',
    password: 'X315Y316',
  };

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();

    // æ‡‰ç”¨èˆ‡ main.ts ç›¸åŒçš„é…ç½®
    app.setGlobalPrefix('api/v1');
    app.enableCors({
      origin: '*',
      credentials: true,
      methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
      allowedHeaders: ['Content-Type', 'Authorization'],
    });

    await app.init();

    console.log('ğŸš€ v1.3.2 æ¸¬è©¦ç’°å¢ƒå·²åˆå§‹åŒ–');
  });

  afterAll(async () => {
    await app.close();
    console.log('âœ… v1.3.2 æ¸¬è©¦ç’°å¢ƒå·²é—œé–‰');
  });

  describe('1. ç³»çµ±å¥åº·æª¢æŸ¥', () => {
    it('æ‡‰è©²è¿”å›åŸºæœ¬å¥åº·ç‹€æ…‹', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/health')
        .expect(200);

      expect(response.body).toHaveProperty('status', 'ok');
      expect(response.body).toHaveProperty('service', 'newpennine-api');
      expect(response.body).toHaveProperty('timestamp');

      console.log('âœ… åŸºæœ¬å¥åº·æª¢æŸ¥é€šé');
    });

    it('æ‡‰è©²è¿”å›è©³ç´°å¥åº·ç‹€æ…‹', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/health/detailed')
        .expect(200);

      expect(response.body).toHaveProperty('status', 'ok');
      expect(response.body).toHaveProperty('database');
      expect(response.body).toHaveProperty('memory');
      expect(response.body).toHaveProperty('uptime');

      console.log('âœ… è©³ç´°å¥åº·æª¢æŸ¥é€šé');
    });
  });

  describe('2. JWT èªè­‰æµç¨‹é©—è­‰', () => {
    it('æ‡‰è©²èƒ½ä½¿ç”¨ç³»çµ±æ†‘æ“šç™»å…¥', async () => {
      const response = await request(app.getHttpServer())
        .post('/api/v1/auth/login')
        .send(systemCredentials)
        .expect(200);

      expect(response.body).toHaveProperty('access_token');
      expect(response.body).toHaveProperty('user');
      expect(response.body.user.email).toBe(systemCredentials.email);

      authToken = response.body.access_token;
      console.log('âœ… ç³»çµ±æ†‘æ“šç™»å…¥æˆåŠŸ');
    });

    it('æ‡‰è©²èƒ½é©—è­‰ JWT token', async () => {
      if (!authToken) {
        // å¦‚æœç›´æ¥ç™»å…¥å¤±æ•—ï¼Œä½¿ç”¨æ¸¬è©¦åŠ©æ‰‹
        authToken = await TestHelpers.loginAndGetToken(app);
      }

      const response = await request(app.getHttpServer())
        .get('/api/v1/auth/verify')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('valid', true);
      expect(response.body).toHaveProperty('user');

      console.log('âœ… JWT token é©—è­‰æˆåŠŸ');
    });

    it('æ‡‰è©²èƒ½ç²å–ç”¨æˆ¶è³‡æ–™', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/auth/profile')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('email');

      console.log('âœ… ç”¨æˆ¶è³‡æ–™ç²å–æˆåŠŸ');
    });
  });

  describe('3. åˆ†ææ¨¡çµ„ API ç«¯é»é©—è­‰', () => {
    it('æ‡‰è©²è¿”å› ACO è¨‚å–®é€²åº¦å¡ç‰‡æ•¸æ“š', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/analysis/aco-order-progress-cards')
        .query({
          startDate: '2025-01-01',
          endDate: '2025-01-15',
        })
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('cards');
      expect(Array.isArray(response.body.cards)).toBe(true);
      expect(response.body).toHaveProperty('metadata');

      console.log('âœ… ACO è¨‚å–®é€²åº¦å¡ç‰‡ API æ­£å¸¸');
    });

    it('æ‡‰è©²è¿”å› ACO è¨‚å–®é€²åº¦åœ–è¡¨æ•¸æ“š', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/analysis/aco-order-progress-chart')
        .query({
          startDate: '2025-01-01',
          endDate: '2025-01-15',
          granularity: 'daily',
        })
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('chartData');
      expect(response.body).toHaveProperty('summary');
      expect(Array.isArray(response.body.chartData)).toBe(true);

      console.log('âœ… ACO è¨‚å–®é€²åº¦åœ–è¡¨ API æ­£å¸¸');
    });
  });

  describe('4. Widget API ç«¯é»é©—è­‰', () => {
    const validDataSources = [
      'totalPallets',
      'activeTransfers',
      'todayGRN',
      'pendingOrders',
    ];

    validDataSources.forEach((dataSource) => {
      it(`æ‡‰è©²è¿”å› ${dataSource} çµ±è¨ˆå¡ç‰‡æ•¸æ“š`, async () => {
        const response = await request(app.getHttpServer())
          .get('/api/v1/widgets/stats-card')
          .query({ dataSource })
          .set('Authorization', `Bearer ${authToken}`)
          .expect(200);

        expect(response.body).toHaveProperty('value');
        expect(response.body).toHaveProperty('label');
        expect(response.body).toHaveProperty('dataSource', dataSource);
        expect(typeof response.body.value).toBe('number');

        console.log(`âœ… ${dataSource} çµ±è¨ˆå¡ç‰‡ API æ­£å¸¸`);
      });
    });

    it('æ‡‰è©²è¿”å›åº«å­˜åˆ†ææ•¸æ“š', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/widgets/inventory-analysis')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('warehouses');
      expect(response.body).toHaveProperty('totalItems');
      expect(response.body).toHaveProperty('totalQuantity');
      expect(Array.isArray(response.body.warehouses)).toBe(true);

      console.log('âœ… åº«å­˜åˆ†æ API æ­£å¸¸');
    });

    it('æ‡‰è©²è¿”å›ç”¢å“åˆ†ä½ˆæ•¸æ“š', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/widgets/product-distribution')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('distribution');
      expect(response.body).toHaveProperty('total');
      expect(Array.isArray(response.body.distribution)).toBe(true);

      console.log('âœ… ç”¢å“åˆ†ä½ˆ API æ­£å¸¸');
    });

    it('æ‡‰è©²è¿”å›åº«å­˜èˆ‡è¨‚å–®éœ€æ±‚åˆ†æ', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/widgets/inventory-ordered-analysis')
        .query({
          startDate: '2025-01-01',
          endDate: '2025-01-15',
        })
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('products');
      expect(response.body).toHaveProperty('summary');
      expect(Array.isArray(response.body.products)).toBe(true);

      console.log('âœ… åº«å­˜èˆ‡è¨‚å–®éœ€æ±‚åˆ†æ API æ­£å¸¸');
    });
  });

  describe('5. æ ¸å¿ƒæ¥­å‹™ç«¯é»é©—è­‰', () => {
    it('æ‡‰è©²è¿”å›æ£§æ¿ä¿¡æ¯', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/pallets')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('data');
      expect(Array.isArray(response.body.data)).toBe(true);

      console.log('âœ… æ£§æ¿ä¿¡æ¯ API æ­£å¸¸');
    });

    it('æ‡‰è©²è¿”å›åº«å­˜æ•¸æ“š', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/inventory')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('data');
      expect(Array.isArray(response.body.data)).toBe(true);

      console.log('âœ… åº«å­˜æ•¸æ“š API æ­£å¸¸');
    });

    it('æ‡‰è©²è¿”å›è½‰ç§»è¨˜éŒ„', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/transfers')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('data');
      expect(Array.isArray(response.body.data)).toBe(true);

      console.log('âœ… è½‰ç§»è¨˜éŒ„ API æ­£å¸¸');
    });

    it('æ‡‰è©²è¿”å›æ­·å²è¨˜éŒ„', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/history')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('data');
      expect(Array.isArray(response.body.data)).toBe(true);

      console.log('âœ… æ­·å²è¨˜éŒ„ API æ­£å¸¸');
    });
  });

  describe('6. RPC å‡½æ•¸ç«¯é»é©—è­‰', () => {
    it('æ‡‰è©²è¿”å›ç­‰å¾…ä½ç½®è¨ˆæ•¸', async () => {
      const response = await request(app.getHttpServer())
        .get('/api/v1/rpc/await-location-count')
        .set('Authorization', `Bearer ${authToken}`)
        .expect(200);

      expect(response.body).toHaveProperty('data');

      console.log('âœ… RPC ç­‰å¾…ä½ç½®è¨ˆæ•¸æ­£å¸¸');
    });
  });

  describe('7. èªè­‰ä¿è­·é©—è­‰', () => {
    const protectedEndpoints = [
      '/api/v1/widgets/stats',
      '/api/v1/widgets/inventory',
      '/api/v1/widgets/inventory-analysis',
      '/api/v1/pallets',
      '/api/v1/inventory',
      '/api/v1/transfers',
      '/api/v1/history',
    ];

    protectedEndpoints.forEach((endpoint) => {
      it(`${endpoint} æ‡‰è©²è¦æ±‚èªè­‰`, async () => {
        await request(app.getHttpServer()).get(endpoint).expect(401);
      });
    });

    console.log('âœ… æ‰€æœ‰ä¿è­·ç«¯é»èªè­‰æª¢æŸ¥å®Œæˆ');
  });

  describe('8. éŒ¯èª¤è™•ç†é©—è­‰', () => {
    it('æ‡‰è©²æ­£ç¢ºè™•ç†ç„¡æ•ˆçš„æ•¸æ“šæºè«‹æ±‚', async () => {
      await request(app.getHttpServer())
        .get('/api/v1/widgets/stats-card')
        .query({ dataSource: 'invalidSource' })
        .set('Authorization', `Bearer ${authToken}`)
        .expect(400);

      console.log('âœ… ç„¡æ•ˆæ•¸æ“šæºéŒ¯èª¤è™•ç†æ­£å¸¸');
    });

    it('æ‡‰è©²æ­£ç¢ºè™•ç†ç„¡æ•ˆçš„æ—¥æœŸæ ¼å¼', async () => {
      await request(app.getHttpServer())
        .get('/api/v1/widgets/inventory-ordered-analysis')
        .query({
          startDate: 'invalid-date',
          endDate: '2025-01-15',
        })
        .set('Authorization', `Bearer ${authToken}`)
        .expect(400);

      console.log('âœ… ç„¡æ•ˆæ—¥æœŸæ ¼å¼éŒ¯èª¤è™•ç†æ­£å¸¸');
    });

    it('æ‡‰è©²æ­£ç¢ºè™•ç†ä¸å­˜åœ¨çš„è·¯ç”±', async () => {
      await request(app.getHttpServer())
        .get('/api/v1/nonexistent-endpoint')
        .expect(404);

      console.log('âœ… ä¸å­˜åœ¨è·¯ç”±éŒ¯èª¤è™•ç†æ­£å¸¸');
    });
  });

  describe('9. æ€§èƒ½é©—è­‰', () => {
    it('API éŸ¿æ‡‰æ™‚é–“æ‡‰è©²åœ¨åˆç†ç¯„åœå…§', async () => {
      const endpoints = [
        '/api/v1/health',
        '/api/v1/widgets/stats-card?dataSource=totalPallets',
        '/api/v1/widgets/inventory-analysis',
      ];

      for (const endpoint of endpoints) {
        const startTime = Date.now();

        await request(app.getHttpServer())
          .get(endpoint)
          .set('Authorization', `Bearer ${authToken}`)
          .expect((res) => {
            expect([200, 401]).toContain(res.status);
          });

        const responseTime = Date.now() - startTime;
        expect(responseTime).toBeLessThan(10000); // 10ç§’å…§

        console.log(`âœ… ${endpoint} éŸ¿æ‡‰æ™‚é–“: ${responseTime}ms`);
      }
    }, 30000);
  });

  describe('10. æ•´åˆæ¸¬è©¦', () => {
    it('æ‡‰è©²æ”¯æŒå®Œæ•´çš„ç”¨æˆ¶å·¥ä½œæµç¨‹', async () => {
      // 1. ç™»å…¥
      const loginResponse = await request(app.getHttpServer())
        .post('/api/v1/auth/login')
        .send(systemCredentials);

      const token = loginResponse.body?.access_token || authToken;

      // 2. ç²å–å„€è¡¨æ¿çµ±è¨ˆ
      const statsResponse = await request(app.getHttpServer())
        .get('/api/v1/widgets/stats-card')
        .query({ dataSource: 'totalPallets' })
        .set('Authorization', `Bearer ${token}`)
        .expect(200);

      // 3. ç²å–åº«å­˜åˆ†æ
      const inventoryResponse = await request(app.getHttpServer())
        .get('/api/v1/widgets/inventory-analysis')
        .set('Authorization', `Bearer ${token}`)
        .expect(200);

      // 4. ç²å–ç”¢å“åˆ†ä½ˆ
      const distributionResponse = await request(app.getHttpServer())
        .get('/api/v1/widgets/product-distribution')
        .set('Authorization', `Bearer ${token}`)
        .expect(200);

      // é©—è­‰æ‰€æœ‰éŸ¿æ‡‰éƒ½æœ‰å¿…è¦çš„æ•¸æ“šçµæ§‹
      expect(statsResponse.body).toHaveProperty('value');
      expect(inventoryResponse.body).toHaveProperty('warehouses');
      expect(distributionResponse.body).toHaveProperty('distribution');

      console.log('âœ… å®Œæ•´ç”¨æˆ¶å·¥ä½œæµç¨‹æ¸¬è©¦é€šé');
    });
  });
});
