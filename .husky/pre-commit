#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# æª¢æŸ¥æ•æ„Ÿè³‡è¨Šæ¨¡å¼
echo "ğŸ” æª¢æŸ¥æ•æ„Ÿè³‡è¨Š..."

# å‰µå»ºè‡¨æ™‚æª”æ¡ˆä¾†å­˜å„²çµæœ
TEMP_FILE=$(mktemp)
HAS_REAL_SECRETS=false

# å®šç¾©å¯¦éš›çš„æ•æ„Ÿè³‡è¨Šæ¨¡å¼ï¼ˆæ›´ç²¾ç¢ºçš„æ­£å‰‡è¡¨é”å¼ï¼‰
check_real_secrets() {
  local file=$1
  local has_secret=false
  
  # è·³éæ–‡æª”å’Œæ¸¬è©¦æª”æ¡ˆ
  if [[ "$file" == *.md ]] || [[ "$file" == *.txt ]] || [[ "$file" == *README* ]] || [[ "$file" == *.test.* ]] || [[ "$file" == *.spec.* ]]; then
    # åœ¨æ–‡æª”ä¸­ä»è¦æª¢æŸ¥å¯¦éš›çš„ key æ ¼å¼
    # OpenAI å¯¦éš› API key æ ¼å¼: sk-proj- å¾Œè·Ÿ48å€‹å­—ç¬¦
    if grep -qE 'sk-proj-[a-zA-Z0-9]{48}' "$file" 2>/dev/null; then
      echo "  âš ï¸  $file: ç™¼ç¾å¯èƒ½çš„ OpenAI API key (å¯¦éš›æ ¼å¼)" >> $TEMP_FILE
      has_secret=true
    fi
    # Supabase å¯¦éš› anon key æ ¼å¼: eyJ é–‹é ­çš„ JWT token (è‡³å°‘100å­—ç¬¦)
    if grep -qE 'eyJ[a-zA-Z0-9_-]{100,}\.[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+' "$file" 2>/dev/null; then
      echo "  âš ï¸  $file: ç™¼ç¾å¯èƒ½çš„ JWT token (å¯¦éš›æ ¼å¼)" >> $TEMP_FILE
      has_secret=true
    fi
  else
    # å°æ–¼ä»£ç¢¼æª”æ¡ˆï¼Œé€²è¡Œæ›´åš´æ ¼çš„æª¢æŸ¥
    
    # æª¢æŸ¥ç¡¬ç·¨ç¢¼çš„å¯¦éš› API keys (ä¸æ˜¯å¾ç’°å¢ƒè®Šæ•¸è®€å–çš„)
    # OpenAI API key
    if grep -E "OPENAI_API_KEY[\"']?\s*[:=]\s*[\"']sk-proj-[a-zA-Z0-9]{48}[\"']" "$file" 2>/dev/null | grep -v "os.getenv\|process.env\|import.meta.env" > /dev/null; then
      echo "  âš ï¸  $file: ç™¼ç¾ç¡¬ç·¨ç¢¼çš„ OpenAI API key" >> $TEMP_FILE
      has_secret=true
    fi
    
    # Supabase keys
    if grep -E "SUPABASE_.*KEY[\"']?\s*[:=]\s*[\"']eyJ[a-zA-Z0-9_-]{50,}" "$file" 2>/dev/null | grep -v "os.getenv\|process.env\|import.meta.env" > /dev/null; then
      echo "  âš ï¸  $file: ç™¼ç¾ç¡¬ç·¨ç¢¼çš„ Supabase key" >> $TEMP_FILE
      has_secret=true
    fi
    
    # Resend API key
    if grep -E "RESEND_API_KEY[\"']?\s*[:=]\s*[\"']re_[a-zA-Z0-9]{32,}[\"']" "$file" 2>/dev/null | grep -v "os.getenv\|process.env\|import.meta.env" > /dev/null; then
      echo "  âš ï¸  $file: ç™¼ç¾ç¡¬ç·¨ç¢¼çš„ Resend API key" >> $TEMP_FILE
      has_secret=true
    fi
    
    # ç›´æ¥è³¦å€¼çš„ API keys (ä¸å«ç¯„ä¾‹å€¼)
    if grep -E "api[_-]?key\s*[:=]\s*[\"'][a-zA-Z0-9]{32,}[\"']" "$file" 2>/dev/null | \
       grep -v "your-\|example\|test-\|demo-\|xxx\|placeholder\|<.*>" | \
       grep -v "os.getenv\|process.env\|import.meta.env" > /dev/null; then
      echo "  âš ï¸  $file: ç™¼ç¾å¯èƒ½ç¡¬ç·¨ç¢¼çš„ API key" >> $TEMP_FILE
      has_secret=true
    fi
    
    # ç§å¯† URL (å«æœ‰å¯¦éš›çš„æ†‘è­‰)
    if grep -E "https?://[^/]*:[^@]*@[^/]+" "$file" 2>/dev/null | \
       grep -v "username:password\|user:pass\|example.com" > /dev/null; then
      echo "  âš ï¸  $file: ç™¼ç¾å«æœ‰æ†‘è­‰çš„ URL" >> $TEMP_FILE
      has_secret=true
    fi
  fi
  
  if [ "$has_secret" = true ]; then
    HAS_REAL_SECRETS=true
  fi
}

# ç²å–æ‰€æœ‰æš«å­˜çš„æª”æ¡ˆï¼ˆæ’é™¤å·²åˆªé™¤çš„æª”æ¡ˆï¼‰
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# æª¢æŸ¥æ¯å€‹æª”æ¡ˆ
for file in $STAGED_FILES; do
  # è·³é .husky ç›®éŒ„æœ¬èº«
  if [[ "$file" == .husky/* ]]; then
    continue
  fi
  
  # è·³éä¸å­˜åœ¨çš„æª”æ¡ˆï¼ˆå·²åˆªé™¤ï¼‰
  if [ ! -f "$file" ]; then
    continue
  fi
  
  check_real_secrets "$file"
done

# æª¢æŸ¥æ˜¯å¦ç™¼ç¾çœŸå¯¦çš„æ•æ„Ÿè³‡è¨Š
if [ "$HAS_REAL_SECRETS" = true ]; then
  echo "âŒ éŒ¯èª¤ï¼šç™¼ç¾å¯èƒ½çš„æ•æ„Ÿè³‡è¨Šï¼š"
  cat $TEMP_FILE
  echo ""
  echo "è«‹æª¢æŸ¥ä»¥ä¸Šæª”æ¡ˆä¸¦ç§»é™¤æ•æ„Ÿè³‡è¨Šå¾Œå†æäº¤"
  echo "å¦‚æœé€™äº›æ˜¯ç¯„ä¾‹æˆ–æ–‡æª”ï¼Œè«‹ç¢ºèªå®ƒå€‘ä¸åŒ…å«å¯¦éš›çš„æ†‘è­‰"
  echo ""
  echo "æç¤ºï¼š"
  echo "  â€¢ ä½¿ç”¨ç’°å¢ƒè®Šæ•¸: process.env.API_KEY æˆ– os.getenv('API_KEY')"
  echo "  â€¢ æ–‡æª”ä¸­ä½¿ç”¨ä½”ä½ç¬¦: your-api-key-here, <YOUR_API_KEY>"
  echo "  â€¢ å¦‚ç¢ºå®šå®‰å…¨ï¼Œå¯ä½¿ç”¨ --no-verify è·³éæª¢æŸ¥"
  rm -f $TEMP_FILE
  exit 1
fi

# æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
rm -f $TEMP_FILE

echo "âœ… æ•æ„Ÿè³‡è¨Šæª¢æŸ¥é€šé"

# åŸ·è¡Œ TypeScript é¡å‹æª¢æŸ¥
echo "ğŸ“ åŸ·è¡Œ TypeScript æª¢æŸ¥..."
npm run typecheck || exit 1

echo "âœ… æ‰€æœ‰ pre-commit æª¢æŸ¥é€šé"