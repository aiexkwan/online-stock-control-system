# QC Label 打印功能可能的 Bug 及錯誤情況

## 資料輸入階段可能的問題

### 產品代碼相關錯誤
1. **產品代碼不存在**
   - 當用戶輸入的產品代碼在資料庫 `data_code` 表中找不到時。
   - 結果：顯示錯誤訊息 `Product Code {productCode} Not Found. Please Check Again.`

2. **產品代碼輸入後失去焦點但未能觸發查詢**
   - 如果 `handleProductCodeBlur` 函數未正確執行。
   - 結果：產品資訊（描述、標準數量、類型）不會被載入，可能影響後續操作。

3. **產品代碼大小寫敏感問題**
   - 目前使用 `ilike` 進行大小寫不敏感的查詢，如果此功能失效可能導致找不到產品。
   - 結果：即使產品代碼實際存在，也會顯示找不到。

### ACO 訂單相關錯誤
1. **ACO 訂單參考號不存在時的處理不當**
   - 當搜尋的 ACO 訂單參考號不存在時，系統應提示這是新訂單。
   - 可能的錯誤：未能正確設置 `acoNewRef` 狀態，導致界面未顯示新訂單輸入區域。

2. **ACO 訂單餘量計算錯誤**
   - 如果從 `record_aco` 表取得的 `remain_qty` 計算有誤，可能導致顯示錯誤的剩餘數量。
   - 可能的結果：用戶看到不正確的庫存信息，影響決策。

3. **ACO 訂單更新失敗**
   - 在 `proceedWithPrint` 函數中，更新 `record_aco` 表中的 `remain_qty` 可能失敗。
   - 結果：標籤會被打印，但資料庫中的庫存數量不會被更新，導致數據不一致。

### Slate 類型產品相關錯誤
1. **Slate 記錄插入失敗**
   - 在 `proceedWithPrint` 函數中，插入 `record_slate` 表的操作可能因數據格式或其他原因失敗。
   - 結果：棧板記錄可能已經創建，但相應的 Slate 詳情記錄未創建，導致數據不完整。

2. **Slate 字段類型轉換錯誤**
   - Slate 詳情中的數字字段（如 `weight`, `length`, `width` 等）需要用 `parseFloat` 轉換，如果轉換失敗可能導致插入錯誤。
   - 結果：數據庫操作可能失敗，顯示數據類型錯誤。

## 資料庫操作階段可能的問題

### 記錄插入錯誤
1. **棧板信息插入失敗**
   - `insertPalletInfoRecords` 函數可能因數據庫連接問題或數據驗證失敗而出錯。
   - 結果：整個流程被中斷，沒有標籤被生成。

2. **庫存記錄插入失敗**
   - 當嘗試在 `record_inventory` 表中插入新記錄時，可能因欄位類型不匹配或數據庫約束而失敗。
   - 結果：已創建棧板記錄，但庫存未更新，造成數據不一致。

3. **歷史記錄插入失敗**
   - `insertHistoryRecords` 函數可能因各種原因失敗，例如 `userId` 無法轉換為整數。
   - 結果：操作歷史未被記錄，難以追蹤和審計。

### 並發操作問題
1. **系列號或棧板號生成衝突**
   - 當多個用戶同時生成標籤時，`generateMultipleUniqueSeries` 或 `generatePalletNumbers` 可能生成重複的值。
   - 結果：插入操作可能因唯一約束違反而失敗。

2. **ACO 訂單更新競爭條件**
   - 當多個用戶同時更新同一個 ACO 訂單的 `remain_qty` 時，可能出現資料不一致。
   - 結果：最後一個更新會覆蓋之前的更新，可能導致不正確的庫存量。

## PDF 生成和打印階段可能的問題

1. **PDF 生成失敗**
   - `generateAndUploadPdf` 函數可能因網絡問題、PDF 庫錯誤或其他原因失敗。
   - 結果：資料庫記錄已創建，但沒有 PDF 被生成，用戶無法打印標籤。

2. **部分 PDF 生成成功但部分失敗**
   - 當產生多個標籤時，可能只有部分 PDF 生成成功。
   - 結果：只有部分標籤被打印，導致不完整的棧板標記。

3. **PDF 合併失敗**
   - `mergeAndPrintPdfs` 函數可能因 PDF 格式問題或 JS 內存限制而失敗。
   - 結果：單個 PDF 生成成功，但無法合併為一個文件進行打印。

4. **打印操作失敗**
   - 瀏覽器的打印功能可能因各種原因失敗，例如用戶取消、無打印機等。
   - 結果：PDF 已生成，但未被打印。

## 用戶交互階段可能的問題

1. **表單提交前驗證不完整**
   - 如果 `isFormValid` 邏輯有漏洞，可能允許不完整或無效的資料被提交。
   - 結果：資料庫可能接收到不一致或無效的資料。

2. **密碼確認對話框顯示問題**
   - `isPasswordConfirmOpen` 狀態可能未正確更新，導致密碼確認對話框不顯示或不隱藏。
   - 結果：用戶無法完成操作，或者操作被意外中斷。

3. **作廢棧板更正流程問題**
   - 從作廢頁面重定向到標籤打印頁面時，URL 參數如 `source_action`, `original_plt_num` 可能丟失或處理不當。
   - 結果：無法正確關聯新標籤與被作廢的棧板。

## 特殊情況處理可能的問題

1. **不同產品類型的特殊邏輯處理**
   - 不同產品類型（標準、ACO、Slate）有不同的處理邏輯，如果條件判斷有錯，可能應用錯誤的邏輯。
   - 結果：標籤內容錯誤，或資料庫記錄不正確。

2. **資料格式轉換錯誤**
   - 多處數值轉換（如 `parseInt`, `parseFloat`）可能因輸入格式不符合預期而失敗。
   - 結果：計算結果錯誤或資料庫操作失敗。

3. **錯誤報告機制失效**
   - `logErrorReport` 函數本身可能因為資料庫連接問題而失敗。
   - 結果：錯誤未被記錄到 `record_history` 表，難以診斷問題。

## 建議的測試情境

1. 輸入不存在的產品代碼，確認錯誤提示正確顯示。
2. 輸入存在的產品代碼但大小寫不同，確認能正確匹配。
3. 搜尋不存在的 ACO 訂單參考號，確認新訂單表單正確顯示。
4. 創建多個標籤（設置 count > 1），確認所有標籤都能正確生成和打印。
5. 測試作廢棧板更正流程，確認新標籤包含正確的作廢參考信息。
6. 同時從多個瀏覽器/裝置創建標籤，測試並發操作的穩定性。
7. 斷開網絡連接並嘗試生成標籤，測試錯誤處理機制。
8. 輸入各種邊界數值（非常大的數量、特殊字符等），測試數據驗證和轉換的穩健性。 

## 待解決問題與改進建議

### 並發操作問題改進
1. **系列號或棧板號生成的並發保護機制**
   - **問題說明**：現有的 `generateMultipleUniqueSeries` 和 `generatePalletNumbers` 函數在多用戶同時操作時可能存在競態條件。
   - **改進建議**：
     - 實現資料庫層面的序列生成（使用 PostgreSQL 的 `SEQUENCE` 對象）
     - 在查詢和更新之間使用事務和鎖定機制（如 `SELECT FOR UPDATE`）
     - 考慮使用 UUID 等全局唯一標識符替代基於計數器的序列

2. **ACO 訂單更新的競爭條件處理**
   - **問題說明**：在 `proceedWithPrint` 函數中，更新 ACO 訂單餘量時採用了「先查詢再更新」的模式，但沒有使用事務或鎖定機制。
   - **改進建議**：
     - 使用事務和鎖定（`SELECT ... FOR UPDATE`）確保數據一致性
     - 考慮在資料庫級別使用原子操作（如 `UPDATE record_aco SET remain_qty = remain_qty - :quantity WHERE uuid = :uuid`）
     - 實現樂觀鎖定機制，通過版本號或時間戳記檢測並發修改

### 資料格式強健性改進
1. **特殊字符和極端數值的完整驗證**
   - **問題說明**：表單驗證主要集中在必填項和基本類型檢查，但對用戶輸入的特殊字符、極端數值處理較少。
   - **改進建議**：
     - 對所有數值輸入增加最大值和最小值檢查
     - 對產品代碼和其他關鍵欄位使用正則表達式進行格式驗證
     - 限制文本欄位長度，並提供視覺化反饋
     - 對數值輸入增加預防性處理，如 `isNaN(parseFloat(value))` 檢查

### 網路中斷情況處理改進
1. **網路突然中斷時的完整錯誤處理和恢復機制**
   - **問題說明**：當標籤生成過程中網路中斷時，目前的錯誤處理主要依賴 Supabase 客戶端的錯誤回調，缺乏完整的狀態恢復和操作重試機制。
   - **改進建議**：
     - 實現操作日誌記錄，追蹤流程中的每個步驟狀態
     - 增加斷點恢復能力，允許從最後成功步驟繼續
     - 添加網路狀態監測，主動提醒用戶網路問題
     - 對關鍵操作實現幂等性設計，允許安全重試

### 密碼確認機制改進
1. **isPasswordConfirmOpen 狀態變化的處理**
   - **問題說明**：密碼確認對話框的狀態管理（`isPasswordConfirmOpen`）缺少對某些異常情況的處理，如提交後對話框未關閉、多次點擊引起的重複提交等。
   - **改進建議**：
     - 確保所有狀態轉變路徑都有正確處理（成功、失敗、取消等）
     - 添加超時處理，避免對話框無限等待
     - 實現防重複提交機制
     - 增加密碼驗證和後續操作之間的強關聯，確保一個完整的事務流程

### 系統資源限制考量
1. **大量標籤生成時的系統資源限制**
   - **問題說明**：當用戶嘗試生成大量標籤（設置很大的 count 值）時，系統可能面臨資源限制，如內存不足、請求超時等。
   - **改進建議**：
     - 實現批次大小限制，控制單次操作的最大標籤數量
     - 添加分批處理能力，將大批次分解為多個小批次串行處理
     - 增加進度顯示和取消機制，允許用戶中止長時間運行的操作
     - 對大型批次實現增量保存，確保部分完成的工作不會丟失
     - 考慮後台作業處理模式，允許用戶提交後離開頁面，稍後獲取結果 